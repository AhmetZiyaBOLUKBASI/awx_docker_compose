{"ast":null,"code":"import _objectSpread from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _toConsumableArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import{i18n}from\"@lingui/core\";import React,{useEffect,useCallback}from'react';import{useLocation}from'react-router-dom';import{SchedulesAPI}from'api';import useRequest,{useDeleteItems}from'hooks/useRequest';import useSelected from'hooks/useSelected';import{getQSConfig,parseQueryString}from'util/qs';import AlertModal from'../../AlertModal';import ErrorDetail from'../../ErrorDetail';import PaginatedTable,{HeaderRow,HeaderCell,ToolbarAddButton,ToolbarDeleteButton,getSearchableKeys}from'../../PaginatedTable';import DataListToolbar from'../../DataListToolbar';import ScheduleListItem from'./ScheduleListItem';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";var QS_CONFIG=getQSConfig('schedule',{page:1,page_size:20,order_by:'name'});function ScheduleList(_ref){var loadSchedules=_ref.loadSchedules,loadScheduleOptions=_ref.loadScheduleOptions,hideAddButton=_ref.hideAddButton,resource=_ref.resource,launchConfig=_ref.launchConfig,surveyConfig=_ref.surveyConfig;var location=useLocation();var _useRequest=useRequest(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _scheduleActions$data,_scheduleActions$data2;var params,_yield$Promise$all,_yield$Promise$all2,_yield$Promise$all2$,count,results,scheduleActions;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:params=parseQueryString(QS_CONFIG,location.search);_context.next=3;return Promise.all([loadSchedules(params),loadScheduleOptions()]);case 3:_yield$Promise$all=_context.sent;_yield$Promise$all2=_slicedToArray(_yield$Promise$all,2);_yield$Promise$all2$=_yield$Promise$all2[0].data;count=_yield$Promise$all2$.count;results=_yield$Promise$all2$.results;scheduleActions=_yield$Promise$all2[1];return _context.abrupt(\"return\",{schedules:results,itemCount:count,actions:scheduleActions.data.actions,relatedSearchableKeys:((scheduleActions===null||scheduleActions===void 0?void 0:(_scheduleActions$data=scheduleActions.data)===null||_scheduleActions$data===void 0?void 0:_scheduleActions$data.related_search_fields)||[]).map(function(val){return val.slice(0,-8);}),searchableKeys:getSearchableKeys((_scheduleActions$data2=scheduleActions.data.actions)===null||_scheduleActions$data2===void 0?void 0:_scheduleActions$data2.GET)});case 10:case\"end\":return _context.stop();}}},_callee);})),[location.search,loadSchedules,loadScheduleOptions]),{schedules:[],itemCount:0,actions:{},relatedSearchableKeys:[],searchableKeys:[]}),_useRequest$result=_useRequest.result,schedules=_useRequest$result.schedules,itemCount=_useRequest$result.itemCount,actions=_useRequest$result.actions,relatedSearchableKeys=_useRequest$result.relatedSearchableKeys,searchableKeys=_useRequest$result.searchableKeys,contentError=_useRequest.error,isLoading=_useRequest.isLoading,fetchSchedules=_useRequest.request;useEffect(function(){fetchSchedules();},[fetchSchedules]);var _useSelected=useSelected(schedules),selected=_useSelected.selected,isAllSelected=_useSelected.isAllSelected,handleSelect=_useSelected.handleSelect,selectAll=_useSelected.selectAll,clearSelected=_useSelected.clearSelected;var _useDeleteItems=useDeleteItems(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:return _context2.abrupt(\"return\",Promise.all(selected.map(function(_ref4){var id=_ref4.id;return SchedulesAPI.destroy(id);})));case 1:case\"end\":return _context2.stop();}}},_callee2);})),[selected]),{qsConfig:QS_CONFIG,allItemsSelected:isAllSelected,fetchItems:fetchSchedules}),isDeleteLoading=_useDeleteItems.isLoading,deleteJobs=_useDeleteItems.deleteItems,deletionError=_useDeleteItems.deletionError,clearDeletionError=_useDeleteItems.clearDeletionError;var handleDelete=/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return deleteJobs();case 2:clearSelected();case 3:case\"end\":return _context3.stop();}}},_callee3);}));return function handleDelete(){return _ref5.apply(this,arguments);};}();var canAdd=actions&&Object.prototype.hasOwnProperty.call(actions,'POST')&&!hideAddButton;var isTemplate=(resource===null||resource===void 0?void 0:resource.type)==='workflow_job_template'||(resource===null||resource===void 0?void 0:resource.type)==='job_template';var missingRequiredInventory=function missingRequiredInventory(schedule){var _schedule$summary_fie,_schedule$summary_fie2;if(!launchConfig.inventory_needed_to_start||schedule!==null&&schedule!==void 0&&(_schedule$summary_fie=schedule.summary_fields)!==null&&_schedule$summary_fie!==void 0&&(_schedule$summary_fie2=_schedule$summary_fie.inventory)!==null&&_schedule$summary_fie2!==void 0&&_schedule$summary_fie2.id){return null;}return(/*i18n*/i18n._(\"This schedule is missing an Inventory\"));};var hasMissingSurveyValue=function hasMissingSurveyValue(schedule){var missingValues;if(launchConfig.survey_enabled){surveyConfig.spec.forEach(function(question){var hasDefaultValue=Boolean(question.default);if(question.required&&!hasDefaultValue){var extraDataKeys=Object.keys(schedule===null||schedule===void 0?void 0:schedule.extra_data);var hasMatchingKey=extraDataKeys.includes(question.variable);Object.values(schedule===null||schedule===void 0?void 0:schedule.extra_data).forEach(function(value){if(!value||!hasMatchingKey){missingValues=true;}else{missingValues=false;}});if(!Object.values(schedule.extra_data).length){missingValues=true;}}});}return missingValues&&/*i18n*/i18n._(\"This schedule is missing required survey values\");};var emptyContentMessage=/*i18n*/i18n._(\"Please add a Schedule to populate this list.\");if(location.pathname.startsWith('/schedules')){emptyContentMessage=/*i18n*/i18n._(\"Please add a Schedule to populate this list.  Schedules can be added to a Template, Project, or Inventory Source.\");}return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(PaginatedTable,{contentError:contentError,hasContentLoading:isLoading||isDeleteLoading,items:schedules,itemCount:itemCount,qsConfig:QS_CONFIG,pluralizedItemName:/*i18n*/i18n._(\"Schedules\"),emptyContentMessage:emptyContentMessage,onRowClick:handleSelect,headerRow:/*#__PURE__*/_jsxs(HeaderRow,{qsConfig:QS_CONFIG,children:[/*#__PURE__*/_jsx(HeaderCell,{sortKey:\"name\",children:/*i18n*/i18n._(\"Name\")}),/*#__PURE__*/_jsx(HeaderCell,{sortKey:\"unified_job_template\",children:/*i18n*/i18n._(\"Related resource\")}),/*#__PURE__*/_jsx(HeaderCell,{sortKey:\"unified_job_template__polymorphic_ctype__model\",children:/*i18n*/i18n._(\"Resource type\")}),/*#__PURE__*/_jsx(HeaderCell,{sortKey:\"next_run\",children:/*i18n*/i18n._(\"Next Run\")}),/*#__PURE__*/_jsx(HeaderCell,{children:/*i18n*/i18n._(\"Actions\")})]}),renderRow:function renderRow(item,index){return/*#__PURE__*/_jsx(ScheduleListItem,{isSelected:selected.some(function(row){return row.id===item.id;}),onSelect:function onSelect(){return handleSelect(item);},schedule:item,rowIndex:index,isMissingInventory:isTemplate&&missingRequiredInventory(item),isMissingSurvey:isTemplate&&hasMissingSurveyValue(item)},item.id);},clearSelected:clearSelected,toolbarSearchColumns:[{name:/*i18n*/i18n._(\"Name\"),key:'name__icontains',isDefault:true},{name:/*i18n*/i18n._(\"Description\"),key:'description__icontains'},{name:/*i18n*/i18n._(\"Created By (Username)\"),key:'created_by__username__icontains'},{name:/*i18n*/i18n._(\"Modified By (Username)\"),key:'modified_by__username__icontains'}],toolbarSearchableKeys:searchableKeys,toolbarRelatedSearchableKeys:relatedSearchableKeys,renderToolbar:function renderToolbar(props){return/*#__PURE__*/_jsx(DataListToolbar,_objectSpread(_objectSpread({},props),{},{isAllSelected:isAllSelected,onSelectAll:selectAll,qsConfig:QS_CONFIG,additionalControls:[].concat(_toConsumableArray(canAdd?[/*#__PURE__*/_jsx(ToolbarAddButton,{ouiaId:\"add-schedule-button\",linkTo:\"\".concat(location.pathname,\"/add\")},\"add\")]:[]),[/*#__PURE__*/_jsx(ToolbarDeleteButton,{ouiaId:\"delete-schedule-button\",onDelete:handleDelete,itemsToDelete:selected,pluralizedItemName:/*i18n*/i18n._(\"Schedules\")},\"delete\")])}));}}),deletionError&&/*#__PURE__*/_jsxs(AlertModal,{isOpen:deletionError,variant:\"danger\",title:/*i18n*/i18n._(\"Error!\"),onClose:clearDeletionError,children:[/*i18n*/i18n._(\"Failed to delete one or more schedules.\"),/*#__PURE__*/_jsx(ErrorDetail,{error:deletionError})]})]});}ScheduleList.defaultProps={hideAddButton:false};export default ScheduleList;","map":{"version":3,"sources":["/awx_devel/awx/ui/src/components/Schedule/ScheduleList/ScheduleList.js"],"names":["React","useEffect","useCallback","useLocation","SchedulesAPI","useRequest","useDeleteItems","useSelected","getQSConfig","parseQueryString","AlertModal","ErrorDetail","PaginatedTable","HeaderRow","HeaderCell","ToolbarAddButton","ToolbarDeleteButton","getSearchableKeys","DataListToolbar","ScheduleListItem","QS_CONFIG","page","page_size","order_by","ScheduleList","loadSchedules","loadScheduleOptions","hideAddButton","resource","launchConfig","surveyConfig","location","params","search","Promise","all","data","count","results","scheduleActions","schedules","itemCount","actions","relatedSearchableKeys","related_search_fields","map","val","slice","searchableKeys","GET","result","contentError","error","isLoading","fetchSchedules","request","selected","isAllSelected","handleSelect","selectAll","clearSelected","id","destroy","qsConfig","allItemsSelected","fetchItems","isDeleteLoading","deleteJobs","deleteItems","deletionError","clearDeletionError","handleDelete","canAdd","Object","prototype","hasOwnProperty","call","isTemplate","type","missingRequiredInventory","schedule","inventory_needed_to_start","summary_fields","inventory","hasMissingSurveyValue","missingValues","survey_enabled","spec","forEach","question","hasDefaultValue","Boolean","default","required","extraDataKeys","keys","extra_data","hasMatchingKey","includes","variable","values","value","length","emptyContentMessage","pathname","startsWith","item","index","some","row","name","key","isDefault","props","defaultProps"],"mappings":"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","sourcesContent":["import React, { useEffect, useCallback } from 'react';\nimport { useLocation } from 'react-router-dom';\nimport { bool, func } from 'prop-types';\n\nimport { t } from '@lingui/macro';\nimport { SchedulesAPI } from 'api';\nimport useRequest, { useDeleteItems } from 'hooks/useRequest';\nimport useSelected from 'hooks/useSelected';\nimport { getQSConfig, parseQueryString } from 'util/qs';\nimport AlertModal from '../../AlertModal';\nimport ErrorDetail from '../../ErrorDetail';\nimport PaginatedTable, {\n  HeaderRow,\n  HeaderCell,\n  ToolbarAddButton,\n  ToolbarDeleteButton,\n  getSearchableKeys,\n} from '../../PaginatedTable';\nimport DataListToolbar from '../../DataListToolbar';\nimport ScheduleListItem from './ScheduleListItem';\n\nconst QS_CONFIG = getQSConfig('schedule', {\n  page: 1,\n  page_size: 20,\n  order_by: 'name',\n});\n\nfunction ScheduleList({\n  loadSchedules,\n  loadScheduleOptions,\n  hideAddButton,\n  resource,\n  launchConfig,\n  surveyConfig,\n}) {\n  const location = useLocation();\n\n  const {\n    result: {\n      schedules,\n      itemCount,\n      actions,\n      relatedSearchableKeys,\n      searchableKeys,\n    },\n    error: contentError,\n    isLoading,\n    request: fetchSchedules,\n  } = useRequest(\n    useCallback(async () => {\n      const params = parseQueryString(QS_CONFIG, location.search);\n      const [\n        {\n          data: { count, results },\n        },\n        scheduleActions,\n      ] = await Promise.all([loadSchedules(params), loadScheduleOptions()]);\n      return {\n        schedules: results,\n        itemCount: count,\n        actions: scheduleActions.data.actions,\n        relatedSearchableKeys: (\n          scheduleActions?.data?.related_search_fields || []\n        ).map((val) => val.slice(0, -8)),\n        searchableKeys: getSearchableKeys(scheduleActions.data.actions?.GET),\n      };\n    }, [location.search, loadSchedules, loadScheduleOptions]),\n    {\n      schedules: [],\n      itemCount: 0,\n      actions: {},\n      relatedSearchableKeys: [],\n      searchableKeys: [],\n    }\n  );\n\n  useEffect(() => {\n    fetchSchedules();\n  }, [fetchSchedules]);\n\n  const { selected, isAllSelected, handleSelect, selectAll, clearSelected } =\n    useSelected(schedules);\n\n  const {\n    isLoading: isDeleteLoading,\n    deleteItems: deleteJobs,\n    deletionError,\n    clearDeletionError,\n  } = useDeleteItems(\n    useCallback(\n      async () =>\n        Promise.all(selected.map(({ id }) => SchedulesAPI.destroy(id))),\n      [selected]\n    ),\n    {\n      qsConfig: QS_CONFIG,\n      allItemsSelected: isAllSelected,\n      fetchItems: fetchSchedules,\n    }\n  );\n\n  const handleDelete = async () => {\n    await deleteJobs();\n    clearSelected();\n  };\n\n  const canAdd =\n    actions &&\n    Object.prototype.hasOwnProperty.call(actions, 'POST') &&\n    !hideAddButton;\n  const isTemplate =\n    resource?.type === 'workflow_job_template' ||\n    resource?.type === 'job_template';\n\n  const missingRequiredInventory = (schedule) => {\n    if (\n      !launchConfig.inventory_needed_to_start ||\n      schedule?.summary_fields?.inventory?.id\n    ) {\n      return null;\n    }\n    return t`This schedule is missing an Inventory`;\n  };\n\n  const hasMissingSurveyValue = (schedule) => {\n    let missingValues;\n    if (launchConfig.survey_enabled) {\n      surveyConfig.spec.forEach((question) => {\n        const hasDefaultValue = Boolean(question.default);\n        if (question.required && !hasDefaultValue) {\n          const extraDataKeys = Object.keys(schedule?.extra_data);\n\n          const hasMatchingKey = extraDataKeys.includes(question.variable);\n          Object.values(schedule?.extra_data).forEach((value) => {\n            if (!value || !hasMatchingKey) {\n              missingValues = true;\n            } else {\n              missingValues = false;\n            }\n          });\n          if (!Object.values(schedule.extra_data).length) {\n            missingValues = true;\n          }\n        }\n      });\n    }\n    return missingValues && t`This schedule is missing required survey values`;\n  };\n  let emptyContentMessage = t`Please add a Schedule to populate this list.`;\n\n  if (location.pathname.startsWith('/schedules')) {\n    emptyContentMessage = t`Please add a Schedule to populate this list.  Schedules can be added to a Template, Project, or Inventory Source.`;\n  }\n\n  return (\n    <>\n      <PaginatedTable\n        contentError={contentError}\n        hasContentLoading={isLoading || isDeleteLoading}\n        items={schedules}\n        itemCount={itemCount}\n        qsConfig={QS_CONFIG}\n        pluralizedItemName={t`Schedules`}\n        emptyContentMessage={emptyContentMessage}\n        onRowClick={handleSelect}\n        headerRow={\n          <HeaderRow qsConfig={QS_CONFIG}>\n            <HeaderCell sortKey=\"name\">{t`Name`}</HeaderCell>\n            <HeaderCell sortKey=\"unified_job_template\">{t`Related resource`}</HeaderCell>\n            <HeaderCell sortKey=\"unified_job_template__polymorphic_ctype__model\">{t`Resource type`}</HeaderCell>\n            <HeaderCell sortKey=\"next_run\">{t`Next Run`}</HeaderCell>\n            <HeaderCell>{t`Actions`}</HeaderCell>\n          </HeaderRow>\n        }\n        renderRow={(item, index) => (\n          <ScheduleListItem\n            isSelected={selected.some((row) => row.id === item.id)}\n            key={item.id}\n            onSelect={() => handleSelect(item)}\n            schedule={item}\n            rowIndex={index}\n            isMissingInventory={isTemplate && missingRequiredInventory(item)}\n            isMissingSurvey={isTemplate && hasMissingSurveyValue(item)}\n          />\n        )}\n        clearSelected={clearSelected}\n        toolbarSearchColumns={[\n          {\n            name: t`Name`,\n            key: 'name__icontains',\n            isDefault: true,\n          },\n          {\n            name: t`Description`,\n            key: 'description__icontains',\n          },\n          {\n            name: t`Created By (Username)`,\n            key: 'created_by__username__icontains',\n          },\n          {\n            name: t`Modified By (Username)`,\n            key: 'modified_by__username__icontains',\n          },\n        ]}\n        toolbarSearchableKeys={searchableKeys}\n        toolbarRelatedSearchableKeys={relatedSearchableKeys}\n        renderToolbar={(props) => (\n          <DataListToolbar\n            {...props}\n            isAllSelected={isAllSelected}\n            onSelectAll={selectAll}\n            qsConfig={QS_CONFIG}\n            additionalControls={[\n              ...(canAdd\n                ? [\n                    <ToolbarAddButton\n                      ouiaId=\"add-schedule-button\"\n                      key=\"add\"\n                      linkTo={`${location.pathname}/add`}\n                    />,\n                  ]\n                : []),\n              <ToolbarDeleteButton\n                ouiaId=\"delete-schedule-button\"\n                key=\"delete\"\n                onDelete={handleDelete}\n                itemsToDelete={selected}\n                pluralizedItemName={t`Schedules`}\n              />,\n            ]}\n          />\n        )}\n      />\n      {deletionError && (\n        <AlertModal\n          isOpen={deletionError}\n          variant=\"danger\"\n          title={t`Error!`}\n          onClose={clearDeletionError}\n        >\n          {t`Failed to delete one or more schedules.`}\n          <ErrorDetail error={deletionError} />\n        </AlertModal>\n      )}\n    </>\n  );\n}\n\nScheduleList.propTypes = {\n  hideAddButton: bool,\n  loadSchedules: func.isRequired,\n  loadScheduleOptions: func.isRequired,\n};\nScheduleList.defaultProps = {\n  hideAddButton: false,\n};\n\nexport default ScheduleList;\n"]},"metadata":{},"sourceType":"module"}