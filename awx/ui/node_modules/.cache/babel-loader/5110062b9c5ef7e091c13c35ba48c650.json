{"ast":null,"code":"import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _taggedTemplateLiteral from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/taggedTemplateLiteral.js\";var _templateObject;import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import{i18n}from\"@lingui/core\";/* eslint-disable react/jsx-no-useless-fragment */import React,{useCallback,useEffect,useRef}from'react';import{Redirect,withRouter}from'react-router-dom';import{Formik}from'formik';import styled from'styled-components';import DOMPurify from'dompurify';import{Alert,Brand,LoginMainFooterLinksItem,LoginForm,Login as PFLogin,LoginHeader,LoginFooter,LoginMainHeader,LoginMainBody,LoginMainFooter,Tooltip}from'@patternfly/react-core';import{AzureIcon,GoogleIcon,GithubIcon,UserCircleIcon}from'@patternfly/react-icons';import useRequest,{useDismissableError}from'hooks/useRequest';import{AuthAPI,RootAPI}from'api';import AlertModal from'components/AlertModal';import ErrorDetail from'components/ErrorDetail';import{useSession}from'contexts/Session';import{getCurrentUserId}from'util/auth';import{SESSION_REDIRECT_URL,SESSION_USER_ID}from'../../constants';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";var loginLogoSrc='static/media/logo-login.svg';var Login=styled(PFLogin)(_templateObject||(_templateObject=_taggedTemplateLiteral([\"\\n  & .pf-c-brand {\\n    max-height: 285px;\\n  }\\n\"])));function AWXLogin(_ref){var _authError$response;var alt=_ref.alt,isAuthenticated=_ref.isAuthenticated;var _useSession=useSession(),authRedirectTo=_useSession.authRedirectTo,isSessionExpired=_useSession.isSessionExpired,setAuthRedirectTo=_useSession.setAuthRedirectTo;var isNewUser=useRef(true);var hasVerifiedUser=useRef(false);var _useRequest=useRequest(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _yield$Promise$all,_yield$Promise$all2,_yield$Promise$all2$,custom_logo,custom_login_info,BRAND_NAME,authData,logoSrc;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return Promise.all([RootAPI.read(),RootAPI.readAssetVariables(),AuthAPI.read()]);case 2:_yield$Promise$all=_context.sent;_yield$Promise$all2=_slicedToArray(_yield$Promise$all,3);_yield$Promise$all2$=_yield$Promise$all2[0].data;custom_logo=_yield$Promise$all2$.custom_logo;custom_login_info=_yield$Promise$all2$.custom_login_info;BRAND_NAME=_yield$Promise$all2[1].data.BRAND_NAME;authData=_yield$Promise$all2[2].data;logoSrc=custom_logo?\"data:image/jpeg;\".concat(custom_logo):loginLogoSrc;return _context.abrupt(\"return\",{brandName:BRAND_NAME,logo:logoSrc,loginInfo:custom_login_info,socialAuthOptions:authData});case 11:case\"end\":return _context.stop();}}},_callee);})),[]),{brandName:null,logo:loginLogoSrc,loginInfo:null,socialAuthOptions:{}}),isCustomLoginInfoLoading=_useRequest.isLoading,customLoginInfoError=_useRequest.error,fetchCustomLoginInfo=_useRequest.request,_useRequest$result=_useRequest.result,brandName=_useRequest$result.brandName,logo=_useRequest$result.logo,loginInfo=_useRequest$result.loginInfo,socialAuthOptions=_useRequest$result.socialAuthOptions;var _useDismissableError=useDismissableError(customLoginInfoError),loginInfoError=_useDismissableError.error,dismissLoginInfoError=_useDismissableError.dismissError;useEffect(function(){fetchCustomLoginInfo();},[fetchCustomLoginInfo]);var _useRequest2=useRequest(useCallback(/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(_ref3){var username,password;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:username=_ref3.username,password=_ref3.password;_context2.next=3;return RootAPI.login(username,password);case 3:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x){return _ref4.apply(this,arguments);};}(),[])),isAuthenticating=_useRequest2.isLoading,authenticationError=_useRequest2.error,authenticate=_useRequest2.request;var _useDismissableError2=useDismissableError(authenticationError),authError=_useDismissableError2.error,dismissAuthError=_useDismissableError2.dismissError;var handleSubmit=/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(values){return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:dismissAuthError();_context3.next=3;return authenticate(values);case 3:setAuthRedirectTo('/home');case 4:case\"end\":return _context3.stop();}}},_callee3);}));return function handleSubmit(_x2){return _ref5.apply(this,arguments);};}();if(isCustomLoginInfoLoading){return null;}if(isAuthenticated(document.cookie)&&!hasVerifiedUser.current){var currentUserId=getCurrentUserId(document.cookie);var verifyIsNewUser=function verifyIsNewUser(){var previousUserId=JSON.parse(window.localStorage.getItem(SESSION_USER_ID));if(previousUserId===null){return true;}return currentUserId.toString()!==previousUserId.toString();};isNewUser.current=verifyIsNewUser();hasVerifiedUser.current=true;window.localStorage.setItem(SESSION_USER_ID,JSON.stringify(currentUserId));}if(isAuthenticated(document.cookie)&&hasVerifiedUser.current){var redirect=isNewUser.current?'/':authRedirectTo;return/*#__PURE__*/_jsx(Redirect,{to:redirect});}var helperText;if((authError===null||authError===void 0?void 0:(_authError$response=authError.response)===null||_authError$response===void 0?void 0:_authError$response.status)===401){helperText=/*i18n*/i18n._(\"Invalid username or password. Please try again.\");}else{helperText=/*i18n*/i18n._(\"There was a problem logging in. Please try again.\");}var HeaderBrand=/*#__PURE__*/_jsx(Brand,{\"data-cy\":\"brand-logo\",src:logo,alt:alt||brandName});var Header=/*#__PURE__*/_jsx(LoginHeader,{headerBrand:HeaderBrand});var Footer=/*#__PURE__*/_jsx(LoginFooter,{\"data-cy\":\"login-footer\",dangerouslySetInnerHTML:{__html:DOMPurify.sanitize(loginInfo)}});var setSessionRedirect=function setSessionRedirect(){window.sessionStorage.setItem(SESSION_REDIRECT_URL,authRedirectTo);};return/*#__PURE__*/_jsxs(Login,{header:Header,footer:Footer,children:[/*#__PURE__*/_jsx(LoginMainHeader,{\"data-cy\":\"login-header\",title:brandName?/*i18n*/i18n._(\"Welcome to {brandName}!\",{brandName:brandName}):'',subtitle:/*i18n*/i18n._(\"Please log in\")}),/*#__PURE__*/_jsxs(LoginMainBody,{children:[isSessionExpired.current?/*#__PURE__*/_jsx(Alert,{variant:\"warning\",isInline:true,title:/*i18n*/i18n._(\"Your session has expired. Please log in to continue where you left off.\"),ouiaId:\"session-expired-warning-alert\"}):null,/*#__PURE__*/_jsx(Formik,{initialValues:{password:'',username:''},onSubmit:handleSubmit,children:function children(formik){return/*#__PURE__*/_jsx(LoginForm,{\"data-cy\":\"login-form\",className:authError?'pf-m-error':'',helperText:helperText,isLoginButtonDisabled:isAuthenticating,isValidPassword:!authError,isValidUsername:!authError,loginButtonLabel:/*i18n*/i18n._(\"Log In\"),onChangePassword:function onChangePassword(val){formik.setFieldValue('password',val);dismissAuthError();},onChangeUsername:function onChangeUsername(val){formik.setFieldValue('username',val);dismissAuthError();},onLoginButtonClick:formik.handleSubmit,passwordLabel:/*i18n*/i18n._(\"Password\"),passwordValue:formik.values.password,showHelperText:authError,usernameLabel:/*i18n*/i18n._(\"Username\"),usernameValue:formik.values.username});}}),loginInfoError&&/*#__PURE__*/_jsxs(AlertModal,{isOpen:loginInfoError,variant:\"error\",title:/*i18n*/i18n._(\"Error!\"),onClose:dismissLoginInfoError,\"data-cy\":\"login-info-error\",children:[/*i18n*/i18n._(\"Failed to fetch custom login configuration settings.  System defaults will be shown instead.\"),/*#__PURE__*/_jsx(ErrorDetail,{error:loginInfoError})]})]}),/*#__PURE__*/_jsx(LoginMainFooter,{socialMediaLoginContent:/*#__PURE__*/_jsx(_Fragment,{children:socialAuthOptions&&Object.keys(socialAuthOptions).map(function(authKey){var loginUrl=socialAuthOptions[authKey].login_url;if(authKey==='azuread-oauth2'){return/*#__PURE__*/_jsx(LoginMainFooterLinksItem,{\"data-cy\":\"social-auth-azure\",href:loginUrl,onClick:setSessionRedirect,children:/*#__PURE__*/_jsx(Tooltip,{content:/*i18n*/i18n._(\"Sign in with Azure AD\"),children:/*#__PURE__*/_jsx(AzureIcon,{size:\"lg\"})})},authKey);}if(authKey==='github'){return/*#__PURE__*/_jsx(LoginMainFooterLinksItem,{\"data-cy\":\"social-auth-github\",href:loginUrl,onClick:setSessionRedirect,children:/*#__PURE__*/_jsx(Tooltip,{content:/*i18n*/i18n._(\"Sign in with GitHub\"),children:/*#__PURE__*/_jsx(GithubIcon,{size:\"lg\"})})},authKey);}if(authKey==='github-org'){return/*#__PURE__*/_jsx(LoginMainFooterLinksItem,{\"data-cy\":\"social-auth-github-org\",href:loginUrl,onClick:setSessionRedirect,children:/*#__PURE__*/_jsx(Tooltip,{content:/*i18n*/i18n._(\"Sign in with GitHub Organizations\"),children:/*#__PURE__*/_jsx(GithubIcon,{size:\"lg\"})})},authKey);}if(authKey==='github-team'){return/*#__PURE__*/_jsx(LoginMainFooterLinksItem,{\"data-cy\":\"social-auth-github-team\",href:loginUrl,onClick:setSessionRedirect,children:/*#__PURE__*/_jsx(Tooltip,{content:/*i18n*/i18n._(\"Sign in with GitHub Teams\"),children:/*#__PURE__*/_jsx(GithubIcon,{size:\"lg\"})})},authKey);}if(authKey==='github-enterprise'){return/*#__PURE__*/_jsx(LoginMainFooterLinksItem,{\"data-cy\":\"social-auth-github-enterprise\",href:loginUrl,onClick:setSessionRedirect,children:/*#__PURE__*/_jsx(Tooltip,{content:/*i18n*/i18n._(\"Sign in with GitHub Enterprise\"),children:/*#__PURE__*/_jsx(GithubIcon,{size:\"lg\"})})},authKey);}if(authKey==='github-enterprise-org'){return/*#__PURE__*/_jsx(LoginMainFooterLinksItem,{\"data-cy\":\"social-auth-github-enterprise-org\",href:loginUrl,onClick:setSessionRedirect,children:/*#__PURE__*/_jsx(Tooltip,{content:/*i18n*/i18n._(\"Sign in with GitHub Enterprise Organizations\"),children:/*#__PURE__*/_jsx(GithubIcon,{size:\"lg\"})})},authKey);}if(authKey==='github-enterprise-team'){return/*#__PURE__*/_jsx(LoginMainFooterLinksItem,{\"data-cy\":\"social-auth-github-enterprise-team\",href:loginUrl,onClick:setSessionRedirect,children:/*#__PURE__*/_jsx(Tooltip,{content:/*i18n*/i18n._(\"Sign in with GitHub Enterprise Teams\"),children:/*#__PURE__*/_jsx(GithubIcon,{size:\"lg\"})})},authKey);}if(authKey==='google-oauth2'){return/*#__PURE__*/_jsx(LoginMainFooterLinksItem,{\"data-cy\":\"social-auth-google\",href:loginUrl,onClick:setSessionRedirect,children:/*#__PURE__*/_jsx(Tooltip,{content:/*i18n*/i18n._(\"Sign in with Google\"),children:/*#__PURE__*/_jsx(GoogleIcon,{size:\"lg\"})})},authKey);}if(authKey==='oidc'){return/*#__PURE__*/_jsx(LoginMainFooterLinksItem,{\"data-cy\":\"social-auth-oidc\",href:loginUrl,onClick:setSessionRedirect,children:/*#__PURE__*/_jsx(Tooltip,{content:/*i18n*/i18n._(\"Sign in with OIDC\"),children:/*#__PURE__*/_jsx(UserCircleIcon,{size:\"lg\"})})},authKey);}if(authKey.startsWith('saml')){var samlIDP=authKey.split(':')[1]||null;return/*#__PURE__*/_jsx(LoginMainFooterLinksItem,{\"data-cy\":\"social-auth-saml\",href:loginUrl,onClick:setSessionRedirect,children:/*#__PURE__*/_jsx(Tooltip,{content:samlIDP?/*i18n*/i18n._(\"Sign in with SAML {samlIDP}\",{samlIDP:samlIDP}):/*i18n*/i18n._(\"Sign in with SAML\"),children:/*#__PURE__*/_jsx(UserCircleIcon,{size:\"lg\"})})},authKey);}return null;})})})]});}export default withRouter(AWXLogin);export{AWXLogin as _AWXLogin};","map":{"version":3,"sources":["/awx_devel/awx/ui/src/screens/Login/Login.js"],"names":["React","useCallback","useEffect","useRef","Redirect","withRouter","Formik","styled","DOMPurify","Alert","Brand","LoginMainFooterLinksItem","LoginForm","Login","PFLogin","LoginHeader","LoginFooter","LoginMainHeader","LoginMainBody","LoginMainFooter","Tooltip","AzureIcon","GoogleIcon","GithubIcon","UserCircleIcon","useRequest","useDismissableError","AuthAPI","RootAPI","AlertModal","ErrorDetail","useSession","getCurrentUserId","SESSION_REDIRECT_URL","SESSION_USER_ID","loginLogoSrc","AWXLogin","alt","isAuthenticated","authRedirectTo","isSessionExpired","setAuthRedirectTo","isNewUser","hasVerifiedUser","Promise","all","read","readAssetVariables","data","custom_logo","custom_login_info","BRAND_NAME","authData","logoSrc","brandName","logo","loginInfo","socialAuthOptions","isCustomLoginInfoLoading","isLoading","customLoginInfoError","error","fetchCustomLoginInfo","request","result","loginInfoError","dismissLoginInfoError","dismissError","username","password","login","isAuthenticating","authenticationError","authenticate","authError","dismissAuthError","handleSubmit","values","document","cookie","current","currentUserId","verifyIsNewUser","previousUserId","JSON","parse","window","localStorage","getItem","toString","setItem","stringify","redirect","helperText","response","status","HeaderBrand","Header","Footer","__html","sanitize","setSessionRedirect","sessionStorage","formik","val","setFieldValue","Object","keys","map","authKey","loginUrl","login_url","startsWith","samlIDP","split","_AWXLogin"],"mappings":"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","sourcesContent":["/* eslint-disable react/jsx-no-useless-fragment */\nimport React, { useCallback, useEffect, useRef } from 'react';\nimport { Redirect, withRouter } from 'react-router-dom';\n\nimport { t } from '@lingui/macro';\nimport { Formik } from 'formik';\nimport styled from 'styled-components';\nimport DOMPurify from 'dompurify';\n\nimport {\n  Alert,\n  Brand,\n  LoginMainFooterLinksItem,\n  LoginForm,\n  Login as PFLogin,\n  LoginHeader,\n  LoginFooter,\n  LoginMainHeader,\n  LoginMainBody,\n  LoginMainFooter,\n  Tooltip,\n} from '@patternfly/react-core';\n\nimport {\n  AzureIcon,\n  GoogleIcon,\n  GithubIcon,\n  UserCircleIcon,\n} from '@patternfly/react-icons';\nimport useRequest, { useDismissableError } from 'hooks/useRequest';\nimport { AuthAPI, RootAPI } from 'api';\nimport AlertModal from 'components/AlertModal';\nimport ErrorDetail from 'components/ErrorDetail';\nimport { useSession } from 'contexts/Session';\nimport { getCurrentUserId } from 'util/auth';\nimport { SESSION_REDIRECT_URL, SESSION_USER_ID } from '../../constants';\n\nconst loginLogoSrc = 'static/media/logo-login.svg';\n\nconst Login = styled(PFLogin)`\n  & .pf-c-brand {\n    max-height: 285px;\n  }\n`;\n\nfunction AWXLogin({ alt, isAuthenticated }) {\n  const { authRedirectTo, isSessionExpired, setAuthRedirectTo } = useSession();\n  const isNewUser = useRef(true);\n  const hasVerifiedUser = useRef(false);\n\n  const {\n    isLoading: isCustomLoginInfoLoading,\n    error: customLoginInfoError,\n    request: fetchCustomLoginInfo,\n    result: { brandName, logo, loginInfo, socialAuthOptions },\n  } = useRequest(\n    useCallback(async () => {\n      const [\n        {\n          data: { custom_logo, custom_login_info },\n        },\n        {\n          data: { BRAND_NAME },\n        },\n        { data: authData },\n      ] = await Promise.all([\n        RootAPI.read(),\n        RootAPI.readAssetVariables(),\n        AuthAPI.read(),\n      ]);\n      const logoSrc = custom_logo\n        ? `data:image/jpeg;${custom_logo}`\n        : loginLogoSrc;\n\n      return {\n        brandName: BRAND_NAME,\n        logo: logoSrc,\n        loginInfo: custom_login_info,\n        socialAuthOptions: authData,\n      };\n    }, []),\n    {\n      brandName: null,\n      logo: loginLogoSrc,\n      loginInfo: null,\n      socialAuthOptions: {},\n    }\n  );\n\n  const { error: loginInfoError, dismissError: dismissLoginInfoError } =\n    useDismissableError(customLoginInfoError);\n\n  useEffect(() => {\n    fetchCustomLoginInfo();\n  }, [fetchCustomLoginInfo]);\n\n  const {\n    isLoading: isAuthenticating,\n    error: authenticationError,\n    request: authenticate,\n  } = useRequest(\n    useCallback(async ({ username, password }) => {\n      await RootAPI.login(username, password);\n    }, [])\n  );\n\n  const { error: authError, dismissError: dismissAuthError } =\n    useDismissableError(authenticationError);\n\n  const handleSubmit = async (values) => {\n    dismissAuthError();\n    await authenticate(values);\n    setAuthRedirectTo('/home');\n  };\n\n  if (isCustomLoginInfoLoading) {\n    return null;\n  }\n\n  if (isAuthenticated(document.cookie) && !hasVerifiedUser.current) {\n    const currentUserId = getCurrentUserId(document.cookie);\n    const verifyIsNewUser = () => {\n      const previousUserId = JSON.parse(\n        window.localStorage.getItem(SESSION_USER_ID)\n      );\n      if (previousUserId === null) {\n        return true;\n      }\n      return currentUserId.toString() !== previousUserId.toString();\n    };\n    isNewUser.current = verifyIsNewUser();\n    hasVerifiedUser.current = true;\n    window.localStorage.setItem(SESSION_USER_ID, JSON.stringify(currentUserId));\n  }\n\n  if (isAuthenticated(document.cookie) && hasVerifiedUser.current) {\n    const redirect = isNewUser.current ? '/' : authRedirectTo;\n    return <Redirect to={redirect} />;\n  }\n\n  let helperText;\n  if (authError?.response?.status === 401) {\n    helperText = t`Invalid username or password. Please try again.`;\n  } else {\n    helperText = t`There was a problem logging in. Please try again.`;\n  }\n\n  const HeaderBrand = (\n    <Brand data-cy=\"brand-logo\" src={logo} alt={alt || brandName} />\n  );\n  const Header = <LoginHeader headerBrand={HeaderBrand} />;\n  const Footer = (\n    <LoginFooter\n      data-cy=\"login-footer\"\n      dangerouslySetInnerHTML={{\n        __html: DOMPurify.sanitize(loginInfo),\n      }}\n    />\n  );\n\n  const setSessionRedirect = () => {\n    window.sessionStorage.setItem(SESSION_REDIRECT_URL, authRedirectTo);\n  };\n\n  return (\n    <Login header={Header} footer={Footer}>\n      <LoginMainHeader\n        data-cy=\"login-header\"\n        title={brandName ? t`Welcome to ${brandName}!` : ''}\n        subtitle={t`Please log in`}\n      />\n      <LoginMainBody>\n        {isSessionExpired.current ? (\n          <Alert\n            variant=\"warning\"\n            isInline\n            title={t`Your session has expired. Please log in to continue where you left off.`}\n            ouiaId=\"session-expired-warning-alert\"\n          />\n        ) : null}\n        <Formik\n          initialValues={{\n            password: '',\n            username: '',\n          }}\n          onSubmit={handleSubmit}\n        >\n          {(formik) => (\n            <LoginForm\n              data-cy=\"login-form\"\n              className={authError ? 'pf-m-error' : ''}\n              helperText={helperText}\n              isLoginButtonDisabled={isAuthenticating}\n              isValidPassword={!authError}\n              isValidUsername={!authError}\n              loginButtonLabel={t`Log In`}\n              onChangePassword={(val) => {\n                formik.setFieldValue('password', val);\n                dismissAuthError();\n              }}\n              onChangeUsername={(val) => {\n                formik.setFieldValue('username', val);\n                dismissAuthError();\n              }}\n              onLoginButtonClick={formik.handleSubmit}\n              passwordLabel={t`Password`}\n              passwordValue={formik.values.password}\n              showHelperText={authError}\n              usernameLabel={t`Username`}\n              usernameValue={formik.values.username}\n            />\n          )}\n        </Formik>\n        {loginInfoError && (\n          <AlertModal\n            isOpen={loginInfoError}\n            variant=\"error\"\n            title={t`Error!`}\n            onClose={dismissLoginInfoError}\n            data-cy=\"login-info-error\"\n          >\n            {t`Failed to fetch custom login configuration settings.  System defaults will be shown instead.`}\n            <ErrorDetail error={loginInfoError} />\n          </AlertModal>\n        )}\n      </LoginMainBody>\n      <LoginMainFooter\n        socialMediaLoginContent={\n          <>\n            {socialAuthOptions &&\n              Object.keys(socialAuthOptions).map((authKey) => {\n                const loginUrl = socialAuthOptions[authKey].login_url;\n                if (authKey === 'azuread-oauth2') {\n                  return (\n                    <LoginMainFooterLinksItem\n                      data-cy=\"social-auth-azure\"\n                      href={loginUrl}\n                      key={authKey}\n                      onClick={setSessionRedirect}\n                    >\n                      <Tooltip content={t`Sign in with Azure AD`}>\n                        <AzureIcon size=\"lg\" />\n                      </Tooltip>\n                    </LoginMainFooterLinksItem>\n                  );\n                }\n                if (authKey === 'github') {\n                  return (\n                    <LoginMainFooterLinksItem\n                      data-cy=\"social-auth-github\"\n                      href={loginUrl}\n                      key={authKey}\n                      onClick={setSessionRedirect}\n                    >\n                      <Tooltip content={t`Sign in with GitHub`}>\n                        <GithubIcon size=\"lg\" />\n                      </Tooltip>\n                    </LoginMainFooterLinksItem>\n                  );\n                }\n                if (authKey === 'github-org') {\n                  return (\n                    <LoginMainFooterLinksItem\n                      data-cy=\"social-auth-github-org\"\n                      href={loginUrl}\n                      key={authKey}\n                      onClick={setSessionRedirect}\n                    >\n                      <Tooltip content={t`Sign in with GitHub Organizations`}>\n                        <GithubIcon size=\"lg\" />\n                      </Tooltip>\n                    </LoginMainFooterLinksItem>\n                  );\n                }\n                if (authKey === 'github-team') {\n                  return (\n                    <LoginMainFooterLinksItem\n                      data-cy=\"social-auth-github-team\"\n                      href={loginUrl}\n                      key={authKey}\n                      onClick={setSessionRedirect}\n                    >\n                      <Tooltip content={t`Sign in with GitHub Teams`}>\n                        <GithubIcon size=\"lg\" />\n                      </Tooltip>\n                    </LoginMainFooterLinksItem>\n                  );\n                }\n                if (authKey === 'github-enterprise') {\n                  return (\n                    <LoginMainFooterLinksItem\n                      data-cy=\"social-auth-github-enterprise\"\n                      href={loginUrl}\n                      key={authKey}\n                      onClick={setSessionRedirect}\n                    >\n                      <Tooltip content={t`Sign in with GitHub Enterprise`}>\n                        <GithubIcon size=\"lg\" />\n                      </Tooltip>\n                    </LoginMainFooterLinksItem>\n                  );\n                }\n                if (authKey === 'github-enterprise-org') {\n                  return (\n                    <LoginMainFooterLinksItem\n                      data-cy=\"social-auth-github-enterprise-org\"\n                      href={loginUrl}\n                      key={authKey}\n                      onClick={setSessionRedirect}\n                    >\n                      <Tooltip\n                        content={t`Sign in with GitHub Enterprise Organizations`}\n                      >\n                        <GithubIcon size=\"lg\" />\n                      </Tooltip>\n                    </LoginMainFooterLinksItem>\n                  );\n                }\n                if (authKey === 'github-enterprise-team') {\n                  return (\n                    <LoginMainFooterLinksItem\n                      data-cy=\"social-auth-github-enterprise-team\"\n                      href={loginUrl}\n                      key={authKey}\n                      onClick={setSessionRedirect}\n                    >\n                      <Tooltip\n                        content={t`Sign in with GitHub Enterprise Teams`}\n                      >\n                        <GithubIcon size=\"lg\" />\n                      </Tooltip>\n                    </LoginMainFooterLinksItem>\n                  );\n                }\n                if (authKey === 'google-oauth2') {\n                  return (\n                    <LoginMainFooterLinksItem\n                      data-cy=\"social-auth-google\"\n                      href={loginUrl}\n                      key={authKey}\n                      onClick={setSessionRedirect}\n                    >\n                      <Tooltip content={t`Sign in with Google`}>\n                        <GoogleIcon size=\"lg\" />\n                      </Tooltip>\n                    </LoginMainFooterLinksItem>\n                  );\n                }\n                if (authKey === 'oidc') {\n                  return (\n                    <LoginMainFooterLinksItem\n                      data-cy=\"social-auth-oidc\"\n                      href={loginUrl}\n                      key={authKey}\n                      onClick={setSessionRedirect}\n                    >\n                      <Tooltip content={t`Sign in with OIDC`}>\n                        <UserCircleIcon size=\"lg\" />\n                      </Tooltip>\n                    </LoginMainFooterLinksItem>\n                  );\n                }\n                if (authKey.startsWith('saml')) {\n                  const samlIDP = authKey.split(':')[1] || null;\n                  return (\n                    <LoginMainFooterLinksItem\n                      data-cy=\"social-auth-saml\"\n                      href={loginUrl}\n                      key={authKey}\n                      onClick={setSessionRedirect}\n                    >\n                      <Tooltip\n                        content={\n                          samlIDP\n                            ? t`Sign in with SAML ${samlIDP}`\n                            : t`Sign in with SAML`\n                        }\n                      >\n                        <UserCircleIcon size=\"lg\" />\n                      </Tooltip>\n                    </LoginMainFooterLinksItem>\n                  );\n                }\n\n                return null;\n              })}\n          </>\n        }\n      />\n    </Login>\n  );\n}\n\nexport default withRouter(AWXLogin);\nexport { AWXLogin as _AWXLogin };\n"]},"metadata":{},"sourceType":"module"}