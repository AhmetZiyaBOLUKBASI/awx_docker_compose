{"ast":null,"code":"import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import{useState,useEffect}from'react';import useWebsocket from'hooks/useWebsocket';import useThrottle from'hooks/useThrottle';export default function useWsWorkflowApprovals(initialWorkflowApprovals,fetchWorkflowApprovals){var _useState=useState(initialWorkflowApprovals),_useState2=_slicedToArray(_useState,2),workflowApprovals=_useState2[0],setWorkflowApprovals=_useState2[1];var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),reloadEntireList=_useState4[0],setReloadEntireList=_useState4[1];var throttledListRefresh=useThrottle(reloadEntireList,1000);var lastMessage=useWebsocket({jobs:['status_changed'],control:['limit_reached_1']});useEffect(function(){setWorkflowApprovals(initialWorkflowApprovals);},[initialWorkflowApprovals]);useEffect(function(){_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(throttledListRefresh){_context.next=2;break;}return _context.abrupt(\"return\");case 2:setReloadEntireList(false);fetchWorkflowApprovals();case 4:case\"end\":return _context.stop();}}},_callee);}))();},[throttledListRefresh,fetchWorkflowApprovals]);useEffect(function(){if(!((lastMessage===null||lastMessage===void 0?void 0:lastMessage.type)==='workflow_approval')){return;}var index=workflowApprovals.findIndex(function(p){return p.id===lastMessage.unified_job_id;});if(index>-1&&!['new','pending','waiting','running'].includes(lastMessage.status)||index===-1&&lastMessage.status==='pending'){setReloadEntireList(true);}},// eslint-disable-next-line react-hooks/exhaustive-deps,\n[lastMessage]);return workflowApprovals;}","map":{"version":3,"sources":["/awx_devel/awx/ui/src/screens/WorkflowApproval/WorkflowApprovalList/useWsWorkflowApprovals.js"],"names":["useState","useEffect","useWebsocket","useThrottle","useWsWorkflowApprovals","initialWorkflowApprovals","fetchWorkflowApprovals","workflowApprovals","setWorkflowApprovals","reloadEntireList","setReloadEntireList","throttledListRefresh","lastMessage","jobs","control","type","index","findIndex","p","id","unified_job_id","includes","status"],"mappings":"wTAAA,OAASA,QAAT,CAAmBC,SAAnB,KAAoC,OAApC,CACA,MAAOC,CAAAA,YAAP,KAAyB,oBAAzB,CACA,MAAOC,CAAAA,WAAP,KAAwB,mBAAxB,CAEA,cAAe,SAASC,CAAAA,sBAAT,CACbC,wBADa,CAEbC,sBAFa,CAGb,CACA,cAAkDN,QAAQ,CACxDK,wBADwD,CAA1D,wCAAOE,iBAAP,eAA0BC,oBAA1B,eAGA,eAAgDR,QAAQ,CAAC,KAAD,CAAxD,yCAAOS,gBAAP,eAAyBC,mBAAzB,eACA,GAAMC,CAAAA,oBAAoB,CAAGR,WAAW,CAACM,gBAAD,CAAmB,IAAnB,CAAxC,CACA,GAAMG,CAAAA,WAAW,CAAGV,YAAY,CAAC,CAC/BW,IAAI,CAAE,CAAC,gBAAD,CADyB,CAE/BC,OAAO,CAAE,CAAC,iBAAD,CAFsB,CAAD,CAAhC,CAKAb,SAAS,CAAC,UAAM,CACdO,oBAAoB,CAACH,wBAAD,CAApB,CACD,CAFQ,CAEN,CAACA,wBAAD,CAFM,CAAT,CAIAJ,SAAS,CAAC,UAAM,CACd,wDAAC,sIACMU,oBADN,iEAICD,mBAAmB,CAAC,KAAD,CAAnB,CACAJ,sBAAsB,GALvB,sDAAD,KAOD,CARQ,CAQN,CAACK,oBAAD,CAAuBL,sBAAvB,CARM,CAAT,CAUAL,SAAS,CACP,UAAM,CACJ,GAAI,EAAE,CAAAW,WAAW,OAAX,EAAAA,WAAW,SAAX,QAAAA,WAAW,CAAEG,IAAb,IAAsB,mBAAxB,CAAJ,CAAkD,CAChD,OACD,CAED,GAAMC,CAAAA,KAAK,CAAGT,iBAAiB,CAACU,SAAlB,CACZ,SAACC,CAAD,QAAOA,CAAAA,CAAC,CAACC,EAAF,GAASP,WAAW,CAACQ,cAA5B,EADY,CAAd,CAIA,GACGJ,KAAK,CAAG,CAAC,CAAT,EACC,CAAC,CAAC,KAAD,CAAQ,SAAR,CAAmB,SAAnB,CAA8B,SAA9B,EAAyCK,QAAzC,CACCT,WAAW,CAACU,MADb,CADH,EAICN,KAAK,GAAK,CAAC,CAAX,EAAgBJ,WAAW,CAACU,MAAZ,GAAuB,SAL1C,CAME,CACAZ,mBAAmB,CAAC,IAAD,CAAnB,CACD,CACF,CAnBM,CAoBP;AACA,CAACE,WAAD,CArBO,CAAT,CAwBA,MAAOL,CAAAA,iBAAP,CACD","sourcesContent":["import { useState, useEffect } from 'react';\nimport useWebsocket from 'hooks/useWebsocket';\nimport useThrottle from 'hooks/useThrottle';\n\nexport default function useWsWorkflowApprovals(\n  initialWorkflowApprovals,\n  fetchWorkflowApprovals\n) {\n  const [workflowApprovals, setWorkflowApprovals] = useState(\n    initialWorkflowApprovals\n  );\n  const [reloadEntireList, setReloadEntireList] = useState(false);\n  const throttledListRefresh = useThrottle(reloadEntireList, 1000);\n  const lastMessage = useWebsocket({\n    jobs: ['status_changed'],\n    control: ['limit_reached_1'],\n  });\n\n  useEffect(() => {\n    setWorkflowApprovals(initialWorkflowApprovals);\n  }, [initialWorkflowApprovals]);\n\n  useEffect(() => {\n    (async () => {\n      if (!throttledListRefresh) {\n        return;\n      }\n      setReloadEntireList(false);\n      fetchWorkflowApprovals();\n    })();\n  }, [throttledListRefresh, fetchWorkflowApprovals]);\n\n  useEffect(\n    () => {\n      if (!(lastMessage?.type === 'workflow_approval')) {\n        return;\n      }\n\n      const index = workflowApprovals.findIndex(\n        (p) => p.id === lastMessage.unified_job_id\n      );\n\n      if (\n        (index > -1 &&\n          !['new', 'pending', 'waiting', 'running'].includes(\n            lastMessage.status\n          )) ||\n        (index === -1 && lastMessage.status === 'pending')\n      ) {\n        setReloadEntireList(true);\n      }\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps,\n    [lastMessage]\n  );\n\n  return workflowApprovals;\n}\n"]},"metadata":{},"sourceType":"module"}