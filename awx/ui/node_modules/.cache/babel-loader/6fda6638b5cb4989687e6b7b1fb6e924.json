{"ast":null,"code":"import _createForOfIteratorHelper from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _objectSpread from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import React,{useCallback,useEffect,useState}from'react';import{useHistory}from'react-router-dom';import{PageSection,Card}from'@patternfly/react-core';import useRequest from'hooks/useRequest';import{CredentialsAPI,OrganizationsAPI}from'api';import{CardBody}from'components/Card';import ContentError from'components/ContentError';import ContentLoading from'components/ContentLoading';import OrganizationForm from'../shared/OrganizationForm';import{jsx as _jsx}from\"react/jsx-runtime\";function OrganizationAdd(){var history=useHistory();var _useState=useState(null),_useState2=_slicedToArray(_useState,2),formError=_useState2[0],setFormError=_useState2[1];var _useRequest=useRequest(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _yield$CredentialsAPI,results;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return CredentialsAPI.read({credential_type__kind:'galaxy',managed:true});case 2:_yield$CredentialsAPI=_context.sent;results=_yield$CredentialsAPI.data.results;return _context.abrupt(\"return\",results[0]||null);case 5:case\"end\":return _context.stop();}}},_callee);})),[]),null),isLoading=_useRequest.isLoading,defaultGalaxyCredentialError=_useRequest.error,fetchDefaultGalaxyCredential=_useRequest.request,defaultGalaxyCredential=_useRequest.result;useEffect(function(){fetchDefaultGalaxyCredential();},[fetchDefaultGalaxyCredential]);var handleSubmit=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(values,groupsToAssociate){var _values$default_envir,_yield$OrganizationsA,response,_iterator,_step,group,_iterator2,_step2,credential;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;_context2.next=3;return OrganizationsAPI.create(_objectSpread(_objectSpread({},values),{},{default_environment:(_values$default_envir=values.default_environment)===null||_values$default_envir===void 0?void 0:_values$default_envir.id}));case 3:_yield$OrganizationsA=_context2.sent;response=_yield$OrganizationsA.data;/* eslint-disable no-await-in-loop, no-restricted-syntax */ // Resolve Promises sequentially to maintain order and avoid race condition\n_iterator=_createForOfIteratorHelper(groupsToAssociate);_context2.prev=6;_iterator.s();case 8:if((_step=_iterator.n()).done){_context2.next=14;break;}group=_step.value;_context2.next=12;return OrganizationsAPI.associateInstanceGroup(response.id,group.id);case 12:_context2.next=8;break;case 14:_context2.next=19;break;case 16:_context2.prev=16;_context2.t0=_context2[\"catch\"](6);_iterator.e(_context2.t0);case 19:_context2.prev=19;_iterator.f();return _context2.finish(19);case 22:_iterator2=_createForOfIteratorHelper(values.galaxy_credentials);_context2.prev=23;_iterator2.s();case 25:if((_step2=_iterator2.n()).done){_context2.next=31;break;}credential=_step2.value;_context2.next=29;return OrganizationsAPI.associateGalaxyCredential(response.id,credential.id);case 29:_context2.next=25;break;case 31:_context2.next=36;break;case 33:_context2.prev=33;_context2.t1=_context2[\"catch\"](23);_iterator2.e(_context2.t1);case 36:_context2.prev=36;_iterator2.f();return _context2.finish(36);case 39:/* eslint-enable no-await-in-loop, no-restricted-syntax */history.push(\"/organizations/\".concat(response.id));_context2.next=45;break;case 42:_context2.prev=42;_context2.t2=_context2[\"catch\"](0);setFormError(_context2.t2);case 45:case\"end\":return _context2.stop();}}},_callee2,null,[[0,42],[6,16,19,22],[23,33,36,39]]);}));return function handleSubmit(_x,_x2){return _ref2.apply(this,arguments);};}();var handleCancel=function handleCancel(){history.push('/organizations');};if(defaultGalaxyCredentialError){return/*#__PURE__*/_jsx(PageSection,{children:/*#__PURE__*/_jsx(Card,{children:/*#__PURE__*/_jsx(CardBody,{children:/*#__PURE__*/_jsx(ContentError,{error:defaultGalaxyCredentialError})})})});}if(isLoading){return/*#__PURE__*/_jsx(PageSection,{children:/*#__PURE__*/_jsx(Card,{children:/*#__PURE__*/_jsx(CardBody,{children:/*#__PURE__*/_jsx(ContentLoading,{})})})});}return/*#__PURE__*/_jsx(PageSection,{children:/*#__PURE__*/_jsx(Card,{children:/*#__PURE__*/_jsx(CardBody,{children:/*#__PURE__*/_jsx(OrganizationForm,{onSubmit:handleSubmit,onCancel:handleCancel,submitError:formError,defaultGalaxyCredential:defaultGalaxyCredential})})})});}export{OrganizationAdd as _OrganizationAdd};export default OrganizationAdd;","map":{"version":3,"sources":["/awx_devel/awx/ui/src/screens/Organization/OrganizationAdd/OrganizationAdd.js"],"names":["React","useCallback","useEffect","useState","useHistory","PageSection","Card","useRequest","CredentialsAPI","OrganizationsAPI","CardBody","ContentError","ContentLoading","OrganizationForm","OrganizationAdd","history","formError","setFormError","read","credential_type__kind","managed","results","data","isLoading","defaultGalaxyCredentialError","error","fetchDefaultGalaxyCredential","request","defaultGalaxyCredential","result","handleSubmit","values","groupsToAssociate","create","default_environment","id","response","group","associateInstanceGroup","galaxy_credentials","credential","associateGalaxyCredential","push","handleCancel","_OrganizationAdd"],"mappings":"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","sourcesContent":["import React, { useCallback, useEffect, useState } from 'react';\nimport { useHistory } from 'react-router-dom';\nimport { PageSection, Card } from '@patternfly/react-core';\nimport useRequest from 'hooks/useRequest';\nimport { CredentialsAPI, OrganizationsAPI } from 'api';\nimport { CardBody } from 'components/Card';\nimport ContentError from 'components/ContentError';\nimport ContentLoading from 'components/ContentLoading';\nimport OrganizationForm from '../shared/OrganizationForm';\n\nfunction OrganizationAdd() {\n  const history = useHistory();\n  const [formError, setFormError] = useState(null);\n\n  const {\n    isLoading,\n    error: defaultGalaxyCredentialError,\n    request: fetchDefaultGalaxyCredential,\n    result: defaultGalaxyCredential,\n  } = useRequest(\n    useCallback(async () => {\n      const {\n        data: { results },\n      } = await CredentialsAPI.read({\n        credential_type__kind: 'galaxy',\n        managed: true,\n      });\n\n      return results[0] || null;\n    }, []),\n    null\n  );\n\n  useEffect(() => {\n    fetchDefaultGalaxyCredential();\n  }, [fetchDefaultGalaxyCredential]);\n\n  const handleSubmit = async (values, groupsToAssociate) => {\n    try {\n      const { data: response } = await OrganizationsAPI.create({\n        ...values,\n        default_environment: values.default_environment?.id,\n      });\n      /* eslint-disable no-await-in-loop, no-restricted-syntax */\n      // Resolve Promises sequentially to maintain order and avoid race condition\n      for (const group of groupsToAssociate) {\n        await OrganizationsAPI.associateInstanceGroup(response.id, group.id);\n      }\n      for (const credential of values.galaxy_credentials) {\n        await OrganizationsAPI.associateGalaxyCredential(\n          response.id,\n          credential.id\n        );\n      }\n      /* eslint-enable no-await-in-loop, no-restricted-syntax */\n\n      history.push(`/organizations/${response.id}`);\n    } catch (error) {\n      setFormError(error);\n    }\n  };\n\n  const handleCancel = () => {\n    history.push('/organizations');\n  };\n\n  if (defaultGalaxyCredentialError) {\n    return (\n      <PageSection>\n        <Card>\n          <CardBody>\n            <ContentError error={defaultGalaxyCredentialError} />\n          </CardBody>\n        </Card>\n      </PageSection>\n    );\n  }\n\n  if (isLoading) {\n    return (\n      <PageSection>\n        <Card>\n          <CardBody>\n            <ContentLoading />\n          </CardBody>\n        </Card>\n      </PageSection>\n    );\n  }\n\n  return (\n    <PageSection>\n      <Card>\n        <CardBody>\n          <OrganizationForm\n            onSubmit={handleSubmit}\n            onCancel={handleCancel}\n            submitError={formError}\n            defaultGalaxyCredential={defaultGalaxyCredential}\n          />\n        </CardBody>\n      </Card>\n    </PageSection>\n  );\n}\n\nexport { OrganizationAdd as _OrganizationAdd };\nexport default OrganizationAdd;\n"]},"metadata":{},"sourceType":"module"}