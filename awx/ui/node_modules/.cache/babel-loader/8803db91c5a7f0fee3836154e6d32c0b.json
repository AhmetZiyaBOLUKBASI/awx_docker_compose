{"ast":null,"code":"import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _taggedTemplateLiteral from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/taggedTemplateLiteral.js\";var _templateObject;import React,{useEffect,useState}from'react';import{useHistory}from'react-router-dom';import styled from'styled-components';import debounce from'util/debounce';import*as d3 from'd3';import Legend from'./Legend';import Tooltip from'./Tooltip';import ContentLoading from'./ContentLoading';import{renderStateColor,renderLabelText,renderNodeType,renderNodeIcon,redirectToDetailsPage as _redirectToDetailsPage,getHeight,getWidth}from'./utils/helpers';import webWorker from'../../util/webWorker';import{DEFAULT_RADIUS,DEFAULT_NODE_COLOR,DEFAULT_NODE_HIGHLIGHT_COLOR,DEFAULT_NODE_LABEL_TEXT_COLOR,DEFAULT_FONT_SIZE,SELECTOR}from'./constants';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var Loader=styled(ContentLoading)(_templateObject||(_templateObject=_taggedTemplateLiteral([\"\\n  height: 100%;\\n  position: absolute;\\n  width: 100%;\\n  background: white;\\n\"])));function MeshGraph(_ref){var data=_ref.data,showLegend=_ref.showLegend,zoom=_ref.zoom,setShowZoomControls=_ref.setShowZoomControls;var _useState=useState(false),_useState2=_slicedToArray(_useState,2),isNodeSelected=_useState2[0],setIsNodeSelected=_useState2[1];var _useState3=useState(null),_useState4=_slicedToArray(_useState3,2),selectedNode=_useState4[0],setSelectedNode=_useState4[1];var _useState5=useState(null),_useState6=_slicedToArray(_useState5,2),nodeDetail=_useState6[0],setNodeDetail=_useState6[1];var _useState7=useState(null),_useState8=_slicedToArray(_useState7,2),simulationProgress=_useState8[0],setSimulationProgress=_useState8[1];var history=useHistory();var draw=function draw(){var width;var height;setShowZoomControls(false);try{width=getWidth(SELECTOR);height=getHeight(SELECTOR);}catch(error){width=700;height=600;}/* Add SVG */d3.selectAll(\"#chart > svg\").remove();var svg=d3.select('#chart').append('svg').attr('aria-label','mesh-svg').attr('class','mesh-svg').attr('width',\"\".concat(width,\"px\")).attr('height',\"100%\");var mesh=svg.append('g').attr('class','mesh');var graph=data;/* WEB WORKER */var worker=webWorker();worker.postMessage({nodes:graph.nodes,links:graph.links});worker.onmessage=function handleWorkerEvent(event){switch(event.data.type){case'tick':return ticked(event.data);case'end':return ended(event.data);default:return false;}};function ticked(_ref2){var progress=_ref2.progress;var calculatedPercent=Math.round(progress*100);setSimulationProgress(calculatedPercent);}function ended(_ref3){var nodes=_ref3.nodes,links=_ref3.links;// Remove loading screen\nd3.select('.simulation-loader').style('visibility','hidden');setShowZoomControls(true);// Center the mesh\nvar simulation=d3.forceSimulation(nodes).force('center',d3.forceCenter(width/2,height/2));simulation.tick();// Add links\nmesh.append('g').attr('class',\"links\").attr('data-cy','links').selectAll('line').data(links).enter().append('line').attr('x1',function(d){return d.source.x;}).attr('y1',function(d){return d.source.y;}).attr('x2',function(d){return d.target.x;}).attr('y2',function(d){return d.target.y;}).attr('class',function(_,i){return\"link-\".concat(i);}).attr('data-cy',function(d){return\"\".concat(d.source.hostname,\"-\").concat(d.target.hostname);}).style('fill','none').style('stroke','#ccc').style('stroke-width','2px').attr('pointer-events','none').on('mouseover',function showPointer(){d3.select(this).transition().style('cursor','pointer');});// add nodes\nvar node=mesh.append('g').attr('class','nodes').attr('data-cy','nodes').selectAll('g').data(nodes).enter().append('g').on('mouseenter',function handleNodeHover(_,d){d3.select(this).transition().style('cursor','pointer');highlightSiblings(d);}).on('mouseleave',function(_,d){deselectSiblings(d);}).on('click',function(_,d){setNodeDetail(d);highlightSelected(d);});// node circles\nnode.append('circle').attr('r',DEFAULT_RADIUS).attr('cx',function(d){return d.x;}).attr('cy',function(d){return d.y;}).attr('class',function(d){return d.node_type;}).attr('class',function(d){return\"id-\".concat(d.id);}).attr('fill',DEFAULT_NODE_COLOR).attr('stroke',DEFAULT_NODE_LABEL_TEXT_COLOR);// node type labels\nnode.append('text').text(function(d){return renderNodeType(d.node_type);}).attr('x',function(d){return d.x;}).attr('y',function(d){return d.y;}).attr('text-anchor','middle').attr('dominant-baseline','central').attr('fill',DEFAULT_NODE_LABEL_TEXT_COLOR);// node hostname labels\nvar hostNames=node.append('g');hostNames.append('text').attr('x',function(d){return d.x;}).attr('y',function(d){return d.y+40;}).text(function(d){return renderLabelText(d.node_state,d.hostname);}).attr('class','placeholder').attr('fill',DEFAULT_NODE_LABEL_TEXT_COLOR).attr('text-anchor','middle').each(function calculateLabelWidth(){// eslint-disable-next-line react/no-this-in-sfc\nvar bbox=this.getBBox();// eslint-disable-next-line react/no-this-in-sfc\nd3.select(this.parentNode).append('rect').attr('x',bbox.x).attr('y',bbox.y).attr('width',bbox.width).attr('height',bbox.height).attr('rx',8).attr('ry',8).style('fill',function(d){return renderStateColor(d.node_state);});});svg.selectAll('text.placeholder').remove();hostNames.append('text').attr('x',function(d){return d.x;}).attr('y',function(d){return d.y+38;}).text(function(d){return renderLabelText(d.node_state,d.hostname);}).attr('font-size',DEFAULT_FONT_SIZE).attr('fill',DEFAULT_NODE_LABEL_TEXT_COLOR).attr('text-anchor','middle');svg.call(zoom);function highlightSiblings(n){svg.select(\"circle.id-\".concat(n.id)).attr('fill',DEFAULT_NODE_HIGHLIGHT_COLOR);var immediate=links.filter(function(l){return n.hostname===l.source.hostname||n.hostname===l.target.hostname;});immediate.forEach(function(s){svg.selectAll(\".link-\".concat(s.index)).transition().style('stroke','#0066CC').style('stroke-width','3px');});}function deselectSiblings(n){svg.select(\"circle.id-\".concat(n.id)).attr('fill',DEFAULT_NODE_COLOR);var immediate=links.filter(function(l){return n.hostname===l.source.hostname||n.hostname===l.target.hostname;});immediate.forEach(function(s){svg.selectAll(\".link-\".concat(s.index)).transition().style('stroke','#ccc').style('stroke-width','2px');});}function highlightSelected(n){if(svg.select(\"circle.id-\".concat(n.id)).attr('stroke-width')!==null){// toggle rings\nsvg.select(\"circle.id-\".concat(n.id)).attr('stroke-width',null);// show default empty state of tooltip\nsetIsNodeSelected(false);setSelectedNode(null);return;}svg.selectAll('circle').attr('stroke-width',null);svg.select(\"circle.id-\".concat(n.id)).attr('stroke-width','5px').attr('stroke','#D2D2D2');setIsNodeSelected(true);setSelectedNode(n);}}};useEffect(function(){function handleResize(){d3.select('.simulation-loader').style('visibility','visible');setSelectedNode(null);setIsNodeSelected(false);draw();}window.addEventListener('resize',debounce(handleResize,500));handleResize();return function(){return window.removeEventListener('resize',handleResize);};},[]);// eslint-disable-line react-hooks/exhaustive-deps\nreturn/*#__PURE__*/_jsxs(\"div\",{id:\"chart\",style:{position:'relative',height:'100%'},children:[showLegend&&/*#__PURE__*/_jsx(Legend,{}),/*#__PURE__*/_jsx(Tooltip,{isNodeSelected:isNodeSelected,renderNodeIcon:renderNodeIcon(selectedNode),nodeDetail:nodeDetail,redirectToDetailsPage:function redirectToDetailsPage(){return _redirectToDetailsPage(selectedNode,history);}}),/*#__PURE__*/_jsx(Loader,{className:\"simulation-loader\",progress:simulationProgress})]});}export default MeshGraph;","map":{"version":3,"sources":["/awx_devel/awx/ui/src/screens/TopologyView/MeshGraph.js"],"names":["React","useEffect","useState","useHistory","styled","debounce","d3","Legend","Tooltip","ContentLoading","renderStateColor","renderLabelText","renderNodeType","renderNodeIcon","redirectToDetailsPage","getHeight","getWidth","webWorker","DEFAULT_RADIUS","DEFAULT_NODE_COLOR","DEFAULT_NODE_HIGHLIGHT_COLOR","DEFAULT_NODE_LABEL_TEXT_COLOR","DEFAULT_FONT_SIZE","SELECTOR","Loader","MeshGraph","data","showLegend","zoom","setShowZoomControls","isNodeSelected","setIsNodeSelected","selectedNode","setSelectedNode","nodeDetail","setNodeDetail","simulationProgress","setSimulationProgress","history","draw","width","height","error","selectAll","remove","svg","select","append","attr","mesh","graph","worker","postMessage","nodes","links","onmessage","handleWorkerEvent","event","type","ticked","ended","progress","calculatedPercent","Math","round","style","simulation","forceSimulation","force","forceCenter","tick","enter","d","source","x","y","target","_","i","hostname","on","showPointer","transition","node","handleNodeHover","highlightSiblings","deselectSiblings","highlightSelected","node_type","id","text","hostNames","node_state","each","calculateLabelWidth","bbox","getBBox","parentNode","call","n","immediate","filter","l","forEach","s","index","handleResize","window","addEventListener","removeEventListener","position"],"mappings":"kPAAA,MAAOA,CAAAA,KAAP,EAAgBC,SAAhB,CAA2BC,QAA3B,KAA2C,OAA3C,CACA,OAASC,UAAT,KAA2B,kBAA3B,CACA,MAAOC,CAAAA,MAAP,KAAmB,mBAAnB,CACA,MAAOC,CAAAA,QAAP,KAAqB,eAArB,CACA,MAAO,GAAKC,CAAAA,EAAZ,KAAoB,IAApB,CACA,MAAOC,CAAAA,MAAP,KAAmB,UAAnB,CACA,MAAOC,CAAAA,OAAP,KAAoB,WAApB,CACA,MAAOC,CAAAA,cAAP,KAA2B,kBAA3B,CACA,OACEC,gBADF,CAEEC,eAFF,CAGEC,cAHF,CAIEC,cAJF,CAKEC,qBAAqB,GAArBA,CAAAA,sBALF,CAMEC,SANF,CAOEC,QAPF,KAQO,iBARP,CASA,MAAOC,CAAAA,SAAP,KAAsB,sBAAtB,CACA,OACEC,cADF,CAEEC,kBAFF,CAGEC,4BAHF,CAIEC,6BAJF,CAKEC,iBALF,CAMEC,QANF,KAOO,aAPP,C,wFASA,GAAMC,CAAAA,MAAM,CAAGpB,MAAM,CAACK,cAAD,CAAT,iJAAZ,CAMA,QAASgB,CAAAA,SAAT,MAAoE,IAA/CC,CAAAA,IAA+C,MAA/CA,IAA+C,CAAzCC,UAAyC,MAAzCA,UAAyC,CAA7BC,IAA6B,MAA7BA,IAA6B,CAAvBC,mBAAuB,MAAvBA,mBAAuB,CAClE,cAA4C3B,QAAQ,CAAC,KAAD,CAApD,wCAAO4B,cAAP,eAAuBC,iBAAvB,eACA,eAAwC7B,QAAQ,CAAC,IAAD,CAAhD,yCAAO8B,YAAP,eAAqBC,eAArB,eACA,eAAoC/B,QAAQ,CAAC,IAAD,CAA5C,yCAAOgC,UAAP,eAAmBC,aAAnB,eACA,eAAoDjC,QAAQ,CAAC,IAAD,CAA5D,yCAAOkC,kBAAP,eAA2BC,qBAA3B,eACA,GAAMC,CAAAA,OAAO,CAAGnC,UAAU,EAA1B,CAEA,GAAMoC,CAAAA,IAAI,CAAG,QAAPA,CAAAA,IAAO,EAAM,CACjB,GAAIC,CAAAA,KAAJ,CACA,GAAIC,CAAAA,MAAJ,CACAZ,mBAAmB,CAAC,KAAD,CAAnB,CACA,GAAI,CACFW,KAAK,CAAGxB,QAAQ,CAACO,QAAD,CAAhB,CACAkB,MAAM,CAAG1B,SAAS,CAACQ,QAAD,CAAlB,CACD,CAAC,MAAOmB,KAAP,CAAc,CACdF,KAAK,CAAG,GAAR,CACAC,MAAM,CAAG,GAAT,CACD,CAED,aACAnC,EAAE,CAACqC,SAAH,iBAA6BC,MAA7B,GACA,GAAMC,CAAAA,GAAG,CAAGvC,EAAE,CACXwC,MADS,CACF,QADE,EAETC,MAFS,CAEF,KAFE,EAGTC,IAHS,CAGJ,YAHI,CAGU,UAHV,EAITA,IAJS,CAIJ,OAJI,CAIK,UAJL,EAKTA,IALS,CAKJ,OALI,WAKQR,KALR,QAMTQ,IANS,CAMJ,QANI,QAAZ,CAOA,GAAMC,CAAAA,IAAI,CAAGJ,GAAG,CAACE,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,OAArB,CAA8B,MAA9B,CAAb,CAEA,GAAME,CAAAA,KAAK,CAAGxB,IAAd,CAEA,gBACA,GAAMyB,CAAAA,MAAM,CAAGlC,SAAS,EAAxB,CACAkC,MAAM,CAACC,WAAP,CAAmB,CACjBC,KAAK,CAAEH,KAAK,CAACG,KADI,CAEjBC,KAAK,CAAEJ,KAAK,CAACI,KAFI,CAAnB,EAKAH,MAAM,CAACI,SAAP,CAAmB,QAASC,CAAAA,iBAAT,CAA2BC,KAA3B,CAAkC,CACnD,OAAQA,KAAK,CAAC/B,IAAN,CAAWgC,IAAnB,EACE,IAAK,MAAL,CACE,MAAOC,CAAAA,MAAM,CAACF,KAAK,CAAC/B,IAAP,CAAb,CACF,IAAK,KAAL,CACE,MAAOkC,CAAAA,KAAK,CAACH,KAAK,CAAC/B,IAAP,CAAZ,CACF,QACE,MAAO,MAAP,CANJ,CAQD,CATD,CAWA,QAASiC,CAAAA,MAAT,OAA8B,IAAZE,CAAAA,QAAY,OAAZA,QAAY,CAC5B,GAAMC,CAAAA,iBAAiB,CAAGC,IAAI,CAACC,KAAL,CAAWH,QAAQ,CAAG,GAAtB,CAA1B,CACAxB,qBAAqB,CAACyB,iBAAD,CAArB,CACD,CAED,QAASF,CAAAA,KAAT,OAAiC,IAAhBP,CAAAA,KAAgB,OAAhBA,KAAgB,CAATC,KAAS,OAATA,KAAS,CAC/B;AACAhD,EAAE,CAACwC,MAAH,CAAU,oBAAV,EAAgCmB,KAAhC,CAAsC,YAAtC,CAAoD,QAApD,EACApC,mBAAmB,CAAC,IAAD,CAAnB,CACA;AACA,GAAMqC,CAAAA,UAAU,CAAG5D,EAAE,CAClB6D,eADgB,CACAd,KADA,EAEhBe,KAFgB,CAEV,QAFU,CAEA9D,EAAE,CAAC+D,WAAH,CAAe7B,KAAK,CAAG,CAAvB,CAA0BC,MAAM,CAAG,CAAnC,CAFA,CAAnB,CAGAyB,UAAU,CAACI,IAAX,GACA;AACArB,IAAI,CACDF,MADH,CACU,GADV,EAEGC,IAFH,CAEQ,OAFR,UAGGA,IAHH,CAGQ,SAHR,CAGmB,OAHnB,EAIGL,SAJH,CAIa,MAJb,EAKGjB,IALH,CAKQ4B,KALR,EAMGiB,KANH,GAOGxB,MAPH,CAOU,MAPV,EAQGC,IARH,CAQQ,IARR,CAQc,SAACwB,CAAD,QAAOA,CAAAA,CAAC,CAACC,MAAF,CAASC,CAAhB,EARd,EASG1B,IATH,CASQ,IATR,CASc,SAACwB,CAAD,QAAOA,CAAAA,CAAC,CAACC,MAAF,CAASE,CAAhB,EATd,EAUG3B,IAVH,CAUQ,IAVR,CAUc,SAACwB,CAAD,QAAOA,CAAAA,CAAC,CAACI,MAAF,CAASF,CAAhB,EAVd,EAWG1B,IAXH,CAWQ,IAXR,CAWc,SAACwB,CAAD,QAAOA,CAAAA,CAAC,CAACI,MAAF,CAASD,CAAhB,EAXd,EAYG3B,IAZH,CAYQ,OAZR,CAYiB,SAAC6B,CAAD,CAAIC,CAAJ,uBAAkBA,CAAlB,GAZjB,EAaG9B,IAbH,CAaQ,SAbR,CAamB,SAACwB,CAAD,kBAAUA,CAAC,CAACC,MAAF,CAASM,QAAnB,aAA+BP,CAAC,CAACI,MAAF,CAASG,QAAxC,GAbnB,EAcGd,KAdH,CAcS,MAdT,CAciB,MAdjB,EAeGA,KAfH,CAeS,QAfT,CAemB,MAfnB,EAgBGA,KAhBH,CAgBS,cAhBT,CAgByB,KAhBzB,EAiBGjB,IAjBH,CAiBQ,gBAjBR,CAiB0B,MAjB1B,EAkBGgC,EAlBH,CAkBM,WAlBN,CAkBmB,QAASC,CAAAA,WAAT,EAAuB,CACtC3E,EAAE,CAACwC,MAAH,CAAU,IAAV,EAAgBoC,UAAhB,GAA6BjB,KAA7B,CAAmC,QAAnC,CAA6C,SAA7C,EACD,CApBH,EAqBA;AACA,GAAMkB,CAAAA,IAAI,CAAGlC,IAAI,CACdF,MADU,CACH,GADG,EAEVC,IAFU,CAEL,OAFK,CAEI,OAFJ,EAGVA,IAHU,CAGL,SAHK,CAGM,OAHN,EAIVL,SAJU,CAIA,GAJA,EAKVjB,IALU,CAKL2B,KALK,EAMVkB,KANU,GAOVxB,MAPU,CAOH,GAPG,EAQViC,EARU,CAQP,YARO,CAQO,QAASI,CAAAA,eAAT,CAAyBP,CAAzB,CAA4BL,CAA5B,CAA+B,CAC/ClE,EAAE,CAACwC,MAAH,CAAU,IAAV,EAAgBoC,UAAhB,GAA6BjB,KAA7B,CAAmC,QAAnC,CAA6C,SAA7C,EACAoB,iBAAiB,CAACb,CAAD,CAAjB,CACD,CAXU,EAYVQ,EAZU,CAYP,YAZO,CAYO,SAACH,CAAD,CAAIL,CAAJ,CAAU,CAC1Bc,gBAAgB,CAACd,CAAD,CAAhB,CACD,CAdU,EAeVQ,EAfU,CAeP,OAfO,CAeE,SAACH,CAAD,CAAIL,CAAJ,CAAU,CACrBrC,aAAa,CAACqC,CAAD,CAAb,CACAe,iBAAiB,CAACf,CAAD,CAAjB,CACD,CAlBU,CAAb,CAoBA;AACAW,IAAI,CACDpC,MADH,CACU,QADV,EAEGC,IAFH,CAEQ,GAFR,CAEa9B,cAFb,EAGG8B,IAHH,CAGQ,IAHR,CAGc,SAACwB,CAAD,QAAOA,CAAAA,CAAC,CAACE,CAAT,EAHd,EAIG1B,IAJH,CAIQ,IAJR,CAIc,SAACwB,CAAD,QAAOA,CAAAA,CAAC,CAACG,CAAT,EAJd,EAKG3B,IALH,CAKQ,OALR,CAKiB,SAACwB,CAAD,QAAOA,CAAAA,CAAC,CAACgB,SAAT,EALjB,EAMGxC,IANH,CAMQ,OANR,CAMiB,SAACwB,CAAD,qBAAaA,CAAC,CAACiB,EAAf,GANjB,EAOGzC,IAPH,CAOQ,MAPR,CAOgB7B,kBAPhB,EAQG6B,IARH,CAQQ,QARR,CAQkB3B,6BARlB,EAUA;AACA8D,IAAI,CACDpC,MADH,CACU,MADV,EAEG2C,IAFH,CAEQ,SAAClB,CAAD,QAAO5D,CAAAA,cAAc,CAAC4D,CAAC,CAACgB,SAAH,CAArB,EAFR,EAGGxC,IAHH,CAGQ,GAHR,CAGa,SAACwB,CAAD,QAAOA,CAAAA,CAAC,CAACE,CAAT,EAHb,EAIG1B,IAJH,CAIQ,GAJR,CAIa,SAACwB,CAAD,QAAOA,CAAAA,CAAC,CAACG,CAAT,EAJb,EAKG3B,IALH,CAKQ,aALR,CAKuB,QALvB,EAMGA,IANH,CAMQ,mBANR,CAM6B,SAN7B,EAOGA,IAPH,CAOQ,MAPR,CAOgB3B,6BAPhB,EASA;AACA,GAAMsE,CAAAA,SAAS,CAAGR,IAAI,CAACpC,MAAL,CAAY,GAAZ,CAAlB,CACA4C,SAAS,CACN5C,MADH,CACU,MADV,EAEGC,IAFH,CAEQ,GAFR,CAEa,SAACwB,CAAD,QAAOA,CAAAA,CAAC,CAACE,CAAT,EAFb,EAGG1B,IAHH,CAGQ,GAHR,CAGa,SAACwB,CAAD,QAAOA,CAAAA,CAAC,CAACG,CAAF,CAAM,EAAb,EAHb,EAIGe,IAJH,CAIQ,SAAClB,CAAD,QAAO7D,CAAAA,eAAe,CAAC6D,CAAC,CAACoB,UAAH,CAAepB,CAAC,CAACO,QAAjB,CAAtB,EAJR,EAKG/B,IALH,CAKQ,OALR,CAKiB,aALjB,EAMGA,IANH,CAMQ,MANR,CAMgB3B,6BANhB,EAOG2B,IAPH,CAOQ,aAPR,CAOuB,QAPvB,EAQG6C,IARH,CAQQ,QAASC,CAAAA,mBAAT,EAA+B,CACnC;AACA,GAAMC,CAAAA,IAAI,CAAG,KAAKC,OAAL,EAAb,CACA;AACA1F,EAAE,CAACwC,MAAH,CAAU,KAAKmD,UAAf,EACGlD,MADH,CACU,MADV,EAEGC,IAFH,CAEQ,GAFR,CAEa+C,IAAI,CAACrB,CAFlB,EAGG1B,IAHH,CAGQ,GAHR,CAGa+C,IAAI,CAACpB,CAHlB,EAIG3B,IAJH,CAIQ,OAJR,CAIiB+C,IAAI,CAACvD,KAJtB,EAKGQ,IALH,CAKQ,QALR,CAKkB+C,IAAI,CAACtD,MALvB,EAMGO,IANH,CAMQ,IANR,CAMc,CANd,EAOGA,IAPH,CAOQ,IAPR,CAOc,CAPd,EAQGiB,KARH,CAQS,MART,CAQiB,SAACO,CAAD,QAAO9D,CAAAA,gBAAgB,CAAC8D,CAAC,CAACoB,UAAH,CAAvB,EARjB,EASD,CArBH,EAsBA/C,GAAG,CAACF,SAAJ,CAAc,kBAAd,EAAkCC,MAAlC,GACA+C,SAAS,CACN5C,MADH,CACU,MADV,EAEGC,IAFH,CAEQ,GAFR,CAEa,SAACwB,CAAD,QAAOA,CAAAA,CAAC,CAACE,CAAT,EAFb,EAGG1B,IAHH,CAGQ,GAHR,CAGa,SAACwB,CAAD,QAAOA,CAAAA,CAAC,CAACG,CAAF,CAAM,EAAb,EAHb,EAIGe,IAJH,CAIQ,SAAClB,CAAD,QAAO7D,CAAAA,eAAe,CAAC6D,CAAC,CAACoB,UAAH,CAAepB,CAAC,CAACO,QAAjB,CAAtB,EAJR,EAKG/B,IALH,CAKQ,WALR,CAKqB1B,iBALrB,EAMG0B,IANH,CAMQ,MANR,CAMgB3B,6BANhB,EAOG2B,IAPH,CAOQ,aAPR,CAOuB,QAPvB,EASAH,GAAG,CAACqD,IAAJ,CAAStE,IAAT,EAEA,QAASyD,CAAAA,iBAAT,CAA2Bc,CAA3B,CAA8B,CAC5BtD,GAAG,CACAC,MADH,qBACuBqD,CAAC,CAACV,EADzB,GAEGzC,IAFH,CAEQ,MAFR,CAEgB5B,4BAFhB,EAGA,GAAMgF,CAAAA,SAAS,CAAG9C,KAAK,CAAC+C,MAAN,CAChB,SAACC,CAAD,QACEH,CAAAA,CAAC,CAACpB,QAAF,GAAeuB,CAAC,CAAC7B,MAAF,CAASM,QAAxB,EAAoCoB,CAAC,CAACpB,QAAF,GAAeuB,CAAC,CAAC1B,MAAF,CAASG,QAD9D,EADgB,CAAlB,CAIAqB,SAAS,CAACG,OAAV,CAAkB,SAACC,CAAD,CAAO,CACvB3D,GAAG,CACAF,SADH,iBACsB6D,CAAC,CAACC,KADxB,GAEGvB,UAFH,GAGGjB,KAHH,CAGS,QAHT,CAGmB,SAHnB,EAIGA,KAJH,CAIS,cAJT,CAIyB,KAJzB,EAKD,CAND,EAOD,CAED,QAASqB,CAAAA,gBAAT,CAA0Ba,CAA1B,CAA6B,CAC3BtD,GAAG,CAACC,MAAJ,qBAAwBqD,CAAC,CAACV,EAA1B,GAAgCzC,IAAhC,CAAqC,MAArC,CAA6C7B,kBAA7C,EACA,GAAMiF,CAAAA,SAAS,CAAG9C,KAAK,CAAC+C,MAAN,CAChB,SAACC,CAAD,QACEH,CAAAA,CAAC,CAACpB,QAAF,GAAeuB,CAAC,CAAC7B,MAAF,CAASM,QAAxB,EAAoCoB,CAAC,CAACpB,QAAF,GAAeuB,CAAC,CAAC1B,MAAF,CAASG,QAD9D,EADgB,CAAlB,CAIAqB,SAAS,CAACG,OAAV,CAAkB,SAACC,CAAD,CAAO,CACvB3D,GAAG,CACAF,SADH,iBACsB6D,CAAC,CAACC,KADxB,GAEGvB,UAFH,GAGGjB,KAHH,CAGS,QAHT,CAGmB,MAHnB,EAIGA,KAJH,CAIS,cAJT,CAIyB,KAJzB,EAKD,CAND,EAOD,CAED,QAASsB,CAAAA,iBAAT,CAA2BY,CAA3B,CAA8B,CAC5B,GAAItD,GAAG,CAACC,MAAJ,qBAAwBqD,CAAC,CAACV,EAA1B,GAAgCzC,IAAhC,CAAqC,cAArC,IAAyD,IAA7D,CAAmE,CACjE;AACAH,GAAG,CAACC,MAAJ,qBAAwBqD,CAAC,CAACV,EAA1B,GAAgCzC,IAAhC,CAAqC,cAArC,CAAqD,IAArD,EACA;AACAjB,iBAAiB,CAAC,KAAD,CAAjB,CACAE,eAAe,CAAC,IAAD,CAAf,CACA,OACD,CACDY,GAAG,CAACF,SAAJ,CAAc,QAAd,EAAwBK,IAAxB,CAA6B,cAA7B,CAA6C,IAA7C,EACAH,GAAG,CACAC,MADH,qBACuBqD,CAAC,CAACV,EADzB,GAEGzC,IAFH,CAEQ,cAFR,CAEwB,KAFxB,EAGGA,IAHH,CAGQ,QAHR,CAGkB,SAHlB,EAIAjB,iBAAiB,CAAC,IAAD,CAAjB,CACAE,eAAe,CAACkE,CAAD,CAAf,CACD,CACF,CACF,CA/MD,CAiNAlG,SAAS,CAAC,UAAM,CACd,QAASyG,CAAAA,YAAT,EAAwB,CACtBpG,EAAE,CAACwC,MAAH,CAAU,oBAAV,EAAgCmB,KAAhC,CAAsC,YAAtC,CAAoD,SAApD,EACAhC,eAAe,CAAC,IAAD,CAAf,CACAF,iBAAiB,CAAC,KAAD,CAAjB,CACAQ,IAAI,GACL,CACDoE,MAAM,CAACC,gBAAP,CAAwB,QAAxB,CAAkCvG,QAAQ,CAACqG,YAAD,CAAe,GAAf,CAA1C,EACAA,YAAY,GACZ,MAAO,kBAAMC,CAAAA,MAAM,CAACE,mBAAP,CAA2B,QAA3B,CAAqCH,YAArC,CAAN,EAAP,CACD,CAVQ,CAUN,EAVM,CAAT,CAUQ;AAER,mBACE,aAAK,EAAE,CAAC,OAAR,CAAgB,KAAK,CAAE,CAAEI,QAAQ,CAAE,UAAZ,CAAwBrE,MAAM,CAAE,MAAhC,CAAvB,WACGd,UAAU,eAAI,KAAC,MAAD,IADjB,cAEE,KAAC,OAAD,EACE,cAAc,CAAEG,cADlB,CAEE,cAAc,CAAEjB,cAAc,CAACmB,YAAD,CAFhC,CAGE,UAAU,CAAEE,UAHd,CAIE,qBAAqB,CAAE,uCACrBpB,CAAAA,sBAAqB,CAACkB,YAAD,CAAeM,OAAf,CADA,EAJzB,EAFF,cAUE,KAAC,MAAD,EAAQ,SAAS,CAAC,mBAAlB,CAAsC,QAAQ,CAAEF,kBAAhD,EAVF,GADF,CAcD,CAED,cAAeX,CAAAA,SAAf","sourcesContent":["import React, { useEffect, useState } from 'react';\nimport { useHistory } from 'react-router-dom';\nimport styled from 'styled-components';\nimport debounce from 'util/debounce';\nimport * as d3 from 'd3';\nimport Legend from './Legend';\nimport Tooltip from './Tooltip';\nimport ContentLoading from './ContentLoading';\nimport {\n  renderStateColor,\n  renderLabelText,\n  renderNodeType,\n  renderNodeIcon,\n  redirectToDetailsPage,\n  getHeight,\n  getWidth,\n} from './utils/helpers';\nimport webWorker from '../../util/webWorker';\nimport {\n  DEFAULT_RADIUS,\n  DEFAULT_NODE_COLOR,\n  DEFAULT_NODE_HIGHLIGHT_COLOR,\n  DEFAULT_NODE_LABEL_TEXT_COLOR,\n  DEFAULT_FONT_SIZE,\n  SELECTOR,\n} from './constants';\n\nconst Loader = styled(ContentLoading)`\n  height: 100%;\n  position: absolute;\n  width: 100%;\n  background: white;\n`;\nfunction MeshGraph({ data, showLegend, zoom, setShowZoomControls }) {\n  const [isNodeSelected, setIsNodeSelected] = useState(false);\n  const [selectedNode, setSelectedNode] = useState(null);\n  const [nodeDetail, setNodeDetail] = useState(null);\n  const [simulationProgress, setSimulationProgress] = useState(null);\n  const history = useHistory();\n\n  const draw = () => {\n    let width;\n    let height;\n    setShowZoomControls(false);\n    try {\n      width = getWidth(SELECTOR);\n      height = getHeight(SELECTOR);\n    } catch (error) {\n      width = 700;\n      height = 600;\n    }\n\n    /* Add SVG */\n    d3.selectAll(`#chart > svg`).remove();\n    const svg = d3\n      .select('#chart')\n      .append('svg')\n      .attr('aria-label', 'mesh-svg')\n      .attr('class', 'mesh-svg')\n      .attr('width', `${width}px`)\n      .attr('height', `100%`);\n    const mesh = svg.append('g').attr('class', 'mesh');\n\n    const graph = data;\n\n    /* WEB WORKER */\n    const worker = webWorker();\n    worker.postMessage({\n      nodes: graph.nodes,\n      links: graph.links,\n    });\n\n    worker.onmessage = function handleWorkerEvent(event) {\n      switch (event.data.type) {\n        case 'tick':\n          return ticked(event.data);\n        case 'end':\n          return ended(event.data);\n        default:\n          return false;\n      }\n    };\n\n    function ticked({ progress }) {\n      const calculatedPercent = Math.round(progress * 100);\n      setSimulationProgress(calculatedPercent);\n    }\n\n    function ended({ nodes, links }) {\n      // Remove loading screen\n      d3.select('.simulation-loader').style('visibility', 'hidden');\n      setShowZoomControls(true);\n      // Center the mesh\n      const simulation = d3\n        .forceSimulation(nodes)\n        .force('center', d3.forceCenter(width / 2, height / 2));\n      simulation.tick();\n      // Add links\n      mesh\n        .append('g')\n        .attr('class', `links`)\n        .attr('data-cy', 'links')\n        .selectAll('line')\n        .data(links)\n        .enter()\n        .append('line')\n        .attr('x1', (d) => d.source.x)\n        .attr('y1', (d) => d.source.y)\n        .attr('x2', (d) => d.target.x)\n        .attr('y2', (d) => d.target.y)\n        .attr('class', (_, i) => `link-${i}`)\n        .attr('data-cy', (d) => `${d.source.hostname}-${d.target.hostname}`)\n        .style('fill', 'none')\n        .style('stroke', '#ccc')\n        .style('stroke-width', '2px')\n        .attr('pointer-events', 'none')\n        .on('mouseover', function showPointer() {\n          d3.select(this).transition().style('cursor', 'pointer');\n        });\n      // add nodes\n      const node = mesh\n        .append('g')\n        .attr('class', 'nodes')\n        .attr('data-cy', 'nodes')\n        .selectAll('g')\n        .data(nodes)\n        .enter()\n        .append('g')\n        .on('mouseenter', function handleNodeHover(_, d) {\n          d3.select(this).transition().style('cursor', 'pointer');\n          highlightSiblings(d);\n        })\n        .on('mouseleave', (_, d) => {\n          deselectSiblings(d);\n        })\n        .on('click', (_, d) => {\n          setNodeDetail(d);\n          highlightSelected(d);\n        });\n\n      // node circles\n      node\n        .append('circle')\n        .attr('r', DEFAULT_RADIUS)\n        .attr('cx', (d) => d.x)\n        .attr('cy', (d) => d.y)\n        .attr('class', (d) => d.node_type)\n        .attr('class', (d) => `id-${d.id}`)\n        .attr('fill', DEFAULT_NODE_COLOR)\n        .attr('stroke', DEFAULT_NODE_LABEL_TEXT_COLOR);\n\n      // node type labels\n      node\n        .append('text')\n        .text((d) => renderNodeType(d.node_type))\n        .attr('x', (d) => d.x)\n        .attr('y', (d) => d.y)\n        .attr('text-anchor', 'middle')\n        .attr('dominant-baseline', 'central')\n        .attr('fill', DEFAULT_NODE_LABEL_TEXT_COLOR);\n\n      // node hostname labels\n      const hostNames = node.append('g');\n      hostNames\n        .append('text')\n        .attr('x', (d) => d.x)\n        .attr('y', (d) => d.y + 40)\n        .text((d) => renderLabelText(d.node_state, d.hostname))\n        .attr('class', 'placeholder')\n        .attr('fill', DEFAULT_NODE_LABEL_TEXT_COLOR)\n        .attr('text-anchor', 'middle')\n        .each(function calculateLabelWidth() {\n          // eslint-disable-next-line react/no-this-in-sfc\n          const bbox = this.getBBox();\n          // eslint-disable-next-line react/no-this-in-sfc\n          d3.select(this.parentNode)\n            .append('rect')\n            .attr('x', bbox.x)\n            .attr('y', bbox.y)\n            .attr('width', bbox.width)\n            .attr('height', bbox.height)\n            .attr('rx', 8)\n            .attr('ry', 8)\n            .style('fill', (d) => renderStateColor(d.node_state));\n        });\n      svg.selectAll('text.placeholder').remove();\n      hostNames\n        .append('text')\n        .attr('x', (d) => d.x)\n        .attr('y', (d) => d.y + 38)\n        .text((d) => renderLabelText(d.node_state, d.hostname))\n        .attr('font-size', DEFAULT_FONT_SIZE)\n        .attr('fill', DEFAULT_NODE_LABEL_TEXT_COLOR)\n        .attr('text-anchor', 'middle');\n\n      svg.call(zoom);\n\n      function highlightSiblings(n) {\n        svg\n          .select(`circle.id-${n.id}`)\n          .attr('fill', DEFAULT_NODE_HIGHLIGHT_COLOR);\n        const immediate = links.filter(\n          (l) =>\n            n.hostname === l.source.hostname || n.hostname === l.target.hostname\n        );\n        immediate.forEach((s) => {\n          svg\n            .selectAll(`.link-${s.index}`)\n            .transition()\n            .style('stroke', '#0066CC')\n            .style('stroke-width', '3px');\n        });\n      }\n\n      function deselectSiblings(n) {\n        svg.select(`circle.id-${n.id}`).attr('fill', DEFAULT_NODE_COLOR);\n        const immediate = links.filter(\n          (l) =>\n            n.hostname === l.source.hostname || n.hostname === l.target.hostname\n        );\n        immediate.forEach((s) => {\n          svg\n            .selectAll(`.link-${s.index}`)\n            .transition()\n            .style('stroke', '#ccc')\n            .style('stroke-width', '2px');\n        });\n      }\n\n      function highlightSelected(n) {\n        if (svg.select(`circle.id-${n.id}`).attr('stroke-width') !== null) {\n          // toggle rings\n          svg.select(`circle.id-${n.id}`).attr('stroke-width', null);\n          // show default empty state of tooltip\n          setIsNodeSelected(false);\n          setSelectedNode(null);\n          return;\n        }\n        svg.selectAll('circle').attr('stroke-width', null);\n        svg\n          .select(`circle.id-${n.id}`)\n          .attr('stroke-width', '5px')\n          .attr('stroke', '#D2D2D2');\n        setIsNodeSelected(true);\n        setSelectedNode(n);\n      }\n    }\n  };\n\n  useEffect(() => {\n    function handleResize() {\n      d3.select('.simulation-loader').style('visibility', 'visible');\n      setSelectedNode(null);\n      setIsNodeSelected(false);\n      draw();\n    }\n    window.addEventListener('resize', debounce(handleResize, 500));\n    handleResize();\n    return () => window.removeEventListener('resize', handleResize);\n  }, []); // eslint-disable-line react-hooks/exhaustive-deps\n\n  return (\n    <div id=\"chart\" style={{ position: 'relative', height: '100%' }}>\n      {showLegend && <Legend />}\n      <Tooltip\n        isNodeSelected={isNodeSelected}\n        renderNodeIcon={renderNodeIcon(selectedNode)}\n        nodeDetail={nodeDetail}\n        redirectToDetailsPage={() =>\n          redirectToDetailsPage(selectedNode, history)\n        }\n      />\n      <Loader className=\"simulation-loader\" progress={simulationProgress} />\n    </div>\n  );\n}\n\nexport default MeshGraph;\n"]},"metadata":{},"sourceType":"module"}