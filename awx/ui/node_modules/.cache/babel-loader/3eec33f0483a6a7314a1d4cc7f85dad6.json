{"ast":null,"code":"import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _taggedTemplateLiteral from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/taggedTemplateLiteral.js\";var _templateObject,_templateObject2,_templateObject3;import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import{Trans}from\"@lingui/react\";import{i18n}from\"@lingui/core\";import React,{useCallback,useEffect,useState}from'react';import{useParams}from'react-router-dom';import{Button,Progress,ProgressMeasureLocation,ProgressSize,CodeBlock,CodeBlockCode,Tooltip,Slider}from'@patternfly/react-core';import styled from'styled-components';import{useConfig}from'contexts/Config';import{InstancesAPI}from'api';import useDebounce from'hooks/useDebounce';import AlertModal from'components/AlertModal';import ErrorDetail from'components/ErrorDetail';import InstanceToggle from'components/InstanceToggle';import{CardBody,CardActionsRow}from'components/Card';import{formatDateString}from'util/dates';import ContentError from'components/ContentError';import ContentLoading from'components/ContentLoading';import{Detail,DetailList}from'components/DetailList';import StatusLabel from'components/StatusLabel';import useRequest,{useDismissableError}from'hooks/useRequest';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";var Unavailable=styled.span(_templateObject||(_templateObject=_taggedTemplateLiteral([\"\\n  color: var(--pf-global--danger-color--200);\\n\"])));var SliderHolder=styled.div(_templateObject2||(_templateObject2=_taggedTemplateLiteral([\"\\n  display: flex;\\n  align-items: center;\\n  justify-content: space-between;\\n\"])));var SliderForks=styled.div(_templateObject3||(_templateObject3=_taggedTemplateLiteral([\"\\n  flex-grow: 1;\\n  margin-right: 8px;\\n  margin-left: 8px;\\n  text-align: center;\\n\"])));function computeForks(memCapacity,cpuCapacity,selectedCapacityAdjustment){var minCapacity=Math.min(memCapacity,cpuCapacity);var maxCapacity=Math.max(memCapacity,cpuCapacity);return Math.floor(minCapacity+(maxCapacity-minCapacity)*selectedCapacityAdjustment);}function InstanceDetail(_ref){var setBreadcrumb=_ref.setBreadcrumb;var _useConfig=useConfig(),_useConfig$me=_useConfig.me,me=_useConfig$me===void 0?{}:_useConfig$me;var _useParams=useParams(),id=_useParams.id;var _useState=useState(),_useState2=_slicedToArray(_useState,2),forks=_useState2[0],setForks=_useState2[1];var _useState3=useState({}),_useState4=_slicedToArray(_useState3,2),healthCheck=_useState4[0],setHealthCheck=_useState4[1];var _useRequest=useRequest(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _yield$InstancesAPI$r,details,_yield$InstancesAPI$r2,healthCheckData;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return InstancesAPI.readDetail(id);case 2:_yield$InstancesAPI$r=_context.sent;details=_yield$InstancesAPI$r.data;if(!(details.node_type!=='hop')){_context.next=10;break;}_context.next=7;return InstancesAPI.readHealthCheckDetail(id);case 7:_yield$InstancesAPI$r2=_context.sent;healthCheckData=_yield$InstancesAPI$r2.data;setHealthCheck(healthCheckData);case 10:setForks(computeForks(details.mem_capacity,details.cpu_capacity,details.capacity_adjustment));return _context.abrupt(\"return\",details);case 12:case\"end\":return _context.stop();}}},_callee);})),[id]),{}),isLoading=_useRequest.isLoading,contentError=_useRequest.error,fetchDetails=_useRequest.request,instance=_useRequest.result;useEffect(function(){fetchDetails();},[fetchDetails]);useEffect(function(){if(instance){setBreadcrumb(instance);}},[instance,setBreadcrumb]);var _useRequest2=useRequest(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var _yield$InstancesAPI$h,data;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return InstancesAPI.healthCheck(id);case 2:_yield$InstancesAPI$h=_context2.sent;data=_yield$InstancesAPI$h.data;setHealthCheck(data);case 5:case\"end\":return _context2.stop();}}},_callee2);})),[id])),healthCheckError=_useRequest2.error,isRunningHealthCheck=_useRequest2.isLoading,fetchHealthCheck=_useRequest2.request;var _useRequest3=useRequest(useCallback(/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(values){return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return InstancesAPI.update(id,values);case 2:case\"end\":return _context3.stop();}}},_callee3);}));return function(_x){return _ref4.apply(this,arguments);};}(),[id])),updateInstanceError=_useRequest3.error,updateInstance=_useRequest3.request;var debounceUpdateInstance=useDebounce(updateInstance,200);var handleChangeValue=function handleChangeValue(value){var roundedValue=Math.round(value*100)/100;setForks(computeForks(instance.mem_capacity,instance.cpu_capacity,roundedValue));debounceUpdateInstance({capacity_adjustment:roundedValue});};var _useDismissableError=useDismissableError(updateInstanceError||healthCheckError),error=_useDismissableError.error,dismissError=_useDismissableError.dismissError;if(contentError){return/*#__PURE__*/_jsx(ContentError,{error:contentError});}if(isLoading){return/*#__PURE__*/_jsx(ContentLoading,{});}var isHopNode=instance.node_type==='hop';return/*#__PURE__*/_jsxs(CardBody,{children:[/*#__PURE__*/_jsxs(DetailList,{gutter:\"sm\",children:[/*#__PURE__*/_jsx(Detail,{label:/*i18n*/i18n._(\"Host Name\"),value:instance.hostname,dataCy:\"instance-detail-name\"}),/*#__PURE__*/_jsx(Detail,{label:/*i18n*/i18n._(\"Status\"),value:/*#__PURE__*/_jsx(StatusLabel,{status:healthCheck!==null&&healthCheck!==void 0&&healthCheck.errors?'error':'healthy'})}),/*#__PURE__*/_jsx(Detail,{label:/*i18n*/i18n._(\"Node Type\"),value:instance.node_type}),!isHopNode&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Detail,{label:/*i18n*/i18n._(\"Policy Type\"),value:instance.managed_by_policy?/*i18n*/i18n._(\"Auto\"):/*i18n*/i18n._(\"Manual\")}),/*#__PURE__*/_jsx(Detail,{label:/*i18n*/i18n._(\"Running Jobs\"),value:instance.jobs_running}),/*#__PURE__*/_jsx(Detail,{label:/*i18n*/i18n._(\"Total Jobs\"),value:instance.jobs_total}),/*#__PURE__*/_jsx(Detail,{label:/*i18n*/i18n._(\"Last Health Check\"),value:formatDateString(healthCheck===null||healthCheck===void 0?void 0:healthCheck.last_health_check)}),/*#__PURE__*/_jsx(Detail,{label:/*i18n*/i18n._(\"Capacity Adjustment\"),value:/*#__PURE__*/_jsxs(SliderHolder,{\"data-cy\":\"slider-holder\",children:[/*#__PURE__*/_jsx(\"div\",{\"data-cy\":\"cpu-capacity\",children:/*i18n*/i18n._(\"CPU {0}\",{0:instance.cpu_capacity})}),/*#__PURE__*/_jsxs(SliderForks,{\"data-cy\":\"slider-forks\",children:[/*#__PURE__*/_jsx(\"div\",{\"data-cy\":\"number-forks\",children:/*#__PURE__*/_jsx(Trans,{id:\"{forks, plural, one {# fork} other {# forks}}\",values:{forks:forks}})}),/*#__PURE__*/_jsx(Slider,{areCustomStepsContinuous:true,max:1,min:0,step:0.1,value:instance.capacity_adjustment,onChange:handleChangeValue,isDisabled:!(me!==null&&me!==void 0&&me.is_superuser)||!instance.enabled,\"data-cy\":\"slider\"})]}),/*#__PURE__*/_jsx(\"div\",{\"data-cy\":\"mem-capacity\",children:/*i18n*/i18n._(\"RAM {0}\",{0:instance.mem_capacity})})]})}),/*#__PURE__*/_jsx(Detail,{label:/*i18n*/i18n._(\"Used Capacity\"),value:instance.enabled?/*#__PURE__*/_jsx(Progress,{title:/*i18n*/i18n._(\"Used capacity\"),value:Math.round(100-instance.percent_capacity_remaining),measureLocation:ProgressMeasureLocation.top,size:ProgressSize.sm,\"aria-label\":/*i18n*/i18n._(\"Used capacity\")}):/*#__PURE__*/_jsx(Unavailable,{children:/*i18n*/i18n._(\"Unavailable\")})})]}),(healthCheck===null||healthCheck===void 0?void 0:healthCheck.errors)&&/*#__PURE__*/_jsx(Detail,{fullWidth:true,label:/*i18n*/i18n._(\"Errors\"),value:/*#__PURE__*/_jsx(CodeBlock,{children:/*#__PURE__*/_jsx(CodeBlockCode,{children:healthCheck===null||healthCheck===void 0?void 0:healthCheck.errors})})})]}),!isHopNode&&/*#__PURE__*/_jsxs(CardActionsRow,{children:[/*#__PURE__*/_jsx(Tooltip,{content:/*i18n*/i18n._(\"Run a health check on the instance\"),children:/*#__PURE__*/_jsx(Button,{isDisabled:!me.is_superuser||isRunningHealthCheck,variant:\"primary\",ouiaId:\"health-check-button\",onClick:fetchHealthCheck,isLoading:isRunningHealthCheck,spinnerAriaLabel:/*i18n*/i18n._(\"Running health check\"),children:/*i18n*/i18n._(\"Run health check\")})}),/*#__PURE__*/_jsx(InstanceToggle,{css:\"display: inline-flex;\",fetchInstances:fetchDetails,instance:instance})]}),error&&/*#__PURE__*/_jsxs(AlertModal,{isOpen:error,onClose:dismissError,title:/*i18n*/i18n._(\"Error!\"),variant:\"error\",children:[updateInstanceError?/*i18n*/i18n._(\"Failed to update capacity adjustment.\"):/*i18n*/i18n._(\"Failed to disassociate one or more instances.\"),/*#__PURE__*/_jsx(ErrorDetail,{error:error})]})]});}export default InstanceDetail;","map":{"version":3,"sources":["/awx_devel/awx/ui/src/screens/Instances/InstanceDetail/InstanceDetail.js"],"names":["React","useCallback","useEffect","useState","useParams","Button","Progress","ProgressMeasureLocation","ProgressSize","CodeBlock","CodeBlockCode","Tooltip","Slider","styled","useConfig","InstancesAPI","useDebounce","AlertModal","ErrorDetail","InstanceToggle","CardBody","CardActionsRow","formatDateString","ContentError","ContentLoading","Detail","DetailList","StatusLabel","useRequest","useDismissableError","Unavailable","span","SliderHolder","div","SliderForks","computeForks","memCapacity","cpuCapacity","selectedCapacityAdjustment","minCapacity","Math","min","maxCapacity","max","floor","InstanceDetail","setBreadcrumb","me","id","forks","setForks","healthCheck","setHealthCheck","readDetail","details","data","node_type","readHealthCheckDetail","healthCheckData","mem_capacity","cpu_capacity","capacity_adjustment","isLoading","contentError","error","fetchDetails","request","instance","result","healthCheckError","isRunningHealthCheck","fetchHealthCheck","values","update","updateInstanceError","updateInstance","debounceUpdateInstance","handleChangeValue","value","roundedValue","round","dismissError","isHopNode","hostname","errors","managed_by_policy","jobs_running","jobs_total","last_health_check","is_superuser","enabled","percent_capacity_remaining","top","sm"],"mappings":"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","sourcesContent":["import React, { useCallback, useEffect, useState } from 'react';\n\nimport { useParams } from 'react-router-dom';\nimport { t, Plural } from '@lingui/macro';\nimport {\n  Button,\n  Progress,\n  ProgressMeasureLocation,\n  ProgressSize,\n  CodeBlock,\n  CodeBlockCode,\n  Tooltip,\n  Slider,\n} from '@patternfly/react-core';\nimport styled from 'styled-components';\n\nimport { useConfig } from 'contexts/Config';\nimport { InstancesAPI } from 'api';\nimport useDebounce from 'hooks/useDebounce';\nimport AlertModal from 'components/AlertModal';\nimport ErrorDetail from 'components/ErrorDetail';\nimport InstanceToggle from 'components/InstanceToggle';\nimport { CardBody, CardActionsRow } from 'components/Card';\nimport { formatDateString } from 'util/dates';\nimport ContentError from 'components/ContentError';\nimport ContentLoading from 'components/ContentLoading';\nimport { Detail, DetailList } from 'components/DetailList';\nimport StatusLabel from 'components/StatusLabel';\nimport useRequest, { useDismissableError } from 'hooks/useRequest';\n\nconst Unavailable = styled.span`\n  color: var(--pf-global--danger-color--200);\n`;\n\nconst SliderHolder = styled.div`\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n`;\n\nconst SliderForks = styled.div`\n  flex-grow: 1;\n  margin-right: 8px;\n  margin-left: 8px;\n  text-align: center;\n`;\n\nfunction computeForks(memCapacity, cpuCapacity, selectedCapacityAdjustment) {\n  const minCapacity = Math.min(memCapacity, cpuCapacity);\n  const maxCapacity = Math.max(memCapacity, cpuCapacity);\n\n  return Math.floor(\n    minCapacity + (maxCapacity - minCapacity) * selectedCapacityAdjustment\n  );\n}\n\nfunction InstanceDetail({ setBreadcrumb }) {\n  const { me = {} } = useConfig();\n  const { id } = useParams();\n  const [forks, setForks] = useState();\n\n  const [healthCheck, setHealthCheck] = useState({});\n\n  const {\n    isLoading,\n    error: contentError,\n    request: fetchDetails,\n    result: instance,\n  } = useRequest(\n    useCallback(async () => {\n      const { data: details } = await InstancesAPI.readDetail(id);\n\n      if (details.node_type !== 'hop') {\n        const { data: healthCheckData } =\n          await InstancesAPI.readHealthCheckDetail(id);\n        setHealthCheck(healthCheckData);\n      }\n\n      setForks(\n        computeForks(\n          details.mem_capacity,\n          details.cpu_capacity,\n          details.capacity_adjustment\n        )\n      );\n      return details;\n    }, [id]),\n    {}\n  );\n  useEffect(() => {\n    fetchDetails();\n  }, [fetchDetails]);\n\n  useEffect(() => {\n    if (instance) {\n      setBreadcrumb(instance);\n    }\n  }, [instance, setBreadcrumb]);\n\n  const {\n    error: healthCheckError,\n    isLoading: isRunningHealthCheck,\n    request: fetchHealthCheck,\n  } = useRequest(\n    useCallback(async () => {\n      const { data } = await InstancesAPI.healthCheck(id);\n      setHealthCheck(data);\n    }, [id])\n  );\n\n  const { error: updateInstanceError, request: updateInstance } = useRequest(\n    useCallback(\n      async (values) => {\n        await InstancesAPI.update(id, values);\n      },\n      [id]\n    )\n  );\n\n  const debounceUpdateInstance = useDebounce(updateInstance, 200);\n\n  const handleChangeValue = (value) => {\n    const roundedValue = Math.round(value * 100) / 100;\n    setForks(\n      computeForks(instance.mem_capacity, instance.cpu_capacity, roundedValue)\n    );\n    debounceUpdateInstance({ capacity_adjustment: roundedValue });\n  };\n\n  const { error, dismissError } = useDismissableError(\n    updateInstanceError || healthCheckError\n  );\n  if (contentError) {\n    return <ContentError error={contentError} />;\n  }\n  if (isLoading) {\n    return <ContentLoading />;\n  }\n  const isHopNode = instance.node_type === 'hop';\n  return (\n    <CardBody>\n      <DetailList gutter=\"sm\">\n        <Detail\n          label={t`Host Name`}\n          value={instance.hostname}\n          dataCy=\"instance-detail-name\"\n        />\n        <Detail\n          label={t`Status`}\n          value={\n            <StatusLabel status={healthCheck?.errors ? 'error' : 'healthy'} />\n          }\n        />\n        <Detail label={t`Node Type`} value={instance.node_type} />\n        {!isHopNode && (\n          <>\n            <Detail\n              label={t`Policy Type`}\n              value={instance.managed_by_policy ? t`Auto` : t`Manual`}\n            />\n            <Detail label={t`Running Jobs`} value={instance.jobs_running} />\n            <Detail label={t`Total Jobs`} value={instance.jobs_total} />\n            <Detail\n              label={t`Last Health Check`}\n              value={formatDateString(healthCheck?.last_health_check)}\n            />\n            <Detail\n              label={t`Capacity Adjustment`}\n              value={\n                <SliderHolder data-cy=\"slider-holder\">\n                  <div data-cy=\"cpu-capacity\">{t`CPU ${instance.cpu_capacity}`}</div>\n                  <SliderForks data-cy=\"slider-forks\">\n                    <div data-cy=\"number-forks\">\n                      <Plural value={forks} one=\"# fork\" other=\"# forks\" />\n                    </div>\n                    <Slider\n                      areCustomStepsContinuous\n                      max={1}\n                      min={0}\n                      step={0.1}\n                      value={instance.capacity_adjustment}\n                      onChange={handleChangeValue}\n                      isDisabled={!me?.is_superuser || !instance.enabled}\n                      data-cy=\"slider\"\n                    />\n                  </SliderForks>\n                  <div data-cy=\"mem-capacity\">{t`RAM ${instance.mem_capacity}`}</div>\n                </SliderHolder>\n              }\n            />\n            <Detail\n              label={t`Used Capacity`}\n              value={\n                instance.enabled ? (\n                  <Progress\n                    title={t`Used capacity`}\n                    value={Math.round(\n                      100 - instance.percent_capacity_remaining\n                    )}\n                    measureLocation={ProgressMeasureLocation.top}\n                    size={ProgressSize.sm}\n                    aria-label={t`Used capacity`}\n                  />\n                ) : (\n                  <Unavailable>{t`Unavailable`}</Unavailable>\n                )\n              }\n            />\n          </>\n        )}\n        {healthCheck?.errors && (\n          <Detail\n            fullWidth\n            label={t`Errors`}\n            value={\n              <CodeBlock>\n                <CodeBlockCode>{healthCheck?.errors}</CodeBlockCode>\n              </CodeBlock>\n            }\n          />\n        )}\n      </DetailList>\n      {!isHopNode && (\n        <CardActionsRow>\n          <Tooltip content={t`Run a health check on the instance`}>\n            <Button\n              isDisabled={!me.is_superuser || isRunningHealthCheck}\n              variant=\"primary\"\n              ouiaId=\"health-check-button\"\n              onClick={fetchHealthCheck}\n              isLoading={isRunningHealthCheck}\n              spinnerAriaLabel={t`Running health check`}\n            >\n              {t`Run health check`}\n            </Button>\n          </Tooltip>\n          <InstanceToggle\n            css=\"display: inline-flex;\"\n            fetchInstances={fetchDetails}\n            instance={instance}\n          />\n        </CardActionsRow>\n      )}\n\n      {error && (\n        <AlertModal\n          isOpen={error}\n          onClose={dismissError}\n          title={t`Error!`}\n          variant=\"error\"\n        >\n          {updateInstanceError\n            ? t`Failed to update capacity adjustment.`\n            : t`Failed to disassociate one or more instances.`}\n          <ErrorDetail error={error} />\n        </AlertModal>\n      )}\n    </CardBody>\n  );\n}\n\nexport default InstanceDetail;\n"]},"metadata":{},"sourceType":"module"}