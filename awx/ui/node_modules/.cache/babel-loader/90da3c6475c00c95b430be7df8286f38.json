{"ast":null,"code":"import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _taggedTemplateLiteral from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/taggedTemplateLiteral.js\";var _templateObject,_templateObject2;import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import React,{useEffect,useReducer}from'react';import styled from'styled-components';import{CardBody as PFCardBody}from'@patternfly/react-core';import{WorkflowDispatchContext,WorkflowStateContext}from'contexts/Workflow';import{layoutGraph}from'components/Workflow/WorkflowUtils';import ContentError from'components/ContentError';import ContentLoading from'components/ContentLoading';import workflowReducer,{initReducer}from'components/Workflow/workflowReducer';import{WorkflowJobsAPI}from'api';import WorkflowOutputGraph from'./WorkflowOutputGraph';import WorkflowOutputToolbar from'./WorkflowOutputToolbar';import useWsWorkflowOutput from'./useWsWorkflowOutput';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var CardBody=styled(PFCardBody)(_templateObject||(_templateObject=_taggedTemplateLiteral([\"\\n  display: flex;\\n  flex-direction: column;\\n  height: calc(100vh - 240px);\\n\"])));var Wrapper=styled.div(_templateObject2||(_templateObject2=_taggedTemplateLiteral([\"\\n  display: flex;\\n  flex-flow: column;\\n  height: 100%;\\n  position: relative;\\n\"])));var fetchWorkflowNodes=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(jobId){var pageNo,nodes,_yield$WorkflowJobsAP,data,_args=arguments;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:pageNo=_args.length>1&&_args[1]!==undefined?_args[1]:1;nodes=_args.length>2&&_args[2]!==undefined?_args[2]:[];_context.next=4;return WorkflowJobsAPI.readNodes(jobId,{page_size:200,page:pageNo});case 4:_yield$WorkflowJobsAP=_context.sent;data=_yield$WorkflowJobsAP.data;if(!data.next){_context.next=8;break;}return _context.abrupt(\"return\",fetchWorkflowNodes(jobId,pageNo+1,nodes.concat(data.results)));case 8:return _context.abrupt(\"return\",nodes.concat(data.results));case 9:case\"end\":return _context.stop();}}},_callee);}));return function fetchWorkflowNodes(_x){return _ref.apply(this,arguments);};}();function WorkflowOutput(_ref2){var job=_ref2.job;var _useReducer=useReducer(workflowReducer,{},initReducer),_useReducer2=_slicedToArray(_useReducer,2),state=_useReducer2[0],dispatch=_useReducer2[1];var contentError=state.contentError,isLoading=state.isLoading,links=state.links,nodePositions=state.nodePositions,nodes=state.nodes;useEffect(function(){function fetchData(){return _fetchData.apply(this,arguments);}function _fetchData(){_fetchData=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var workflowNodes;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;_context2.next=3;return fetchWorkflowNodes(job.id);case 3:workflowNodes=_context2.sent;dispatch({type:'GENERATE_NODES_AND_LINKS',nodes:workflowNodes});_context2.next=10;break;case 7:_context2.prev=7;_context2.t0=_context2[\"catch\"](0);dispatch({type:'SET_CONTENT_ERROR',value:_context2.t0});case 10:_context2.prev=10;dispatch({type:'SET_IS_LOADING',value:false});return _context2.finish(10);case 13:case\"end\":return _context2.stop();}}},_callee2,null,[[0,7,10,13]]);}));return _fetchData.apply(this,arguments);}dispatch({type:'RESET'});fetchData();},[job.id]);// Update positions of nodes/links\nuseEffect(function(){if(nodes){var newNodePositions={};var g=layoutGraph(nodes,links);g.nodes().forEach(function(node){newNodePositions[node]=g.node(node);});dispatch({type:'SET_NODE_POSITIONS',value:newNodePositions});}},[job.id,links,nodes]);var updatedNodes=useWsWorkflowOutput(job.id,nodes);useEffect(function(){dispatch({type:'SET_NODES',value:updatedNodes});},[updatedNodes]);if(isLoading){return/*#__PURE__*/_jsx(CardBody,{children:/*#__PURE__*/_jsx(ContentLoading,{})});}if(contentError){return/*#__PURE__*/_jsx(CardBody,{children:/*#__PURE__*/_jsx(ContentError,{error:contentError})});}return/*#__PURE__*/_jsx(WorkflowStateContext.Provider,{value:state,children:/*#__PURE__*/_jsx(WorkflowDispatchContext.Provider,{value:dispatch,children:/*#__PURE__*/_jsx(CardBody,{children:/*#__PURE__*/_jsxs(Wrapper,{children:[/*#__PURE__*/_jsx(WorkflowOutputToolbar,{job:job}),nodePositions&&/*#__PURE__*/_jsx(WorkflowOutputGraph,{})]})})})});}export default WorkflowOutput;","map":{"version":3,"sources":["/awx_devel/awx/ui/src/screens/Job/WorkflowOutput/WorkflowOutput.js"],"names":["React","useEffect","useReducer","styled","CardBody","PFCardBody","WorkflowDispatchContext","WorkflowStateContext","layoutGraph","ContentError","ContentLoading","workflowReducer","initReducer","WorkflowJobsAPI","WorkflowOutputGraph","WorkflowOutputToolbar","useWsWorkflowOutput","Wrapper","div","fetchWorkflowNodes","jobId","pageNo","nodes","readNodes","page_size","page","data","next","concat","results","WorkflowOutput","job","state","dispatch","contentError","isLoading","links","nodePositions","fetchData","id","workflowNodes","type","value","newNodePositions","g","forEach","node","updatedNodes"],"mappings":"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","sourcesContent":["import React, { useEffect, useReducer } from 'react';\n\nimport styled from 'styled-components';\nimport { shape } from 'prop-types';\nimport { CardBody as PFCardBody } from '@patternfly/react-core';\nimport {\n  WorkflowDispatchContext,\n  WorkflowStateContext,\n} from 'contexts/Workflow';\nimport { layoutGraph } from 'components/Workflow/WorkflowUtils';\nimport ContentError from 'components/ContentError';\nimport ContentLoading from 'components/ContentLoading';\nimport workflowReducer, {\n  initReducer,\n} from 'components/Workflow/workflowReducer';\nimport { WorkflowJobsAPI } from 'api';\nimport WorkflowOutputGraph from './WorkflowOutputGraph';\nimport WorkflowOutputToolbar from './WorkflowOutputToolbar';\nimport useWsWorkflowOutput from './useWsWorkflowOutput';\n\nconst CardBody = styled(PFCardBody)`\n  display: flex;\n  flex-direction: column;\n  height: calc(100vh - 240px);\n`;\n\nconst Wrapper = styled.div`\n  display: flex;\n  flex-flow: column;\n  height: 100%;\n  position: relative;\n`;\n\nconst fetchWorkflowNodes = async (jobId, pageNo = 1, nodes = []) => {\n  const { data } = await WorkflowJobsAPI.readNodes(jobId, {\n    page_size: 200,\n    page: pageNo,\n  });\n\n  if (data.next) {\n    return fetchWorkflowNodes(jobId, pageNo + 1, nodes.concat(data.results));\n  }\n  return nodes.concat(data.results);\n};\n\nfunction WorkflowOutput({ job }) {\n  const [state, dispatch] = useReducer(workflowReducer, {}, initReducer);\n  const { contentError, isLoading, links, nodePositions, nodes } = state;\n\n  useEffect(() => {\n    async function fetchData() {\n      try {\n        const workflowNodes = await fetchWorkflowNodes(job.id);\n        dispatch({\n          type: 'GENERATE_NODES_AND_LINKS',\n          nodes: workflowNodes,\n        });\n      } catch (error) {\n        dispatch({ type: 'SET_CONTENT_ERROR', value: error });\n      } finally {\n        dispatch({ type: 'SET_IS_LOADING', value: false });\n      }\n    }\n    dispatch({ type: 'RESET' });\n    fetchData();\n  }, [job.id]);\n\n  // Update positions of nodes/links\n  useEffect(() => {\n    if (nodes) {\n      const newNodePositions = {};\n      const g = layoutGraph(nodes, links);\n\n      g.nodes().forEach((node) => {\n        newNodePositions[node] = g.node(node);\n      });\n\n      dispatch({ type: 'SET_NODE_POSITIONS', value: newNodePositions });\n    }\n  }, [job.id, links, nodes]);\n\n  const updatedNodes = useWsWorkflowOutput(job.id, nodes);\n\n  useEffect(() => {\n    dispatch({ type: 'SET_NODES', value: updatedNodes });\n  }, [updatedNodes]);\n\n  if (isLoading) {\n    return (\n      <CardBody>\n        <ContentLoading />\n      </CardBody>\n    );\n  }\n\n  if (contentError) {\n    return (\n      <CardBody>\n        <ContentError error={contentError} />\n      </CardBody>\n    );\n  }\n\n  return (\n    <WorkflowStateContext.Provider value={state}>\n      <WorkflowDispatchContext.Provider value={dispatch}>\n        <CardBody>\n          <Wrapper>\n            <WorkflowOutputToolbar job={job} />\n            {nodePositions && <WorkflowOutputGraph />}\n          </Wrapper>\n        </CardBody>\n      </WorkflowDispatchContext.Provider>\n    </WorkflowStateContext.Provider>\n  );\n}\n\nWorkflowOutput.propTypes = {\n  job: shape().isRequired,\n};\n\nexport default WorkflowOutput;\n"]},"metadata":{},"sourceType":"module"}