{"ast":null,"code":"import _createForOfIteratorHelper from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _toConsumableArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _objectSpread from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _objectWithoutProperties from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js\";import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";var _excluded=[\"labels\",\"instanceGroups\",\"initialInstanceGroups\",\"inventory\",\"project\",\"credentials\",\"webhook_credential\",\"webhook_key\",\"webhook_url\"];import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import React,{useState}from'react';import{useHistory}from'react-router-dom';import{Card,PageSection}from'@patternfly/react-core';import{CardBody}from'components/Card';import{JobTemplatesAPI,OrganizationsAPI}from'api';import JobTemplateForm from'../shared/JobTemplateForm';import{jsx as _jsx}from\"react/jsx-runtime\";function JobTemplateAdd(){var _useState=useState(null),_useState2=_slicedToArray(_useState,2),formSubmitError=_useState2[0],setFormSubmitError=_useState2[1];var history=useHistory();var projectParams={project_id:null,project_name:null};history.location.search.replace(/^\\?/,'').split('&').map(function(s){return s.split('=');}).forEach(function(_ref){var _ref2=_slicedToArray(_ref,2),key=_ref2[0],val=_ref2[1];if(!(key in projectParams)){return;}projectParams[key]=decodeURIComponent(val);});var projectValues=null;if(Object.values(projectParams).filter(function(item){return item!==null;}).length===2){projectValues={id:projectParams.project_id,name:projectParams.project_name};}var handleSubmit=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(values){var labels,instanceGroups,initialInstanceGroups,inventory,project,credentials,webhook_credential,webhook_key,webhook_url,remainingValues,_values$execution_env,_values$project$summa,_yield$JobTemplatesAP,_yield$JobTemplatesAP2,id,type;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:labels=values.labels,instanceGroups=values.instanceGroups,initialInstanceGroups=values.initialInstanceGroups,inventory=values.inventory,project=values.project,credentials=values.credentials,webhook_credential=values.webhook_credential,webhook_key=values.webhook_key,webhook_url=values.webhook_url,remainingValues=_objectWithoutProperties(values,_excluded);setFormSubmitError(null);remainingValues.project=project.id;remainingValues.webhook_credential=webhook_credential===null||webhook_credential===void 0?void 0:webhook_credential.id;remainingValues.inventory=(inventory===null||inventory===void 0?void 0:inventory.id)||null;_context.prev=5;_context.next=8;return JobTemplatesAPI.create(_objectSpread(_objectSpread({},remainingValues),{},{execution_environment:(_values$execution_env=values.execution_environment)===null||_values$execution_env===void 0?void 0:_values$execution_env.id}));case 8:_yield$JobTemplatesAP=_context.sent;_yield$JobTemplatesAP2=_yield$JobTemplatesAP.data;id=_yield$JobTemplatesAP2.id;type=_yield$JobTemplatesAP2.type;_context.next=14;return Promise.all([submitLabels(id,(_values$project$summa=values.project.summary_fields)===null||_values$project$summa===void 0?void 0:_values$project$summa.organization.id,labels),submitInstanceGroups(id,instanceGroups),submitCredentials(id,credentials)]);case 14:history.push(\"/templates/\".concat(type,\"/\").concat(id,\"/details\"));_context.next=20;break;case 17:_context.prev=17;_context.t0=_context[\"catch\"](5);setFormSubmitError(_context.t0);case 20:case\"end\":return _context.stop();}}},_callee,null,[[5,17]]);}));return function handleSubmit(_x){return _ref3.apply(this,arguments);};}();function submitLabels(_x2,_x3){return _submitLabels.apply(this,arguments);}function _submitLabels(){_submitLabels=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(templateId,orgId){var labels,_yield$OrganizationsA,results,associationPromises,_args2=arguments;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:labels=_args2.length>2&&_args2[2]!==undefined?_args2[2]:[];if(orgId){_context2.next=13;break;}_context2.prev=2;_context2.next=5;return OrganizationsAPI.read();case 5:_yield$OrganizationsA=_context2.sent;results=_yield$OrganizationsA.data.results;orgId=results[0].id;_context2.next=13;break;case 10:_context2.prev=10;_context2.t0=_context2[\"catch\"](2);throw _context2.t0;case 13:associationPromises=labels.map(function(label){return JobTemplatesAPI.associateLabel(templateId,label,orgId);});return _context2.abrupt(\"return\",Promise.all(_toConsumableArray(associationPromises)));case 15:case\"end\":return _context2.stop();}}},_callee2,null,[[2,10]]);}));return _submitLabels.apply(this,arguments);}function submitInstanceGroups(_x4){return _submitInstanceGroups.apply(this,arguments);}function _submitInstanceGroups(){_submitInstanceGroups=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(templateId){var addedGroups,_iterator,_step,group,_args3=arguments;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:addedGroups=_args3.length>1&&_args3[1]!==undefined?_args3[1]:[];/* eslint-disable no-await-in-loop, no-restricted-syntax */ // Resolve Promises sequentially to maintain order and avoid race condition\n_iterator=_createForOfIteratorHelper(addedGroups);_context3.prev=2;_iterator.s();case 4:if((_step=_iterator.n()).done){_context3.next=10;break;}group=_step.value;_context3.next=8;return JobTemplatesAPI.associateInstanceGroup(templateId,group.id);case 8:_context3.next=4;break;case 10:_context3.next=15;break;case 12:_context3.prev=12;_context3.t0=_context3[\"catch\"](2);_iterator.e(_context3.t0);case 15:_context3.prev=15;_iterator.f();return _context3.finish(15);case 18:case\"end\":return _context3.stop();}}},_callee3,null,[[2,12,15,18]]);}));return _submitInstanceGroups.apply(this,arguments);}function submitCredentials(templateId){var credentials=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var associateCredentials=credentials.map(function(cred){return JobTemplatesAPI.associateCredentials(templateId,cred.id);});return Promise.all(associateCredentials);}var handleCancel=function handleCancel(){history.push(\"/templates\");};return/*#__PURE__*/_jsx(PageSection,{children:/*#__PURE__*/_jsx(Card,{children:/*#__PURE__*/_jsx(CardBody,{children:/*#__PURE__*/_jsx(JobTemplateForm,{handleCancel:handleCancel,handleSubmit:handleSubmit,submitError:formSubmitError,projectValues:projectValues,isOverrideDisabledLookup:true})})})});}export default JobTemplateAdd;","map":{"version":3,"sources":["/awx_devel/awx/ui/src/screens/Template/JobTemplateAdd/JobTemplateAdd.js"],"names":["React","useState","useHistory","Card","PageSection","CardBody","JobTemplatesAPI","OrganizationsAPI","JobTemplateForm","JobTemplateAdd","formSubmitError","setFormSubmitError","history","projectParams","project_id","project_name","location","search","replace","split","map","s","forEach","key","val","decodeURIComponent","projectValues","Object","values","filter","item","length","id","name","handleSubmit","labels","instanceGroups","initialInstanceGroups","inventory","project","credentials","webhook_credential","webhook_key","webhook_url","remainingValues","create","execution_environment","data","type","Promise","all","submitLabels","summary_fields","organization","submitInstanceGroups","submitCredentials","push","templateId","orgId","read","results","associationPromises","label","associateLabel","addedGroups","group","associateInstanceGroup","associateCredentials","cred","handleCancel"],"mappings":"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","sourcesContent":["import React, { useState } from 'react';\nimport { useHistory } from 'react-router-dom';\nimport { Card, PageSection } from '@patternfly/react-core';\nimport { CardBody } from 'components/Card';\nimport { JobTemplatesAPI, OrganizationsAPI } from 'api';\nimport JobTemplateForm from '../shared/JobTemplateForm';\n\nfunction JobTemplateAdd() {\n  const [formSubmitError, setFormSubmitError] = useState(null);\n  const history = useHistory();\n\n  const projectParams = {\n    project_id: null,\n    project_name: null,\n  };\n  history.location.search\n    .replace(/^\\?/, '')\n    .split('&')\n    .map((s) => s.split('='))\n    .forEach(([key, val]) => {\n      if (!(key in projectParams)) {\n        return;\n      }\n      projectParams[key] = decodeURIComponent(val);\n    });\n\n  let projectValues = null;\n\n  if (\n    Object.values(projectParams).filter((item) => item !== null).length === 2\n  ) {\n    projectValues = {\n      id: projectParams.project_id,\n      name: projectParams.project_name,\n    };\n  }\n\n  const handleSubmit = async (values) => {\n    const {\n      labels,\n      instanceGroups,\n      initialInstanceGroups,\n      inventory,\n      project,\n      credentials,\n      webhook_credential,\n      webhook_key,\n      webhook_url,\n      ...remainingValues\n    } = values;\n\n    setFormSubmitError(null);\n    remainingValues.project = project.id;\n    remainingValues.webhook_credential = webhook_credential?.id;\n    remainingValues.inventory = inventory?.id || null;\n    try {\n      const {\n        data: { id, type },\n      } = await JobTemplatesAPI.create({\n        ...remainingValues,\n        execution_environment: values.execution_environment?.id,\n      });\n      await Promise.all([\n        submitLabels(\n          id,\n          values.project.summary_fields?.organization.id,\n          labels\n        ),\n        submitInstanceGroups(id, instanceGroups),\n        submitCredentials(id, credentials),\n      ]);\n      history.push(`/templates/${type}/${id}/details`);\n    } catch (error) {\n      setFormSubmitError(error);\n    }\n  };\n\n  async function submitLabels(templateId, orgId, labels = []) {\n    if (!orgId) {\n      // eslint-disable-next-line no-useless-catch\n      try {\n        const {\n          data: { results },\n        } = await OrganizationsAPI.read();\n        orgId = results[0].id;\n      } catch (err) {\n        throw err;\n      }\n    }\n    const associationPromises = labels.map((label) =>\n      JobTemplatesAPI.associateLabel(templateId, label, orgId)\n    );\n\n    return Promise.all([...associationPromises]);\n  }\n\n  async function submitInstanceGroups(templateId, addedGroups = []) {\n    /* eslint-disable no-await-in-loop, no-restricted-syntax */\n    // Resolve Promises sequentially to maintain order and avoid race condition\n    for (const group of addedGroups) {\n      await JobTemplatesAPI.associateInstanceGroup(templateId, group.id);\n    }\n    /* eslint-enable no-await-in-loop, no-restricted-syntax */\n  }\n\n  function submitCredentials(templateId, credentials = []) {\n    const associateCredentials = credentials.map((cred) =>\n      JobTemplatesAPI.associateCredentials(templateId, cred.id)\n    );\n    return Promise.all(associateCredentials);\n  }\n\n  const handleCancel = () => {\n    history.push(`/templates`);\n  };\n\n  return (\n    <PageSection>\n      <Card>\n        <CardBody>\n          <JobTemplateForm\n            handleCancel={handleCancel}\n            handleSubmit={handleSubmit}\n            submitError={formSubmitError}\n            projectValues={projectValues}\n            isOverrideDisabledLookup\n          />\n        </CardBody>\n      </Card>\n    </PageSection>\n  );\n}\n\nexport default JobTemplateAdd;\n"]},"metadata":{},"sourceType":"module"}