{"ast":null,"code":"import _objectSpread from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _styled3 from\"styled-components\";import _styled2 from\"styled-components\";import _styled from\"styled-components\";import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import{i18n}from\"@lingui/core\";import React,{useState,useCallback,useEffect}from'react';import{useHistory}from'react-router-dom';import{useField}from'formik';import styled from'styled-components';import{Alert,ToolbarItem}from'@patternfly/react-core';import{CredentialsAPI,CredentialTypesAPI}from'api';import{getSearchableKeys}from'components/PaginatedTable';import{getQSConfig,parseQueryString}from'util/qs';import useRequest from'hooks/useRequest';import AnsibleSelect from'../../AnsibleSelect';import OptionsList from'../../OptionsList';import ContentLoading from'../../ContentLoading';import CredentialChip from'../../CredentialChip';import ContentError from'../../ContentError';import credentialsValidator from'./credentialsValidator';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";var CredentialErrorAlert=styled(Alert).withConfig({displayName:\"CredentialsStep__CredentialErrorAlert\",componentId:\"l9bcve-0\"})([\"margin-bottom:20px;\"]);var QS_CONFIG=getQSConfig('credential',{page:1,page_size:5,order_by:'name'});var _StyledToolbarItem=styled(ToolbarItem).withConfig({displayName:\"CredentialsStep___StyledToolbarItem\",componentId:\"l9bcve-1\"})([\" display:flex;align-items:center;\"]);var _StyledDiv=styled(\"div\").withConfig({displayName:\"CredentialsStep___StyledDiv\",componentId:\"l9bcve-2\"})([\"flex:0 0 25%;margin-right:32px\"]);var _StyledAnsibleSelect=styled(AnsibleSelect).withConfig({displayName:\"CredentialsStep___StyledAnsibleSelect\",componentId:\"l9bcve-3\"})([\"flex:1 1 75%;\"]);function CredentialsStep(_ref){var allowCredentialsWithPasswords=_ref.allowCredentialsWithPasswords,_ref$defaultCredentia=_ref.defaultCredentials,defaultCredentials=_ref$defaultCredentia===void 0?[]:_ref$defaultCredentia;var _useField=useField({name:'credentials',validate:function validate(val){return credentialsValidator(allowCredentialsWithPasswords,val,defaultCredentials);}}),_useField2=_slicedToArray(_useField,3),field=_useField2[0],meta=_useField2[1],helpers=_useField2[2];var _useState=useState(null),_useState2=_slicedToArray(_useState,2),selectedType=_useState2[0],setSelectedType=_useState2[1];var history=useHistory();var _useRequest=useRequest(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var loadedTypes,match;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return CredentialTypesAPI.loadAllTypes();case 2:loadedTypes=_context.sent;if(loadedTypes.length){match=loadedTypes.find(function(type){return type.kind==='ssh';})||loadedTypes[0];setSelectedType(match);}return _context.abrupt(\"return\",loadedTypes);case 5:case\"end\":return _context.stop();}}},_callee);})),[]),[]),types=_useRequest.result,typesError=_useRequest.error,isTypesLoading=_useRequest.isLoading,fetchTypes=_useRequest.request;useEffect(function(){fetchTypes();},[fetchTypes]);var _useRequest2=useRequest(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var _actionsResponse$data,_actionsResponse$data2;var params,_yield$Promise$all,_yield$Promise$all2,data,actionsResponse;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(selectedType){_context2.next=2;break;}return _context2.abrupt(\"return\",{credentials:[],count:0});case 2:params=parseQueryString(QS_CONFIG,history.location.search);_context2.next=5;return Promise.all([CredentialsAPI.read(_objectSpread(_objectSpread({},params),{},{credential_type:selectedType.id})),CredentialsAPI.readOptions()]);case 5:_yield$Promise$all=_context2.sent;_yield$Promise$all2=_slicedToArray(_yield$Promise$all,2);data=_yield$Promise$all2[0].data;actionsResponse=_yield$Promise$all2[1];return _context2.abrupt(\"return\",{credentials:data.results,count:data.count,relatedSearchableKeys:((actionsResponse===null||actionsResponse===void 0?void 0:(_actionsResponse$data=actionsResponse.data)===null||_actionsResponse$data===void 0?void 0:_actionsResponse$data.related_search_fields)||[]).map(function(val){return val.slice(0,-8);}),searchableKeys:getSearchableKeys((_actionsResponse$data2=actionsResponse.data.actions)===null||_actionsResponse$data2===void 0?void 0:_actionsResponse$data2.GET)});case 10:case\"end\":return _context2.stop();}}},_callee2);})),[selectedType,history.location.search]),{credentials:[],count:0,relatedSearchableKeys:[],searchableKeys:[]}),_useRequest2$result=_useRequest2.result,credentials=_useRequest2$result.credentials,count=_useRequest2$result.count,relatedSearchableKeys=_useRequest2$result.relatedSearchableKeys,searchableKeys=_useRequest2$result.searchableKeys,credentialsError=_useRequest2.error,isCredentialsLoading=_useRequest2.isLoading,fetchCredentials=_useRequest2.request;useEffect(function(){fetchCredentials();},[fetchCredentials]);useEffect(function(){helpers.setError(credentialsValidator(allowCredentialsWithPasswords,field.value,defaultCredentials));/* eslint-disable-next-line react-hooks/exhaustive-deps */},[]);if(isTypesLoading){return/*#__PURE__*/_jsx(ContentLoading,{});}if(typesError||credentialsError){return/*#__PURE__*/_jsx(ContentError,{error:typesError||credentialsError});}var isVault=(selectedType===null||selectedType===void 0?void 0:selectedType.kind)==='vault';var renderChip=function renderChip(_ref4){var item=_ref4.item,removeItem=_ref4.removeItem,canDelete=_ref4.canDelete;return/*#__PURE__*/_jsx(CredentialChip,{id:\"credential-chip-\".concat(item.id),onClick:function onClick(){return removeItem(item);},isReadOnly:!canDelete,credential:item,ouiaId:\"credential-chip-\".concat(item.id)},item.id);};return/*#__PURE__*/_jsxs(_Fragment,{children:[meta.error&&/*#__PURE__*/_jsx(CredentialErrorAlert,{variant:\"danger\",isInline:true,title:meta.error}),types&&types.length>0&&/*#__PURE__*/_jsxs(_StyledToolbarItem,{children:[/*#__PURE__*/_jsx(_StyledDiv,{children:/*i18n*/i18n._(\"Selected Category\")}),/*#__PURE__*/_jsx(_StyledAnsibleSelect,{id:\"multiCredentialsLookUp-select\",label:/*i18n*/i18n._(\"Selected Category\"),data:types.map(function(type){return{key:type.id,value:type.id,label:type.name,isDisabled:false};}),value:selectedType&&selectedType.id,onChange:function onChange(e,id){setSelectedType(types.find(function(o){return o.id===parseInt(id,10);}));}})]}),/*#__PURE__*/_jsx(OptionsList,{isLoading:isCredentialsLoading,value:field.value||[],options:credentials,optionCount:count,searchColumns:[{name:/*i18n*/i18n._(\"Name\"),key:'name__icontains',isDefault:true},{name:/*i18n*/i18n._(\"Created By (Username)\"),key:'created_by__username__icontains'},{name:/*i18n*/i18n._(\"Modified By (Username)\"),key:'modified_by__username__icontains'}],sortColumns:[{name:/*i18n*/i18n._(\"Name\"),key:'name'}],searchableKeys:searchableKeys,relatedSearchableKeys:relatedSearchableKeys,multiple:isVault,header:/*i18n*/i18n._(\"Credentials\"),name:\"credentials\",qsConfig:QS_CONFIG,readOnly:false,selectItem:function selectItem(item){var hasSameVaultID=function hasSameVaultID(val){var _val$inputs,_val$inputs2,_item$inputs;return(val===null||val===void 0?void 0:(_val$inputs=val.inputs)===null||_val$inputs===void 0?void 0:_val$inputs.vault_id)!==undefined&&(val===null||val===void 0?void 0:(_val$inputs2=val.inputs)===null||_val$inputs2===void 0?void 0:_val$inputs2.vault_id)===(item===null||item===void 0?void 0:(_item$inputs=item.inputs)===null||_item$inputs===void 0?void 0:_item$inputs.vault_id);};var hasSameCredentialType=function hasSameCredentialType(val){return val.credential_type===item.credential_type;};var newItems=field.value.filter(function(i){return isVault?!hasSameVaultID(i):!hasSameCredentialType(i);});newItems.push(item);helpers.setValue(newItems);},deselectItem:function deselectItem(item){helpers.setValue(field.value.filter(function(i){return i.id!==item.id;}));},renderItemChip:renderChip})]});}export default CredentialsStep;","map":{"version":3,"sources":["/awx_devel/awx/ui/src/components/LaunchPrompt/steps/CredentialsStep.js"],"names":["React","useState","useCallback","useEffect","useHistory","useField","styled","Alert","ToolbarItem","CredentialsAPI","CredentialTypesAPI","getSearchableKeys","getQSConfig","parseQueryString","useRequest","AnsibleSelect","OptionsList","ContentLoading","CredentialChip","ContentError","credentialsValidator","CredentialErrorAlert","QS_CONFIG","page","page_size","order_by","CredentialsStep","allowCredentialsWithPasswords","defaultCredentials","name","validate","val","field","meta","helpers","selectedType","setSelectedType","history","loadAllTypes","loadedTypes","length","match","find","type","kind","types","result","typesError","error","isTypesLoading","isLoading","fetchTypes","request","credentials","count","params","location","search","Promise","all","read","credential_type","id","readOptions","data","actionsResponse","results","relatedSearchableKeys","related_search_fields","map","slice","searchableKeys","actions","GET","credentialsError","isCredentialsLoading","fetchCredentials","setError","value","isVault","renderChip","item","removeItem","canDelete","key","label","isDisabled","e","o","parseInt","isDefault","hasSameVaultID","inputs","vault_id","undefined","hasSameCredentialType","newItems","filter","i","push","setValue"],"mappings":"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","sourcesContent":["import 'styled-components/macro';\nimport React, { useState, useCallback, useEffect } from 'react';\nimport { useHistory } from 'react-router-dom';\n\nimport { t } from '@lingui/macro';\nimport { useField } from 'formik';\nimport styled from 'styled-components';\nimport { Alert, ToolbarItem } from '@patternfly/react-core';\nimport { CredentialsAPI, CredentialTypesAPI } from 'api';\nimport { getSearchableKeys } from 'components/PaginatedTable';\nimport { getQSConfig, parseQueryString } from 'util/qs';\nimport useRequest from 'hooks/useRequest';\nimport AnsibleSelect from '../../AnsibleSelect';\nimport OptionsList from '../../OptionsList';\nimport ContentLoading from '../../ContentLoading';\nimport CredentialChip from '../../CredentialChip';\nimport ContentError from '../../ContentError';\nimport credentialsValidator from './credentialsValidator';\n\nconst CredentialErrorAlert = styled(Alert)`\n  margin-bottom: 20px;\n`;\n\nconst QS_CONFIG = getQSConfig('credential', {\n  page: 1,\n  page_size: 5,\n  order_by: 'name',\n});\n\nfunction CredentialsStep({\n  allowCredentialsWithPasswords,\n  defaultCredentials = [],\n}) {\n  const [field, meta, helpers] = useField({\n    name: 'credentials',\n    validate: (val) =>\n      credentialsValidator(\n        allowCredentialsWithPasswords,\n        val,\n        defaultCredentials\n      ),\n  });\n  const [selectedType, setSelectedType] = useState(null);\n  const history = useHistory();\n\n  const {\n    result: types,\n    error: typesError,\n    isLoading: isTypesLoading,\n    request: fetchTypes,\n  } = useRequest(\n    useCallback(async () => {\n      const loadedTypes = await CredentialTypesAPI.loadAllTypes();\n      if (loadedTypes.length) {\n        const match =\n          loadedTypes.find((type) => type.kind === 'ssh') || loadedTypes[0];\n        setSelectedType(match);\n      }\n      return loadedTypes;\n    }, []),\n    []\n  );\n\n  useEffect(() => {\n    fetchTypes();\n  }, [fetchTypes]);\n\n  const {\n    result: { credentials, count, relatedSearchableKeys, searchableKeys },\n    error: credentialsError,\n    isLoading: isCredentialsLoading,\n    request: fetchCredentials,\n  } = useRequest(\n    useCallback(async () => {\n      if (!selectedType) {\n        return { credentials: [], count: 0 };\n      }\n      const params = parseQueryString(QS_CONFIG, history.location.search);\n      const [{ data }, actionsResponse] = await Promise.all([\n        CredentialsAPI.read({\n          ...params,\n          credential_type: selectedType.id,\n        }),\n        CredentialsAPI.readOptions(),\n      ]);\n      return {\n        credentials: data.results,\n        count: data.count,\n        relatedSearchableKeys: (\n          actionsResponse?.data?.related_search_fields || []\n        ).map((val) => val.slice(0, -8)),\n        searchableKeys: getSearchableKeys(actionsResponse.data.actions?.GET),\n      };\n    }, [selectedType, history.location.search]),\n    { credentials: [], count: 0, relatedSearchableKeys: [], searchableKeys: [] }\n  );\n\n  useEffect(() => {\n    fetchCredentials();\n  }, [fetchCredentials]);\n\n  useEffect(() => {\n    helpers.setError(\n      credentialsValidator(\n        allowCredentialsWithPasswords,\n        field.value,\n        defaultCredentials\n      )\n    );\n    /* eslint-disable-next-line react-hooks/exhaustive-deps */\n  }, []);\n\n  if (isTypesLoading) {\n    return <ContentLoading />;\n  }\n\n  if (typesError || credentialsError) {\n    return <ContentError error={typesError || credentialsError} />;\n  }\n\n  const isVault = selectedType?.kind === 'vault';\n\n  const renderChip = ({ item, removeItem, canDelete }) => (\n    <CredentialChip\n      id={`credential-chip-${item.id}`}\n      key={item.id}\n      onClick={() => removeItem(item)}\n      isReadOnly={!canDelete}\n      credential={item}\n      ouiaId={`credential-chip-${item.id}`}\n    />\n  );\n\n  return (\n    <>\n      {meta.error && (\n        <CredentialErrorAlert variant=\"danger\" isInline title={meta.error} />\n      )}\n      {types && types.length > 0 && (\n        <ToolbarItem css=\" display: flex; align-items: center;\">\n          <div css=\"flex: 0 0 25%; margin-right: 32px\">\n            {t`Selected Category`}\n          </div>\n          <AnsibleSelect\n            css=\"flex: 1 1 75%;\"\n            id=\"multiCredentialsLookUp-select\"\n            label={t`Selected Category`}\n            data={types.map((type) => ({\n              key: type.id,\n              value: type.id,\n              label: type.name,\n              isDisabled: false,\n            }))}\n            value={selectedType && selectedType.id}\n            onChange={(e, id) => {\n              setSelectedType(types.find((o) => o.id === parseInt(id, 10)));\n            }}\n          />\n        </ToolbarItem>\n      )}\n      <OptionsList\n        isLoading={isCredentialsLoading}\n        value={field.value || []}\n        options={credentials}\n        optionCount={count}\n        searchColumns={[\n          {\n            name: t`Name`,\n            key: 'name__icontains',\n            isDefault: true,\n          },\n          {\n            name: t`Created By (Username)`,\n            key: 'created_by__username__icontains',\n          },\n          {\n            name: t`Modified By (Username)`,\n            key: 'modified_by__username__icontains',\n          },\n        ]}\n        sortColumns={[\n          {\n            name: t`Name`,\n            key: 'name',\n          },\n        ]}\n        searchableKeys={searchableKeys}\n        relatedSearchableKeys={relatedSearchableKeys}\n        multiple={isVault}\n        header={t`Credentials`}\n        name=\"credentials\"\n        qsConfig={QS_CONFIG}\n        readOnly={false}\n        selectItem={(item) => {\n          const hasSameVaultID = (val) =>\n            val?.inputs?.vault_id !== undefined &&\n            val?.inputs?.vault_id === item?.inputs?.vault_id;\n          const hasSameCredentialType = (val) =>\n            val.credential_type === item.credential_type;\n          const newItems = field.value.filter((i) =>\n            isVault ? !hasSameVaultID(i) : !hasSameCredentialType(i)\n          );\n          newItems.push(item);\n          helpers.setValue(newItems);\n        }}\n        deselectItem={(item) => {\n          helpers.setValue(field.value.filter((i) => i.id !== item.id));\n        }}\n        renderItemChip={renderChip}\n      />\n    </>\n  );\n}\n\nexport default CredentialsStep;\n"]},"metadata":{},"sourceType":"module"}