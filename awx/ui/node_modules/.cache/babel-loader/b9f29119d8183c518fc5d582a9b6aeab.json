{"ast":null,"code":"import _objectSpread from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _objectWithoutProperties from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js\";import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";var _excluded=[\"credentials\",\"credential_passwords\",\"execution_environment\"];import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import{i18n}from\"@lingui/core\";import React,{useCallback,useEffect,useState,useContext}from'react';import{useHistory,useParams}from'react-router-dom';import{Button,DropdownItem,Tooltip}from'@patternfly/react-core';import useRequest,{useDismissableError}from'hooks/useRequest';import{InventoriesAPI,CredentialTypesAPI}from'api';import{KebabifiedContext}from'contexts/Kebabified';import AlertModal from'../AlertModal';import ErrorDetail from'../ErrorDetail';import AdHocCommandsWizard from'./AdHocCommandsWizard';import ContentError from'../ContentError';import{jsx as _jsx}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";function AdHocCommands(_ref){var adHocItems=_ref.adHocItems,hasListItems=_ref.hasListItems,onLaunchLoading=_ref.onLaunchLoading,moduleOptions=_ref.moduleOptions;var history=useHistory();var _useParams=useParams(),id=_useParams.id;var _useState=useState(false),_useState2=_slicedToArray(_useState,2),isWizardOpen=_useState2[0],setIsWizardOpen=_useState2[1];var _useContext=useContext(KebabifiedContext),isKebabified=_useContext.isKebabified,onKebabModalChange=_useContext.onKebabModalChange;useEffect(function(){if(isKebabified){onKebabModalChange(isWizardOpen);}},[isKebabified,isWizardOpen,onKebabModalChange]);var _useRequest=useRequest(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _yield$Promise$all,_yield$Promise$all2,data,cred;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return Promise.all([InventoriesAPI.readDetail(id),CredentialTypesAPI.read({namespace:'ssh'})]);case 2:_yield$Promise$all=_context.sent;_yield$Promise$all2=_slicedToArray(_yield$Promise$all,2);data=_yield$Promise$all2[0].data;cred=_yield$Promise$all2[1];return _context.abrupt(\"return\",{credentialTypeId:cred.data.results[0].id,organizationId:data.organization});case 7:case\"end\":return _context.stop();}}},_callee);})),[id]),{organizationId:null}),_useRequest$result=_useRequest.result,credentialTypeId=_useRequest$result.credentialTypeId,organizationId=_useRequest$result.organizationId,fetchData=_useRequest.request,fetchError=_useRequest.error;useEffect(function(){fetchData();},[fetchData]);var _useRequest2=useRequest(useCallback(/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(values){var _yield$InventoriesAPI,data;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return InventoriesAPI.launchAdHocCommands(id,values);case 2:_yield$InventoriesAPI=_context2.sent;data=_yield$InventoriesAPI.data;history.push(\"/jobs/command/\".concat(data.id,\"/output\"));case 5:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x){return _ref3.apply(this,arguments);};}(),[id,history])),isLaunchLoading=_useRequest2.isLoading,launchError=_useRequest2.error,launchAdHocCommands=_useRequest2.request;var _useDismissableError=useDismissableError(launchError||fetchError),error=_useDismissableError.error,dismissError=_useDismissableError.dismissError;var handleSubmit=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(values){var _execution_environmen;var credentials,_values$credential_pa,become_password,ssh_password,ssh_key_unlock,execution_environment,remainingValues,newCredential,manipulatedValues;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:credentials=values.credentials,_values$credential_pa=values.credential_passwords,become_password=_values$credential_pa.become_password,ssh_password=_values$credential_pa.ssh_password,ssh_key_unlock=_values$credential_pa.ssh_key_unlock,execution_environment=values.execution_environment,remainingValues=_objectWithoutProperties(values,_excluded);newCredential=credentials[0].id;manipulatedValues=_objectSpread({credential:newCredential,become_password:become_password,ssh_password:ssh_password,ssh_key_unlock:ssh_key_unlock,execution_environment:(_execution_environmen=execution_environment[0])===null||_execution_environmen===void 0?void 0:_execution_environmen.id},remainingValues);_context3.next=5;return launchAdHocCommands(manipulatedValues);case 5:case\"end\":return _context3.stop();}}},_callee3);}));return function handleSubmit(_x2){return _ref4.apply(this,arguments);};}();useEffect(function(){return onLaunchLoading(isLaunchLoading);},[isLaunchLoading,onLaunchLoading]);if(error&&isWizardOpen){return/*#__PURE__*/_jsx(AlertModal,{isOpen:error,variant:\"error\",title:/*i18n*/i18n._(\"Error!\"),onClose:function onClose(){dismissError();setIsWizardOpen(false);},children:launchError?/*#__PURE__*/_jsxs(_Fragment,{children:[/*i18n*/i18n._(\"Failed to launch job.\"),/*#__PURE__*/_jsx(ErrorDetail,{error:error})]}):/*#__PURE__*/_jsx(ContentError,{error:error})});}return/*#__PURE__*/ (// render buttons for drop down and for toolbar\n// if modal is open render the modal\n_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Tooltip,{content:/*i18n*/i18n._(\"Run ad hoc command\"),children:isKebabified?/*#__PURE__*/_jsx(DropdownItem,{isDisabled:!hasListItems,component:\"button\",\"aria-label\":/*i18n*/i18n._(\"Run Command\"),onClick:function onClick(){return setIsWizardOpen(true);},ouiaId:\"run-command-dropdown-item\",children:/*i18n*/i18n._(\"Run Command\")},\"cancel-job\"):/*#__PURE__*/_jsx(Button,{ouiaId:\"run-command-button\",variant:\"secondary\",\"aria-label\":/*i18n*/i18n._(\"Run Command\"),onClick:function onClick(){return setIsWizardOpen(true);},isDisabled:!hasListItems,children:/*i18n*/i18n._(\"Run Command\")})}),isWizardOpen&&/*#__PURE__*/_jsx(AdHocCommandsWizard,{adHocItems:adHocItems,organizationId:organizationId,moduleOptions:moduleOptions,credentialTypeId:credentialTypeId,onCloseWizard:function onCloseWizard(){return setIsWizardOpen(false);},onLaunch:handleSubmit,onDismissError:function onDismissError(){return dismissError();}})]}));}export default AdHocCommands;","map":{"version":3,"sources":["/awx_devel/awx/ui/src/components/AdHocCommands/AdHocCommands.js"],"names":["React","useCallback","useEffect","useState","useContext","useHistory","useParams","Button","DropdownItem","Tooltip","useRequest","useDismissableError","InventoriesAPI","CredentialTypesAPI","KebabifiedContext","AlertModal","ErrorDetail","AdHocCommandsWizard","ContentError","AdHocCommands","adHocItems","hasListItems","onLaunchLoading","moduleOptions","history","id","isWizardOpen","setIsWizardOpen","isKebabified","onKebabModalChange","Promise","all","readDetail","read","namespace","data","cred","credentialTypeId","results","organizationId","organization","result","fetchData","request","fetchError","error","values","launchAdHocCommands","push","isLaunchLoading","isLoading","launchError","dismissError","handleSubmit","credentials","credential_passwords","become_password","ssh_password","ssh_key_unlock","execution_environment","remainingValues","newCredential","manipulatedValues","credential"],"mappings":"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","sourcesContent":["import React, { useCallback, useEffect, useState, useContext } from 'react';\nimport { useHistory, useParams } from 'react-router-dom';\n\nimport { t } from '@lingui/macro';\nimport PropTypes from 'prop-types';\nimport { Button, DropdownItem, Tooltip } from '@patternfly/react-core';\n\nimport useRequest, { useDismissableError } from 'hooks/useRequest';\nimport { InventoriesAPI, CredentialTypesAPI } from 'api';\n\nimport { KebabifiedContext } from 'contexts/Kebabified';\nimport AlertModal from '../AlertModal';\nimport ErrorDetail from '../ErrorDetail';\nimport AdHocCommandsWizard from './AdHocCommandsWizard';\nimport ContentError from '../ContentError';\n\nfunction AdHocCommands({\n  adHocItems,\n  hasListItems,\n  onLaunchLoading,\n  moduleOptions,\n}) {\n  const history = useHistory();\n  const { id } = useParams();\n\n  const [isWizardOpen, setIsWizardOpen] = useState(false);\n  const { isKebabified, onKebabModalChange } = useContext(KebabifiedContext);\n\n  useEffect(() => {\n    if (isKebabified) {\n      onKebabModalChange(isWizardOpen);\n    }\n  }, [isKebabified, isWizardOpen, onKebabModalChange]);\n\n  const {\n    result: { credentialTypeId, organizationId },\n    request: fetchData,\n    error: fetchError,\n  } = useRequest(\n    useCallback(async () => {\n      const [{ data }, cred] = await Promise.all([\n        InventoriesAPI.readDetail(id),\n        CredentialTypesAPI.read({ namespace: 'ssh' }),\n      ]);\n      return {\n        credentialTypeId: cred.data.results[0].id,\n        organizationId: data.organization,\n      };\n    }, [id]),\n    { organizationId: null }\n  );\n  useEffect(() => {\n    fetchData();\n  }, [fetchData]);\n\n  const {\n    isLoading: isLaunchLoading,\n    error: launchError,\n    request: launchAdHocCommands,\n  } = useRequest(\n    useCallback(\n      async (values) => {\n        const { data } = await InventoriesAPI.launchAdHocCommands(id, values);\n        history.push(`/jobs/command/${data.id}/output`);\n      },\n\n      [id, history]\n    )\n  );\n\n  const { error, dismissError } = useDismissableError(\n    launchError || fetchError\n  );\n\n  const handleSubmit = async (values) => {\n    const {\n      credentials,\n      credential_passwords: { become_password, ssh_password, ssh_key_unlock },\n      execution_environment,\n      ...remainingValues\n    } = values;\n    const newCredential = credentials[0].id;\n\n    const manipulatedValues = {\n      credential: newCredential,\n      become_password,\n      ssh_password,\n      ssh_key_unlock,\n      execution_environment: execution_environment[0]?.id,\n      ...remainingValues,\n    };\n    await launchAdHocCommands(manipulatedValues);\n  };\n  useEffect(\n    () => onLaunchLoading(isLaunchLoading),\n    [isLaunchLoading, onLaunchLoading]\n  );\n\n  if (error && isWizardOpen) {\n    return (\n      <AlertModal\n        isOpen={error}\n        variant=\"error\"\n        title={t`Error!`}\n        onClose={() => {\n          dismissError();\n          setIsWizardOpen(false);\n        }}\n      >\n        {launchError ? (\n          <>\n            {t`Failed to launch job.`}\n            <ErrorDetail error={error} />\n          </>\n        ) : (\n          <ContentError error={error} />\n        )}\n      </AlertModal>\n    );\n  }\n  return (\n    // render buttons for drop down and for toolbar\n    // if modal is open render the modal\n    <>\n      <Tooltip content={t`Run ad hoc command`}>\n        {isKebabified ? (\n          <DropdownItem\n            key=\"cancel-job\"\n            isDisabled={!hasListItems}\n            component=\"button\"\n            aria-label={t`Run Command`}\n            onClick={() => setIsWizardOpen(true)}\n            ouiaId=\"run-command-dropdown-item\"\n          >\n            {t`Run Command`}\n          </DropdownItem>\n        ) : (\n          <Button\n            ouiaId=\"run-command-button\"\n            variant=\"secondary\"\n            aria-label={t`Run Command`}\n            onClick={() => setIsWizardOpen(true)}\n            isDisabled={!hasListItems}\n          >\n            {t`Run Command`}\n          </Button>\n        )}\n      </Tooltip>\n\n      {isWizardOpen && (\n        <AdHocCommandsWizard\n          adHocItems={adHocItems}\n          organizationId={organizationId}\n          moduleOptions={moduleOptions}\n          credentialTypeId={credentialTypeId}\n          onCloseWizard={() => setIsWizardOpen(false)}\n          onLaunch={handleSubmit}\n          onDismissError={() => dismissError()}\n        />\n      )}\n    </>\n  );\n}\n\nAdHocCommands.propTypes = {\n  adHocItems: PropTypes.arrayOf(PropTypes.object).isRequired,\n  hasListItems: PropTypes.bool.isRequired,\n  onLaunchLoading: PropTypes.func.isRequired,\n  moduleOptions: PropTypes.arrayOf(PropTypes.array).isRequired,\n};\n\nexport default AdHocCommands;\n"]},"metadata":{},"sourceType":"module"}