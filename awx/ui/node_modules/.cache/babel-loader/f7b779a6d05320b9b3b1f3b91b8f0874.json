{"ast":null,"code":"import _objectSpread from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import{i18n}from\"@lingui/core\";import React,{useCallback,useEffect,useState}from'react';import{useLocation}from'react-router-dom';import{RolesAPI,TeamsAPI,UsersAPI,OrganizationsAPI}from'api';import{getQSConfig,parseQueryString}from'util/qs';import useRequest,{useDeleteItems}from'hooks/useRequest';import{useUserProfile,useConfig}from'contexts/Config';import AddResourceRole from'../AddRole/AddResourceRole';import AlertModal from'../AlertModal';import DataListToolbar from'../DataListToolbar';import PaginatedTable,{HeaderRow,HeaderCell,ToolbarAddButton,getSearchableKeys}from'../PaginatedTable';import DeleteRoleConfirmationModal from'./DeleteRoleConfirmationModal';import ResourceAccessListItem from'./ResourceAccessListItem';import ErrorDetail from'../ErrorDetail';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";var QS_CONFIG=getQSConfig('access',{page:1,page_size:5,order_by:'first_name'});function ResourceAccessList(_ref){var apiModel=_ref.apiModel,resource=_ref.resource;var _useUserProfile=useUserProfile(),isSuperUser=_useUserProfile.isSuperUser,isOrgAdmin=_useUserProfile.isOrgAdmin;var _useConfig=useConfig(),me=_useConfig.me;var _useState=useState(null),_useState2=_slicedToArray(_useState,2),submitError=_useState2[0],setSubmitError=_useState2[1];var _useState3=useState(null),_useState4=_slicedToArray(_useState3,2),deletionRecord=_useState4[0],setDeletionRecord=_useState4[1];var _useState5=useState(null),_useState6=_slicedToArray(_useState5,2),deletionRole=_useState6[0],setDeletionRole=_useState6[1];var _useState7=useState(false),_useState8=_slicedToArray(_useState7,2),showAddModal=_useState8[0],setShowAddModal=_useState8[1];var _useState9=useState(false),_useState10=_slicedToArray(_useState9,2),showDeleteModal=_useState10[0],setShowDeleteModal=_useState10[1];var location=useLocation();var _useRequest=useRequest(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _yield$OrganizationsA,count;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(isSuperUser||resource.type!=='credential'||!isOrgAdmin||!(resource!==null&&resource!==void 0&&resource.organization))){_context.next=2;break;}return _context.abrupt(\"return\",false);case 2:_context.next=4;return OrganizationsAPI.readAdmins(resource.organization,{id:me.id});case 4:_yield$OrganizationsA=_context.sent;count=_yield$OrganizationsA.data.count;return _context.abrupt(\"return\",{isCredentialOrgAdmin:!!count});case 7:case\"end\":return _context.stop();}}},_callee);})),[me.id,isOrgAdmin,isSuperUser,resource.type,resource.organization]),{isCredentialOrgAdmin:false}),isFetchingOrgAdmins=_useRequest.isLoading,errorFetchingOrgAdmins=_useRequest.error,fetchOrgAdmins=_useRequest.request,isCredentialOrgAdmin=_useRequest.result.isCredentialOrgAdmin;useEffect(function(){fetchOrgAdmins();},[fetchOrgAdmins]);var canAddAdditionalControls=false;if(isSuperUser){canAddAdditionalControls=true;}if(resource.type==='credential'&&isOrgAdmin&&isCredentialOrgAdmin){canAddAdditionalControls=true;}if(resource.type!=='credential'){var _resource$summary_fie,_resource$summary_fie2;canAddAdditionalControls=resource===null||resource===void 0?void 0:(_resource$summary_fie=resource.summary_fields)===null||_resource$summary_fie===void 0?void 0:(_resource$summary_fie2=_resource$summary_fie.user_capabilities)===null||_resource$summary_fie2===void 0?void 0:_resource$summary_fie2.edit;}var _useRequest2=useRequest(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var _actionsResponse$data,_actionsResponse$data2;var params,_yield$Promise$all,_yield$Promise$all2,response,actionsResponse,orgRoles,_yield$Promise$all3,_yield$Promise$all4,systemAdmin,systemAuditor;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:params=parseQueryString(QS_CONFIG,location.search);_context2.next=3;return Promise.all([apiModel.readAccessList(resource.id,params),apiModel.readAccessOptions(resource.id)]);case 3:_yield$Promise$all=_context2.sent;_yield$Promise$all2=_slicedToArray(_yield$Promise$all,2);response=_yield$Promise$all2[0];actionsResponse=_yield$Promise$all2[1];if(!location.pathname.includes('/organizations')){_context2.next=15;break;}_context2.next=10;return Promise.all([RolesAPI.read({singleton_name:'system_administrator'}),RolesAPI.read({singleton_name:'system_auditor'})]);case 10:_yield$Promise$all3=_context2.sent;_yield$Promise$all4=_slicedToArray(_yield$Promise$all3,2);systemAdmin=_yield$Promise$all4[0].data.results;systemAuditor=_yield$Promise$all4[1].data.results;orgRoles=Object.entries(resource.summary_fields.object_roles).map(function(_ref4){var _ref5=_slicedToArray(_ref4,2),key=_ref5[0],value=_ref5[1];if(key==='admin_role'){return[\"\".concat(value.id,\", \").concat(systemAdmin[0].id),value.name];}if(key==='auditor_role'){return[\"\".concat(value.id,\", \").concat(systemAuditor[0].id),value.name];}return[\"\".concat(value.id),value.name];});case 15:return _context2.abrupt(\"return\",{accessRecords:response.data.results,itemCount:response.data.count,relatedSearchableKeys:((actionsResponse===null||actionsResponse===void 0?void 0:(_actionsResponse$data=actionsResponse.data)===null||_actionsResponse$data===void 0?void 0:_actionsResponse$data.related_search_fields)||[]).map(function(val){return val.slice(0,-8);}),searchableKeys:getSearchableKeys((_actionsResponse$data2=actionsResponse.data.actions)===null||_actionsResponse$data2===void 0?void 0:_actionsResponse$data2.GET),organizationRoles:orgRoles});case 16:case\"end\":return _context2.stop();}}},_callee2);})),[apiModel,location,resource]),{accessRecords:[],itemCount:0,relatedSearchableKeys:[],searchableKeys:[]}),_useRequest2$result=_useRequest2.result,accessRecords=_useRequest2$result.accessRecords,itemCount=_useRequest2$result.itemCount,relatedSearchableKeys=_useRequest2$result.relatedSearchableKeys,searchableKeys=_useRequest2$result.searchableKeys,organizationRoles=_useRequest2$result.organizationRoles,contentError=_useRequest2.error,isLoading=_useRequest2.isLoading,fetchAccessRecords=_useRequest2.request;useEffect(function(){fetchAccessRecords();},[fetchAccessRecords]);var _useDeleteItems=useDeleteItems(useCallback(function(){if(typeof deletionRole.team_id!=='undefined'){return TeamsAPI.disassociateRole(deletionRole.team_id,deletionRole.id);}return UsersAPI.disassociateRole(deletionRecord.id,deletionRole.id);/* eslint-disable-next-line react-hooks/exhaustive-deps */},[deletionRole]),{qsConfig:QS_CONFIG,fetchItems:fetchAccessRecords}),isDeleteLoading=_useDeleteItems.isLoading,deleteRole=_useDeleteItems.deleteItems,deletionError=_useDeleteItems.deletionError,clearDeletionError=_useDeleteItems.clearDeletionError;var toolbarSearchColumns=[{name:/*i18n*/i18n._(\"Username\"),key:'username__icontains',isDefault:true},{name:/*i18n*/i18n._(\"First Name\"),key:'first_name__icontains'},{name:/*i18n*/i18n._(\"Last Name\"),key:'last_name__icontains'}];if((organizationRoles===null||organizationRoles===void 0?void 0:organizationRoles.length)>0){toolbarSearchColumns.push({name:/*i18n*/i18n._(\"Roles\"),key:\"or__roles__in\",options:organizationRoles});}return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(PaginatedTable,{error:contentError||errorFetchingOrgAdmins,hasContentLoading:isLoading||isDeleteLoading||isFetchingOrgAdmins,items:accessRecords,itemCount:itemCount,pluralizedItemName:/*i18n*/i18n._(\"Roles\"),qsConfig:QS_CONFIG,toolbarSearchColumns:toolbarSearchColumns,toolbarSearchableKeys:searchableKeys,toolbarRelatedSearchableKeys:relatedSearchableKeys,renderToolbar:function renderToolbar(props){return/*#__PURE__*/_jsx(DataListToolbar,_objectSpread(_objectSpread({},props),{},{qsConfig:QS_CONFIG,additionalControls:canAddAdditionalControls?[/*#__PURE__*/_jsx(ToolbarAddButton,{ouiaId:\"access-add-button\",onClick:function onClick(){return setShowAddModal(true);}},\"add\")]:[]}));},headerRow:/*#__PURE__*/_jsxs(HeaderRow,{qsConfig:QS_CONFIG,isSelectable:false,children:[/*#__PURE__*/_jsx(HeaderCell,{sortKey:\"username\",children:/*i18n*/i18n._(\"Username\")}),/*#__PURE__*/_jsx(HeaderCell,{sortKey:\"first_name\",children:/*i18n*/i18n._(\"First name\")}),/*#__PURE__*/_jsx(HeaderCell,{sortKey:\"last_name\",children:/*i18n*/i18n._(\"Last name\")}),/*#__PURE__*/_jsx(HeaderCell,{children:/*i18n*/i18n._(\"Roles\")})]}),renderRow:function renderRow(accessRecord,index){return/*#__PURE__*/_jsx(ResourceAccessListItem,{accessRecord:accessRecord,onRoleDelete:function onRoleDelete(role,record){setDeletionRecord(record);setDeletionRole(role);setShowDeleteModal(true);},rowIndex:index},accessRecord.id);}}),showAddModal&&/*#__PURE__*/_jsx(AddResourceRole,{onClose:function onClose(){return setShowAddModal(false);},onSave:function onSave(){setShowAddModal(false);fetchAccessRecords();},onError:function onError(err){return setSubmitError(err);},roles:resource.summary_fields.object_roles,resource:resource}),showDeleteModal&&/*#__PURE__*/_jsx(DeleteRoleConfirmationModal,{role:deletionRole,username:deletionRecord.username,onCancel:function onCancel(){setDeletionRecord(null);setDeletionRole(null);setShowDeleteModal(false);},onConfirm:/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return deleteRole();case 2:setShowDeleteModal(false);setDeletionRecord(null);setDeletionRole(null);case 5:case\"end\":return _context3.stop();}}},_callee3);}))}),submitError&&/*#__PURE__*/_jsxs(AlertModal,{variant:\"error\",title:/*i18n*/i18n._(\"Error!\"),isOpen:submitError,onClose:function onClose(){return setSubmitError(null);},children:[/*i18n*/i18n._(\"Failed to assign roles properly\"),/*#__PURE__*/_jsx(ErrorDetail,{error:submitError})]}),deletionError&&/*#__PURE__*/_jsx(AlertModal,{isOpen:deletionError,variant:\"error\",title:/*i18n*/i18n._(\"Error!\"),onClose:clearDeletionError,children:/*i18n*/i18n._(\"Failed to delete role\")})]});}export default ResourceAccessList;","map":{"version":3,"sources":["/awx_devel/awx/ui/src/components/ResourceAccessList/ResourceAccessList.js"],"names":["React","useCallback","useEffect","useState","useLocation","RolesAPI","TeamsAPI","UsersAPI","OrganizationsAPI","getQSConfig","parseQueryString","useRequest","useDeleteItems","useUserProfile","useConfig","AddResourceRole","AlertModal","DataListToolbar","PaginatedTable","HeaderRow","HeaderCell","ToolbarAddButton","getSearchableKeys","DeleteRoleConfirmationModal","ResourceAccessListItem","ErrorDetail","QS_CONFIG","page","page_size","order_by","ResourceAccessList","apiModel","resource","isSuperUser","isOrgAdmin","me","submitError","setSubmitError","deletionRecord","setDeletionRecord","deletionRole","setDeletionRole","showAddModal","setShowAddModal","showDeleteModal","setShowDeleteModal","location","type","organization","readAdmins","id","count","data","isCredentialOrgAdmin","isFetchingOrgAdmins","isLoading","errorFetchingOrgAdmins","error","fetchOrgAdmins","request","result","canAddAdditionalControls","summary_fields","user_capabilities","edit","params","search","Promise","all","readAccessList","readAccessOptions","response","actionsResponse","pathname","includes","read","singleton_name","systemAdmin","results","systemAuditor","orgRoles","Object","entries","object_roles","map","key","value","name","accessRecords","itemCount","relatedSearchableKeys","related_search_fields","val","slice","searchableKeys","actions","GET","organizationRoles","contentError","fetchAccessRecords","team_id","disassociateRole","qsConfig","fetchItems","isDeleteLoading","deleteRole","deleteItems","deletionError","clearDeletionError","toolbarSearchColumns","isDefault","length","push","options","props","accessRecord","index","role","record","err","username"],"mappings":"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","sourcesContent":["import React, { useCallback, useEffect, useState } from 'react';\nimport { useLocation } from 'react-router-dom';\nimport { t } from '@lingui/macro';\nimport { RolesAPI, TeamsAPI, UsersAPI, OrganizationsAPI } from 'api';\nimport { getQSConfig, parseQueryString } from 'util/qs';\nimport useRequest, { useDeleteItems } from 'hooks/useRequest';\nimport { useUserProfile, useConfig } from 'contexts/Config';\nimport AddResourceRole from '../AddRole/AddResourceRole';\nimport AlertModal from '../AlertModal';\nimport DataListToolbar from '../DataListToolbar';\nimport PaginatedTable, {\n  HeaderRow,\n  HeaderCell,\n  ToolbarAddButton,\n  getSearchableKeys,\n} from '../PaginatedTable';\nimport DeleteRoleConfirmationModal from './DeleteRoleConfirmationModal';\nimport ResourceAccessListItem from './ResourceAccessListItem';\nimport ErrorDetail from '../ErrorDetail';\n\nconst QS_CONFIG = getQSConfig('access', {\n  page: 1,\n  page_size: 5,\n  order_by: 'first_name',\n});\n\nfunction ResourceAccessList({ apiModel, resource }) {\n  const { isSuperUser, isOrgAdmin } = useUserProfile();\n  const { me } = useConfig();\n  const [submitError, setSubmitError] = useState(null);\n  const [deletionRecord, setDeletionRecord] = useState(null);\n  const [deletionRole, setDeletionRole] = useState(null);\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [showDeleteModal, setShowDeleteModal] = useState(false);\n  const location = useLocation();\n\n  const {\n    isLoading: isFetchingOrgAdmins,\n    error: errorFetchingOrgAdmins,\n    request: fetchOrgAdmins,\n    result: { isCredentialOrgAdmin },\n  } = useRequest(\n    useCallback(async () => {\n      if (\n        isSuperUser ||\n        resource.type !== 'credential' ||\n        !isOrgAdmin ||\n        !resource?.organization\n      ) {\n        return false;\n      }\n      const {\n        data: { count },\n      } = await OrganizationsAPI.readAdmins(resource.organization, {\n        id: me.id,\n      });\n      return { isCredentialOrgAdmin: !!count };\n    }, [me.id, isOrgAdmin, isSuperUser, resource.type, resource.organization]),\n    {\n      isCredentialOrgAdmin: false,\n    }\n  );\n\n  useEffect(() => {\n    fetchOrgAdmins();\n  }, [fetchOrgAdmins]);\n\n  let canAddAdditionalControls = false;\n  if (isSuperUser) {\n    canAddAdditionalControls = true;\n  }\n  if (resource.type === 'credential' && isOrgAdmin && isCredentialOrgAdmin) {\n    canAddAdditionalControls = true;\n  }\n  if (resource.type !== 'credential') {\n    canAddAdditionalControls =\n      resource?.summary_fields?.user_capabilities?.edit;\n  }\n\n  const {\n    result: {\n      accessRecords,\n      itemCount,\n      relatedSearchableKeys,\n      searchableKeys,\n      organizationRoles,\n    },\n    error: contentError,\n    isLoading,\n    request: fetchAccessRecords,\n  } = useRequest(\n    useCallback(async () => {\n      const params = parseQueryString(QS_CONFIG, location.search);\n      const [response, actionsResponse] = await Promise.all([\n        apiModel.readAccessList(resource.id, params),\n        apiModel.readAccessOptions(resource.id),\n      ]);\n\n      // Eventually this could be expanded to other access lists.\n      // We will need to combine the role ids of all the different level\n      // of resource level roles.\n\n      let orgRoles;\n      if (location.pathname.includes('/organizations')) {\n        const [\n          {\n            data: { results: systemAdmin },\n          },\n          {\n            data: { results: systemAuditor },\n          },\n        ] = await Promise.all([\n          RolesAPI.read({ singleton_name: 'system_administrator' }),\n          RolesAPI.read({ singleton_name: 'system_auditor' }),\n        ]);\n\n        orgRoles = Object.entries(resource.summary_fields.object_roles).map(\n          ([key, value]) => {\n            if (key === 'admin_role') {\n              return [`${value.id}, ${systemAdmin[0].id}`, value.name];\n            }\n\n            if (key === 'auditor_role') {\n              return [`${value.id}, ${systemAuditor[0].id}`, value.name];\n            }\n\n            return [`${value.id}`, value.name];\n          }\n        );\n      }\n      return {\n        accessRecords: response.data.results,\n        itemCount: response.data.count,\n        relatedSearchableKeys: (\n          actionsResponse?.data?.related_search_fields || []\n        ).map((val) => val.slice(0, -8)),\n        searchableKeys: getSearchableKeys(actionsResponse.data.actions?.GET),\n        organizationRoles: orgRoles,\n      };\n    }, [apiModel, location, resource]),\n    {\n      accessRecords: [],\n      itemCount: 0,\n      relatedSearchableKeys: [],\n      searchableKeys: [],\n    }\n  );\n\n  useEffect(() => {\n    fetchAccessRecords();\n  }, [fetchAccessRecords]);\n\n  const {\n    isLoading: isDeleteLoading,\n    deleteItems: deleteRole,\n    deletionError,\n    clearDeletionError,\n  } = useDeleteItems(\n    useCallback(() => {\n      if (typeof deletionRole.team_id !== 'undefined') {\n        return TeamsAPI.disassociateRole(deletionRole.team_id, deletionRole.id);\n      }\n      return UsersAPI.disassociateRole(deletionRecord.id, deletionRole.id);\n      /* eslint-disable-next-line react-hooks/exhaustive-deps */\n    }, [deletionRole]),\n    {\n      qsConfig: QS_CONFIG,\n      fetchItems: fetchAccessRecords,\n    }\n  );\n  const toolbarSearchColumns = [\n    {\n      name: t`Username`,\n      key: 'username__icontains',\n      isDefault: true,\n    },\n    {\n      name: t`First Name`,\n      key: 'first_name__icontains',\n    },\n    {\n      name: t`Last Name`,\n      key: 'last_name__icontains',\n    },\n  ];\n\n  if (organizationRoles?.length > 0) {\n    toolbarSearchColumns.push({\n      name: t`Roles`,\n      key: `or__roles__in`,\n      options: organizationRoles,\n    });\n  }\n\n  return (\n    <>\n      <PaginatedTable\n        error={contentError || errorFetchingOrgAdmins}\n        hasContentLoading={isLoading || isDeleteLoading || isFetchingOrgAdmins}\n        items={accessRecords}\n        itemCount={itemCount}\n        pluralizedItemName={t`Roles`}\n        qsConfig={QS_CONFIG}\n        toolbarSearchColumns={toolbarSearchColumns}\n        toolbarSearchableKeys={searchableKeys}\n        toolbarRelatedSearchableKeys={relatedSearchableKeys}\n        renderToolbar={(props) => (\n          <DataListToolbar\n            {...props}\n            qsConfig={QS_CONFIG}\n            additionalControls={\n              canAddAdditionalControls\n                ? [\n                    <ToolbarAddButton\n                      ouiaId=\"access-add-button\"\n                      key=\"add\"\n                      onClick={() => setShowAddModal(true)}\n                    />,\n                  ]\n                : []\n            }\n          />\n        )}\n        headerRow={\n          <HeaderRow qsConfig={QS_CONFIG} isSelectable={false}>\n            <HeaderCell sortKey=\"username\">{t`Username`}</HeaderCell>\n            <HeaderCell sortKey=\"first_name\">{t`First name`}</HeaderCell>\n            <HeaderCell sortKey=\"last_name\">{t`Last name`}</HeaderCell>\n            <HeaderCell>{t`Roles`}</HeaderCell>\n          </HeaderRow>\n        }\n        renderRow={(accessRecord, index) => (\n          <ResourceAccessListItem\n            key={accessRecord.id}\n            accessRecord={accessRecord}\n            onRoleDelete={(role, record) => {\n              setDeletionRecord(record);\n              setDeletionRole(role);\n              setShowDeleteModal(true);\n            }}\n            rowIndex={index}\n          />\n        )}\n      />\n      {showAddModal && (\n        <AddResourceRole\n          onClose={() => setShowAddModal(false)}\n          onSave={() => {\n            setShowAddModal(false);\n            fetchAccessRecords();\n          }}\n          onError={(err) => setSubmitError(err)}\n          roles={resource.summary_fields.object_roles}\n          resource={resource}\n        />\n      )}\n      {showDeleteModal && (\n        <DeleteRoleConfirmationModal\n          role={deletionRole}\n          username={deletionRecord.username}\n          onCancel={() => {\n            setDeletionRecord(null);\n            setDeletionRole(null);\n            setShowDeleteModal(false);\n          }}\n          onConfirm={async () => {\n            await deleteRole();\n            setShowDeleteModal(false);\n            setDeletionRecord(null);\n            setDeletionRole(null);\n          }}\n        />\n      )}\n      {submitError && (\n        <AlertModal\n          variant=\"error\"\n          title={t`Error!`}\n          isOpen={submitError}\n          onClose={() => setSubmitError(null)}\n        >\n          {t`Failed to assign roles properly`}\n          <ErrorDetail error={submitError} />\n        </AlertModal>\n      )}\n      {deletionError && (\n        <AlertModal\n          isOpen={deletionError}\n          variant=\"error\"\n          title={t`Error!`}\n          onClose={clearDeletionError}\n        >\n          {t`Failed to delete role`}\n        </AlertModal>\n      )}\n    </>\n  );\n}\nexport default ResourceAccessList;\n"]},"metadata":{},"sourceType":"module"}