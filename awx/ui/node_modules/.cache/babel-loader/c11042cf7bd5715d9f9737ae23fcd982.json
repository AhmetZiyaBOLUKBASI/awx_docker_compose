{"ast":null,"code":"import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _taggedTemplateLiteral from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/taggedTemplateLiteral.js\";var _templateObject,_templateObject2,_templateObject3;import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import{Trans}from\"@lingui/react\";import{i18n}from\"@lingui/core\";import React,{useCallback,useEffect,useState}from'react';import{useParams,useHistory}from'react-router-dom';import{Button,Progress,ProgressMeasureLocation,ProgressSize,CodeBlock,CodeBlockCode,Tooltip,Slider}from'@patternfly/react-core';import{CaretLeftIcon}from'@patternfly/react-icons';import styled from'styled-components';import{useConfig}from'contexts/Config';import{InstancesAPI,InstanceGroupsAPI}from'api';import useDebounce from'hooks/useDebounce';import AlertModal from'components/AlertModal';import ErrorDetail from'components/ErrorDetail';import DisassociateButton from'components/DisassociateButton';import InstanceToggle from'components/InstanceToggle';import{CardBody,CardActionsRow}from'components/Card';import{formatDateString}from'util/dates';import RoutedTabs from'components/RoutedTabs';import ContentError from'components/ContentError';import ContentLoading from'components/ContentLoading';import{Detail,DetailList}from'components/DetailList';import StatusLabel from'components/StatusLabel';import useRequest,{useDeleteItems,useDismissableError}from'hooks/useRequest';import{jsx as _jsx}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var Unavailable=styled.span(_templateObject||(_templateObject=_taggedTemplateLiteral([\"\\n  color: var(--pf-global--danger-color--200);\\n\"])));var SliderHolder=styled.div(_templateObject2||(_templateObject2=_taggedTemplateLiteral([\"\\n  display: flex;\\n  align-items: center;\\n  justify-content: space-between;\\n\"])));var SliderForks=styled.div(_templateObject3||(_templateObject3=_taggedTemplateLiteral([\"\\n  flex-grow: 1;\\n  margin-right: 8px;\\n  margin-left: 8px;\\n  text-align: center;\\n\"])));function computeForks(memCapacity,cpuCapacity,selectedCapacityAdjustment){var minCapacity=Math.min(memCapacity,cpuCapacity);var maxCapacity=Math.max(memCapacity,cpuCapacity);return Math.floor(minCapacity+(maxCapacity-minCapacity)*selectedCapacityAdjustment);}function InstanceDetails(_ref){var setBreadcrumb=_ref.setBreadcrumb,instanceGroup=_ref.instanceGroup;var _useConfig=useConfig(),_useConfig$me=_useConfig.me,me=_useConfig$me===void 0?{}:_useConfig$me;var _useParams=useParams(),id=_useParams.id,instanceId=_useParams.instanceId;var history=useHistory();var _useState=useState({}),_useState2=_slicedToArray(_useState,2),healthCheck=_useState2[0],setHealthCheck=_useState2[1];var _useState3=useState(),_useState4=_slicedToArray(_useState3,2),forks=_useState4[0],setForks=_useState4[1];var _useRequest=useRequest(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _yield$InstanceGroups,results,instanceDetails,healthCheckDetails,isAssociated,_yield$Promise$all,_yield$Promise$all2,details,healthCheckData;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return InstanceGroupsAPI.readInstances(instanceGroup.id);case 2:_yield$InstanceGroups=_context.sent;results=_yield$InstanceGroups.data.results;isAssociated=results.some(function(_ref3){var instId=_ref3.id;return instId===parseInt(instanceId,10);});if(!isAssociated){_context.next=16;break;}_context.next=8;return Promise.all([InstancesAPI.readDetail(instanceId),InstancesAPI.readHealthCheckDetail(instanceId)]);case 8:_yield$Promise$all=_context.sent;_yield$Promise$all2=_slicedToArray(_yield$Promise$all,2);details=_yield$Promise$all2[0].data;healthCheckData=_yield$Promise$all2[1].data;instanceDetails=details;healthCheckDetails=healthCheckData;_context.next=17;break;case 16:throw new Error(\"This instance is not associated with this instance group\");case 17:setBreadcrumb(instanceGroup,instanceDetails);setHealthCheck(healthCheckDetails);setForks(computeForks(instanceDetails.mem_capacity,instanceDetails.cpu_capacity,instanceDetails.capacity_adjustment));return _context.abrupt(\"return\",{instance:instanceDetails});case 21:case\"end\":return _context.stop();}}},_callee);})),[instanceId,setBreadcrumb,instanceGroup]),{instance:{},isLoading:true}),isLoading=_useRequest.isLoading,contentError=_useRequest.error,fetchDetails=_useRequest.request,instance=_useRequest.result.instance;useEffect(function(){fetchDetails();},[fetchDetails]);var _useRequest2=useRequest(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var _yield$InstancesAPI$h,data;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return InstancesAPI.healthCheck(instanceId);case 2:_yield$InstancesAPI$h=_context2.sent;data=_yield$InstancesAPI$h.data;setHealthCheck(data);case 5:case\"end\":return _context2.stop();}}},_callee2);})),[instanceId])),healthCheckError=_useRequest2.error,isRunningHealthCheck=_useRequest2.isLoading,fetchHealthCheck=_useRequest2.request;var _useDeleteItems=useDeleteItems(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return InstanceGroupsAPI.disassociateInstance(instanceGroup.id,instance.id);case 2:history.push(\"/instance_groups/\".concat(instanceGroup.id,\"/instances\"));case 3:case\"end\":return _context3.stop();}}},_callee3);})),[instanceGroup.id,instance.id,history])),disassociateInstance=_useDeleteItems.deleteItems,disassociateError=_useDeleteItems.deletionError;var _useRequest3=useRequest(useCallback(/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(values){return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return InstancesAPI.update(instance.id,values);case 2:case\"end\":return _context4.stop();}}},_callee4);}));return function(_x){return _ref6.apply(this,arguments);};}(),[instance])),updateInstanceError=_useRequest3.error,updateInstance=_useRequest3.request;var debounceUpdateInstance=useDebounce(updateInstance,200);var handleChangeValue=function handleChangeValue(value){var roundedValue=Math.round(value*100)/100;setForks(computeForks(instance.mem_capacity,instance.cpu_capacity,roundedValue));debounceUpdateInstance({capacity_adjustment:roundedValue});};var _useDismissableError=useDismissableError(disassociateError||updateInstanceError||healthCheckError),error=_useDismissableError.error,dismissError=_useDismissableError.dismissError;var tabsArray=[{name:/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(CaretLeftIcon,{}),/*i18n*/i18n._(\"Back to Instances\")]}),link:\"/instance_groups/\".concat(id,\"/instances\"),id:99},{name:/*i18n*/i18n._(\"Details\"),link:\"/instance_groups/\".concat(id,\"/instances/\").concat(instanceId,\"/details\"),id:0}];if(contentError){return/*#__PURE__*/_jsx(ContentError,{error:contentError});}if(isLoading){return/*#__PURE__*/_jsx(ContentLoading,{});}return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(RoutedTabs,{tabsArray:tabsArray}),/*#__PURE__*/_jsxs(CardBody,{children:[/*#__PURE__*/_jsxs(DetailList,{gutter:\"sm\",children:[/*#__PURE__*/_jsx(Detail,{label:/*i18n*/i18n._(\"Host Name\"),value:instance.hostname,dataCy:\"instance-detail-name\"}),/*#__PURE__*/_jsx(Detail,{label:/*i18n*/i18n._(\"Status\"),value:/*#__PURE__*/_jsx(StatusLabel,{status:healthCheck!==null&&healthCheck!==void 0&&healthCheck.errors?'error':'healthy'})}),/*#__PURE__*/_jsx(Detail,{label:/*i18n*/i18n._(\"Policy Type\"),value:instance.managed_by_policy?/*i18n*/i18n._(\"Auto\"):/*i18n*/i18n._(\"Manual\")}),/*#__PURE__*/_jsx(Detail,{label:/*i18n*/i18n._(\"Running Jobs\"),value:instance.jobs_running}),/*#__PURE__*/_jsx(Detail,{label:/*i18n*/i18n._(\"Total Jobs\"),value:instance.jobs_total}),/*#__PURE__*/_jsx(Detail,{label:/*i18n*/i18n._(\"Last Health Check\"),value:formatDateString(healthCheck===null||healthCheck===void 0?void 0:healthCheck.last_health_check)}),/*#__PURE__*/_jsx(Detail,{label:/*i18n*/i18n._(\"Node Type\"),value:instance.node_type}),/*#__PURE__*/_jsx(Detail,{label:/*i18n*/i18n._(\"Capacity Adjustment\"),value:/*#__PURE__*/_jsxs(SliderHolder,{\"data-cy\":\"slider-holder\",children:[/*#__PURE__*/_jsx(\"div\",{\"data-cy\":\"cpu-capacity\",children:/*i18n*/i18n._(\"CPU {0}\",{0:instance.cpu_capacity})}),/*#__PURE__*/_jsxs(SliderForks,{\"data-cy\":\"slider-forks\",children:[/*#__PURE__*/_jsx(\"div\",{\"data-cy\":\"number-forks\",children:/*#__PURE__*/_jsx(Trans,{id:\"{forks, plural, one {# fork} other {# forks}}\",values:{forks:forks}})}),/*#__PURE__*/_jsx(Slider,{areCustomStepsContinuous:true,max:1,min:0,step:0.1,value:instance.capacity_adjustment,onChange:handleChangeValue,isDisabled:!(me!==null&&me!==void 0&&me.is_superuser)||!instance.enabled,\"data-cy\":\"slider\"})]}),/*#__PURE__*/_jsx(\"div\",{\"data-cy\":\"mem-capacity\",children:/*i18n*/i18n._(\"RAM {0}\",{0:instance.mem_capacity})})]})}),/*#__PURE__*/_jsx(Detail,{label:/*i18n*/i18n._(\"Used Capacity\"),value:instance.enabled?/*#__PURE__*/_jsx(Progress,{title:/*i18n*/i18n._(\"Used capacity\"),value:Math.round(100-instance.percent_capacity_remaining),measureLocation:ProgressMeasureLocation.top,size:ProgressSize.sm,\"aria-label\":/*i18n*/i18n._(\"Used capacity\")}):/*#__PURE__*/_jsx(Unavailable,{children:/*i18n*/i18n._(\"Unavailable\")})}),(healthCheck===null||healthCheck===void 0?void 0:healthCheck.errors)&&/*#__PURE__*/_jsx(Detail,{fullWidth:true,label:/*i18n*/i18n._(\"Errors\"),value:/*#__PURE__*/_jsx(CodeBlock,{children:/*#__PURE__*/_jsx(CodeBlockCode,{children:healthCheck===null||healthCheck===void 0?void 0:healthCheck.errors})})})]}),/*#__PURE__*/_jsxs(CardActionsRow,{children:[/*#__PURE__*/_jsx(Tooltip,{content:/*i18n*/i18n._(\"Run a health check on the instance\"),children:/*#__PURE__*/_jsx(Button,{isDisabled:!me.is_superuser||isRunningHealthCheck,variant:\"primary\",ouiaId:\"health-check-button\",onClick:fetchHealthCheck,isLoading:isRunningHealthCheck,spinnerAriaLabel:/*i18n*/i18n._(\"Running health check\"),children:/*i18n*/i18n._(\"Run health check\")})}),me.is_superuser&&instance.node_type!=='control'&&/*#__PURE__*/_jsx(DisassociateButton,{verifyCannotDisassociate:instanceGroup.name==='controlplane',onDisassociate:disassociateInstance,itemsToDisassociate:[instance],isProtectedInstanceGroup:instanceGroup.name==='controlplane',modalTitle:/*i18n*/i18n._(\"Disassociate instance from instance group?\")},\"disassociate\"),/*#__PURE__*/_jsx(InstanceToggle,{css:\"display: inline-flex;\",fetchInstances:fetchDetails,instance:instance})]}),error&&/*#__PURE__*/_jsxs(AlertModal,{isOpen:error,onClose:dismissError,title:/*i18n*/i18n._(\"Error!\"),variant:\"error\",children:[updateInstanceError?/*i18n*/i18n._(\"Failed to update capacity adjustment.\"):/*i18n*/i18n._(\"Failed to disassociate one or more instances.\"),/*#__PURE__*/_jsx(ErrorDetail,{error:error})]})]})]});}export default InstanceDetails;","map":{"version":3,"sources":["/awx_devel/awx/ui/src/screens/InstanceGroup/InstanceDetails/InstanceDetails.js"],"names":["React","useCallback","useEffect","useState","useParams","useHistory","Button","Progress","ProgressMeasureLocation","ProgressSize","CodeBlock","CodeBlockCode","Tooltip","Slider","CaretLeftIcon","styled","useConfig","InstancesAPI","InstanceGroupsAPI","useDebounce","AlertModal","ErrorDetail","DisassociateButton","InstanceToggle","CardBody","CardActionsRow","formatDateString","RoutedTabs","ContentError","ContentLoading","Detail","DetailList","StatusLabel","useRequest","useDeleteItems","useDismissableError","Unavailable","span","SliderHolder","div","SliderForks","computeForks","memCapacity","cpuCapacity","selectedCapacityAdjustment","minCapacity","Math","min","maxCapacity","max","floor","InstanceDetails","setBreadcrumb","instanceGroup","me","id","instanceId","history","healthCheck","setHealthCheck","forks","setForks","readInstances","results","data","isAssociated","some","instId","parseInt","Promise","all","readDetail","readHealthCheckDetail","details","healthCheckData","instanceDetails","healthCheckDetails","Error","mem_capacity","cpu_capacity","capacity_adjustment","instance","isLoading","contentError","error","fetchDetails","request","result","healthCheckError","isRunningHealthCheck","fetchHealthCheck","disassociateInstance","push","deleteItems","disassociateError","deletionError","values","update","updateInstanceError","updateInstance","debounceUpdateInstance","handleChangeValue","value","roundedValue","round","dismissError","tabsArray","name","link","hostname","errors","managed_by_policy","jobs_running","jobs_total","last_health_check","node_type","is_superuser","enabled","percent_capacity_remaining","top","sm"],"mappings":"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","sourcesContent":["import React, { useCallback, useEffect, useState } from 'react';\n\nimport { useParams, useHistory } from 'react-router-dom';\nimport { t, Plural } from '@lingui/macro';\nimport {\n  Button,\n  Progress,\n  ProgressMeasureLocation,\n  ProgressSize,\n  CodeBlock,\n  CodeBlockCode,\n  Tooltip,\n  Slider,\n} from '@patternfly/react-core';\nimport { CaretLeftIcon } from '@patternfly/react-icons';\nimport styled from 'styled-components';\n\nimport { useConfig } from 'contexts/Config';\nimport { InstancesAPI, InstanceGroupsAPI } from 'api';\nimport useDebounce from 'hooks/useDebounce';\nimport AlertModal from 'components/AlertModal';\nimport ErrorDetail from 'components/ErrorDetail';\nimport DisassociateButton from 'components/DisassociateButton';\nimport InstanceToggle from 'components/InstanceToggle';\nimport { CardBody, CardActionsRow } from 'components/Card';\nimport { formatDateString } from 'util/dates';\nimport RoutedTabs from 'components/RoutedTabs';\nimport ContentError from 'components/ContentError';\nimport ContentLoading from 'components/ContentLoading';\nimport { Detail, DetailList } from 'components/DetailList';\nimport StatusLabel from 'components/StatusLabel';\nimport useRequest, {\n  useDeleteItems,\n  useDismissableError,\n} from 'hooks/useRequest';\n\nconst Unavailable = styled.span`\n  color: var(--pf-global--danger-color--200);\n`;\n\nconst SliderHolder = styled.div`\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n`;\n\nconst SliderForks = styled.div`\n  flex-grow: 1;\n  margin-right: 8px;\n  margin-left: 8px;\n  text-align: center;\n`;\n\nfunction computeForks(memCapacity, cpuCapacity, selectedCapacityAdjustment) {\n  const minCapacity = Math.min(memCapacity, cpuCapacity);\n  const maxCapacity = Math.max(memCapacity, cpuCapacity);\n\n  return Math.floor(\n    minCapacity + (maxCapacity - minCapacity) * selectedCapacityAdjustment\n  );\n}\n\nfunction InstanceDetails({ setBreadcrumb, instanceGroup }) {\n  const { me = {} } = useConfig();\n  const { id, instanceId } = useParams();\n  const history = useHistory();\n\n  const [healthCheck, setHealthCheck] = useState({});\n  const [forks, setForks] = useState();\n\n  const {\n    isLoading,\n    error: contentError,\n    request: fetchDetails,\n    result: { instance },\n  } = useRequest(\n    useCallback(async () => {\n      const {\n        data: { results },\n      } = await InstanceGroupsAPI.readInstances(instanceGroup.id);\n      let instanceDetails;\n      let healthCheckDetails;\n      const isAssociated = results.some(\n        ({ id: instId }) => instId === parseInt(instanceId, 10)\n      );\n\n      if (isAssociated) {\n        const [{ data: details }, { data: healthCheckData }] =\n          await Promise.all([\n            InstancesAPI.readDetail(instanceId),\n            InstancesAPI.readHealthCheckDetail(instanceId),\n          ]);\n\n        instanceDetails = details;\n        healthCheckDetails = healthCheckData;\n      } else {\n        throw new Error(\n          `This instance is not associated with this instance group`\n        );\n      }\n\n      setBreadcrumb(instanceGroup, instanceDetails);\n      setHealthCheck(healthCheckDetails);\n      setForks(\n        computeForks(\n          instanceDetails.mem_capacity,\n          instanceDetails.cpu_capacity,\n          instanceDetails.capacity_adjustment\n        )\n      );\n      return { instance: instanceDetails };\n    }, [instanceId, setBreadcrumb, instanceGroup]),\n    { instance: {}, isLoading: true }\n  );\n  useEffect(() => {\n    fetchDetails();\n  }, [fetchDetails]);\n\n  const {\n    error: healthCheckError,\n    isLoading: isRunningHealthCheck,\n    request: fetchHealthCheck,\n  } = useRequest(\n    useCallback(async () => {\n      const { data } = await InstancesAPI.healthCheck(instanceId);\n      setHealthCheck(data);\n    }, [instanceId])\n  );\n\n  const {\n    deleteItems: disassociateInstance,\n    deletionError: disassociateError,\n  } = useDeleteItems(\n    useCallback(async () => {\n      await InstanceGroupsAPI.disassociateInstance(\n        instanceGroup.id,\n        instance.id\n      );\n      history.push(`/instance_groups/${instanceGroup.id}/instances`);\n    }, [instanceGroup.id, instance.id, history])\n  );\n\n  const { error: updateInstanceError, request: updateInstance } = useRequest(\n    useCallback(\n      async (values) => {\n        await InstancesAPI.update(instance.id, values);\n      },\n      [instance]\n    )\n  );\n\n  const debounceUpdateInstance = useDebounce(updateInstance, 200);\n\n  const handleChangeValue = (value) => {\n    const roundedValue = Math.round(value * 100) / 100;\n    setForks(\n      computeForks(instance.mem_capacity, instance.cpu_capacity, roundedValue)\n    );\n    debounceUpdateInstance({ capacity_adjustment: roundedValue });\n  };\n\n  const { error, dismissError } = useDismissableError(\n    disassociateError || updateInstanceError || healthCheckError\n  );\n\n  const tabsArray = [\n    {\n      name: (\n        <>\n          <CaretLeftIcon />\n          {t`Back to Instances`}\n        </>\n      ),\n      link: `/instance_groups/${id}/instances`,\n      id: 99,\n    },\n    {\n      name: t`Details`,\n      link: `/instance_groups/${id}/instances/${instanceId}/details`,\n      id: 0,\n    },\n  ];\n  if (contentError) {\n    return <ContentError error={contentError} />;\n  }\n  if (isLoading) {\n    return <ContentLoading />;\n  }\n\n  return (\n    <>\n      <RoutedTabs tabsArray={tabsArray} />\n      <CardBody>\n        <DetailList gutter=\"sm\">\n          <Detail\n            label={t`Host Name`}\n            value={instance.hostname}\n            dataCy=\"instance-detail-name\"\n          />\n          <Detail\n            label={t`Status`}\n            value={\n              <StatusLabel status={healthCheck?.errors ? 'error' : 'healthy'} />\n            }\n          />\n          <Detail\n            label={t`Policy Type`}\n            value={instance.managed_by_policy ? t`Auto` : t`Manual`}\n          />\n          <Detail label={t`Running Jobs`} value={instance.jobs_running} />\n          <Detail label={t`Total Jobs`} value={instance.jobs_total} />\n          <Detail\n            label={t`Last Health Check`}\n            value={formatDateString(healthCheck?.last_health_check)}\n          />\n          <Detail label={t`Node Type`} value={instance.node_type} />\n          <Detail\n            label={t`Capacity Adjustment`}\n            value={\n              <SliderHolder data-cy=\"slider-holder\">\n                <div data-cy=\"cpu-capacity\">{t`CPU ${instance.cpu_capacity}`}</div>\n                <SliderForks data-cy=\"slider-forks\">\n                  <div data-cy=\"number-forks\">\n                    <Plural value={forks} one=\"# fork\" other=\"# forks\" />\n                  </div>\n                  <Slider\n                    areCustomStepsContinuous\n                    max={1}\n                    min={0}\n                    step={0.1}\n                    value={instance.capacity_adjustment}\n                    onChange={handleChangeValue}\n                    isDisabled={!me?.is_superuser || !instance.enabled}\n                    data-cy=\"slider\"\n                  />\n                </SliderForks>\n                <div data-cy=\"mem-capacity\">{t`RAM ${instance.mem_capacity}`}</div>\n              </SliderHolder>\n            }\n          />\n          <Detail\n            label={t`Used Capacity`}\n            value={\n              instance.enabled ? (\n                <Progress\n                  title={t`Used capacity`}\n                  value={Math.round(100 - instance.percent_capacity_remaining)}\n                  measureLocation={ProgressMeasureLocation.top}\n                  size={ProgressSize.sm}\n                  aria-label={t`Used capacity`}\n                />\n              ) : (\n                <Unavailable>{t`Unavailable`}</Unavailable>\n              )\n            }\n          />\n          {healthCheck?.errors && (\n            <Detail\n              fullWidth\n              label={t`Errors`}\n              value={\n                <CodeBlock>\n                  <CodeBlockCode>{healthCheck?.errors}</CodeBlockCode>\n                </CodeBlock>\n              }\n            />\n          )}\n        </DetailList>\n        <CardActionsRow>\n          <Tooltip content={t`Run a health check on the instance`}>\n            <Button\n              isDisabled={!me.is_superuser || isRunningHealthCheck}\n              variant=\"primary\"\n              ouiaId=\"health-check-button\"\n              onClick={fetchHealthCheck}\n              isLoading={isRunningHealthCheck}\n              spinnerAriaLabel={t`Running health check`}\n            >\n              {t`Run health check`}\n            </Button>\n          </Tooltip>\n          {me.is_superuser && instance.node_type !== 'control' && (\n            <DisassociateButton\n              verifyCannotDisassociate={instanceGroup.name === 'controlplane'}\n              key=\"disassociate\"\n              onDisassociate={disassociateInstance}\n              itemsToDisassociate={[instance]}\n              isProtectedInstanceGroup={instanceGroup.name === 'controlplane'}\n              modalTitle={t`Disassociate instance from instance group?`}\n            />\n          )}\n          <InstanceToggle\n            css=\"display: inline-flex;\"\n            fetchInstances={fetchDetails}\n            instance={instance}\n          />\n        </CardActionsRow>\n\n        {error && (\n          <AlertModal\n            isOpen={error}\n            onClose={dismissError}\n            title={t`Error!`}\n            variant=\"error\"\n          >\n            {updateInstanceError\n              ? t`Failed to update capacity adjustment.`\n              : t`Failed to disassociate one or more instances.`}\n            <ErrorDetail error={error} />\n          </AlertModal>\n        )}\n      </CardBody>\n    </>\n  );\n}\n\nexport default InstanceDetails;\n"]},"metadata":{},"sourceType":"module"}