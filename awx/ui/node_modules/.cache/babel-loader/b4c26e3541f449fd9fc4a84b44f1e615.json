{"ast":null,"code":"import _objectSpread from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _toConsumableArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import{i18n}from\"@lingui/core\";import React,{useCallback,useEffect,useState}from'react';import{useLocation}from'react-router-dom';import{Button,EmptyState,EmptyStateBody,EmptyStateIcon,Title}from'@patternfly/react-core';import{CubesIcon}from'@patternfly/react-icons';import{getQSConfig,parseQueryString}from'util/qs';import{UsersAPI,RolesAPI}from'api';import useRequest,{useDeleteItems}from'hooks/useRequest';import PaginatedTable,{HeaderRow,HeaderCell,ToolbarAddButton,getSearchableKeys}from'components/PaginatedTable';import ErrorDetail from'components/ErrorDetail';import AlertModal from'components/AlertModal';import DatalistToolbar from'components/DataListToolbar';import UserAndTeamAccessAdd from'components/UserAndTeamAccessAdd/UserAndTeamAccessAdd';import UserRolesListItem from'./UserRolesListItem';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";var QS_CONFIG=getQSConfig('roles',{page:1,page_size:20,order_by:'id'});// TODO Figure out how to best conduct a search of this list.\n// Since we only have a role ID in the top level of each role object\n// we can't really search using the normal search parameters.\nfunction UserRolesList(_ref){var user=_ref.user;var _useLocation=useLocation(),search=_useLocation.search;var _useState=useState(null),_useState2=_slicedToArray(_useState,2),roleToDisassociate=_useState2[0],setRoleToDisassociate=_useState2[1];var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),showAddModal=_useState4[0],setShowAddModal=_useState4[1];var _useState5=useState(null),_useState6=_slicedToArray(_useState5,2),associateError=_useState6[0],setAssociateError=_useState6[1];var _useRequest=useRequest(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _actionsResponse$data,_actionsResponse$data2;var params,_yield$Promise$all,_yield$Promise$all2,_yield$Promise$all2$,results,count,actionsResponse;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:params=parseQueryString(QS_CONFIG,search);_context.next=3;return Promise.all([UsersAPI.readRoles(user.id,params),UsersAPI.readOptions()]);case 3:_yield$Promise$all=_context.sent;_yield$Promise$all2=_slicedToArray(_yield$Promise$all,2);_yield$Promise$all2$=_yield$Promise$all2[0].data;results=_yield$Promise$all2$.results;count=_yield$Promise$all2$.count;actionsResponse=_yield$Promise$all2[1];return _context.abrupt(\"return\",{roleCount:count,roles:results,actions:actionsResponse.data.actions,relatedSearchableKeys:((actionsResponse===null||actionsResponse===void 0?void 0:(_actionsResponse$data=actionsResponse.data)===null||_actionsResponse$data===void 0?void 0:_actionsResponse$data.related_search_fields)||[]).map(function(val){return val.slice(0,-8);}),searchableKeys:getSearchableKeys((_actionsResponse$data2=actionsResponse.data.actions)===null||_actionsResponse$data2===void 0?void 0:_actionsResponse$data2.GET)});case 10:case\"end\":return _context.stop();}}},_callee);})),[user.id,search]),{roles:[],roleCount:0,actions:{},relatedSearchableKeys:[],searchableKeys:[]}),isLoading=_useRequest.isLoading,fetchRoles=_useRequest.request,error=_useRequest.error,_useRequest$result=_useRequest.result,roleCount=_useRequest$result.roleCount,roles=_useRequest$result.roles,actions=_useRequest$result.actions,relatedSearchableKeys=_useRequest$result.relatedSearchableKeys,searchableKeys=_useRequest$result.searchableKeys;useEffect(function(){fetchRoles();},[fetchRoles]);var _useDeleteItems=useDeleteItems(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:setRoleToDisassociate(null);_context2.next=3;return RolesAPI.disassociateUserRole(roleToDisassociate.id,parseInt(user.id,10));case 3:case\"end\":return _context2.stop();}}},_callee2);})),[roleToDisassociate,user.id]),{qsConfig:QS_CONFIG,fetchItems:fetchRoles}),isDisassociateLoading=_useDeleteItems.isLoading,disassociateRole=_useDeleteItems.deleteItems,disassociationError=_useDeleteItems.deletionError,clearDisassociationError=_useDeleteItems.clearDeletionError;var canAdd=actions&&Object.prototype.hasOwnProperty.call(actions,'POST');var detailUrl=function detailUrl(role){var _role$summary_fields=role.summary_fields,resource_id=_role$summary_fields.resource_id,resource_type=_role$summary_fields.resource_type;if(!role||!resource_type){return null;}if(resource_type!==null&&resource_type!==void 0&&resource_type.includes('template')){return\"/templates/\".concat(resource_type,\"/\").concat(resource_id,\"/details\");}if(resource_type!==null&&resource_type!==void 0&&resource_type.includes('inventory')){return\"/inventories/\".concat(resource_type,\"/\").concat(resource_id,\"/details\");}return\"/\".concat(resource_type,\"s/\").concat(resource_id,\"/details\");};var isSysAdmin=roles.some(function(role){return role.name==='System Administrator';});if(isSysAdmin){return/*#__PURE__*/_jsxs(EmptyState,{variant:\"full\",children:[/*#__PURE__*/_jsx(EmptyStateIcon,{icon:CubesIcon}),/*#__PURE__*/_jsx(Title,{headingLevel:\"h5\",size:\"lg\",children:/*i18n*/i18n._(\"System Administrator\")}),/*#__PURE__*/_jsx(EmptyStateBody,{children:/*i18n*/i18n._(\"System administrators have unrestricted access to all resources.\")})]});}return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(PaginatedTable,{contentError:error,hasContentLoading:isLoading||isDisassociateLoading,items:roles,itemCount:roleCount,pluralizedItemName:/*i18n*/i18n._(\"User Roles\"),qsConfig:QS_CONFIG,toolbarSearchColumns:[{name:/*i18n*/i18n._(\"Role\"),key:'role_field__icontains',isDefault:true}],toolbarSearchableKeys:searchableKeys,toolbarRelatedSearchableKeys:relatedSearchableKeys,headerRow:/*#__PURE__*/_jsxs(HeaderRow,{qsConfig:QS_CONFIG,isSelectable:false,children:[/*#__PURE__*/_jsx(HeaderCell,{children:/*i18n*/i18n._(\"Name\")}),/*#__PURE__*/_jsx(HeaderCell,{children:/*i18n*/i18n._(\"Type\")}),/*#__PURE__*/_jsx(HeaderCell,{children:/*i18n*/i18n._(\"Role\")})]}),renderRow:function renderRow(role,index){return/*#__PURE__*/_jsx(UserRolesListItem,{value:role.name,role:role,detailUrl:detailUrl(role),isSelected:false,onSelect:function onSelect(item){setRoleToDisassociate(item);},rowIndex:index},role.id);},renderToolbar:function renderToolbar(props){return/*#__PURE__*/_jsx(DatalistToolbar,_objectSpread(_objectSpread({},props),{},{qsConfig:QS_CONFIG,additionalControls:_toConsumableArray(canAdd?[/*#__PURE__*/_jsx(ToolbarAddButton,{ouiaId:\"role-add-button\",onClick:function onClick(){return setShowAddModal(true);}},\"add\")]:[])}));}}),showAddModal&&/*#__PURE__*/_jsx(UserAndTeamAccessAdd,{apiModel:UsersAPI,onFetchData:function onFetchData(){setShowAddModal(false);fetchRoles();},title:/*i18n*/i18n._(\"Add user permissions\"),onClose:function onClose(){return setShowAddModal(false);},onError:function onError(err){return setAssociateError(err);}}),roleToDisassociate&&/*#__PURE__*/_jsx(AlertModal,{\"aria-label\":/*i18n*/i18n._(\"Disassociate role\"),isOpen:roleToDisassociate,variant:\"error\",title:/*i18n*/i18n._(\"Disassociate role!\"),onClose:function onClose(){return setRoleToDisassociate(null);},actions:[/*#__PURE__*/_jsx(Button,{ouiaId:\"disassociate-confirm-button\",variant:\"danger\",\"aria-label\":/*i18n*/i18n._(\"Confirm disassociate\"),onClick:function onClick(){return disassociateRole();},children:/*i18n*/i18n._(\"Disassociate\")},\"disassociate\"),/*#__PURE__*/_jsx(Button,{ouiaId:\"disassociate-cancel-button\",variant:\"link\",\"aria-label\":/*i18n*/i18n._(\"Cancel\"),onClick:function onClick(){return setRoleToDisassociate(null);},children:/*i18n*/i18n._(\"Cancel\")},\"cancel\")],children:/*#__PURE__*/_jsxs(\"div\",{children:[/*i18n*/i18n._(\"This action will disassociate the following role from {0}:\",{0:roleToDisassociate.summary_fields.resource_name}),/*#__PURE__*/_jsx(\"br\",{}),/*#__PURE__*/_jsx(\"strong\",{children:roleToDisassociate.name})]})}),associateError&&/*#__PURE__*/_jsxs(AlertModal,{\"aria-label\":/*i18n*/i18n._(\"Associate role error\"),isOpen:associateError,variant:\"error\",title:/*i18n*/i18n._(\"Error!\"),onClose:function onClose(){return setAssociateError(null);},children:[/*i18n*/i18n._(\"Failed to associate role\"),/*#__PURE__*/_jsx(ErrorDetail,{error:associateError})]}),disassociationError&&/*#__PURE__*/_jsxs(AlertModal,{isOpen:disassociationError,variant:\"error\",title:/*i18n*/i18n._(\"Error!\"),onClose:clearDisassociationError,children:[/*i18n*/i18n._(\"Failed to delete role.\"),/*#__PURE__*/_jsx(ErrorDetail,{error:disassociationError})]})]});}export default UserRolesList;","map":{"version":3,"sources":["/awx_devel/awx/ui/src/screens/User/UserRoles/UserRolesList.js"],"names":["React","useCallback","useEffect","useState","useLocation","Button","EmptyState","EmptyStateBody","EmptyStateIcon","Title","CubesIcon","getQSConfig","parseQueryString","UsersAPI","RolesAPI","useRequest","useDeleteItems","PaginatedTable","HeaderRow","HeaderCell","ToolbarAddButton","getSearchableKeys","ErrorDetail","AlertModal","DatalistToolbar","UserAndTeamAccessAdd","UserRolesListItem","QS_CONFIG","page","page_size","order_by","UserRolesList","user","search","roleToDisassociate","setRoleToDisassociate","showAddModal","setShowAddModal","associateError","setAssociateError","params","Promise","all","readRoles","id","readOptions","data","results","count","actionsResponse","roleCount","roles","actions","relatedSearchableKeys","related_search_fields","map","val","slice","searchableKeys","GET","isLoading","fetchRoles","request","error","result","disassociateUserRole","parseInt","qsConfig","fetchItems","isDisassociateLoading","disassociateRole","deleteItems","disassociationError","deletionError","clearDisassociationError","clearDeletionError","canAdd","Object","prototype","hasOwnProperty","call","detailUrl","role","summary_fields","resource_id","resource_type","includes","isSysAdmin","some","name","key","isDefault","index","item","props","err","resource_name"],"mappings":"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","sourcesContent":["import React, { useCallback, useEffect, useState } from 'react';\nimport { useLocation } from 'react-router-dom';\nimport { t } from '@lingui/macro';\nimport {\n  Button,\n  EmptyState,\n  EmptyStateBody,\n  EmptyStateIcon,\n  Title,\n} from '@patternfly/react-core';\nimport { CubesIcon } from '@patternfly/react-icons';\nimport { getQSConfig, parseQueryString } from 'util/qs';\nimport { UsersAPI, RolesAPI } from 'api';\nimport useRequest, { useDeleteItems } from 'hooks/useRequest';\nimport PaginatedTable, {\n  HeaderRow,\n  HeaderCell,\n  ToolbarAddButton,\n  getSearchableKeys,\n} from 'components/PaginatedTable';\nimport ErrorDetail from 'components/ErrorDetail';\nimport AlertModal from 'components/AlertModal';\nimport DatalistToolbar from 'components/DataListToolbar';\nimport UserAndTeamAccessAdd from 'components/UserAndTeamAccessAdd/UserAndTeamAccessAdd';\nimport UserRolesListItem from './UserRolesListItem';\n\nconst QS_CONFIG = getQSConfig('roles', {\n  page: 1,\n  page_size: 20,\n  order_by: 'id',\n});\n// TODO Figure out how to best conduct a search of this list.\n// Since we only have a role ID in the top level of each role object\n// we can't really search using the normal search parameters.\nfunction UserRolesList({ user }) {\n  const { search } = useLocation();\n  const [roleToDisassociate, setRoleToDisassociate] = useState(null);\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [associateError, setAssociateError] = useState(null);\n\n  const {\n    isLoading,\n    request: fetchRoles,\n    error,\n    result: {\n      roleCount,\n      roles,\n      actions,\n      relatedSearchableKeys,\n      searchableKeys,\n    },\n  } = useRequest(\n    useCallback(async () => {\n      const params = parseQueryString(QS_CONFIG, search);\n      const [\n        {\n          data: { results, count },\n        },\n        actionsResponse,\n      ] = await Promise.all([\n        UsersAPI.readRoles(user.id, params),\n        UsersAPI.readOptions(),\n      ]);\n      return {\n        roleCount: count,\n        roles: results,\n        actions: actionsResponse.data.actions,\n        relatedSearchableKeys: (\n          actionsResponse?.data?.related_search_fields || []\n        ).map((val) => val.slice(0, -8)),\n        searchableKeys: getSearchableKeys(actionsResponse.data.actions?.GET),\n      };\n    }, [user.id, search]),\n    {\n      roles: [],\n      roleCount: 0,\n      actions: {},\n      relatedSearchableKeys: [],\n      searchableKeys: [],\n    }\n  );\n\n  useEffect(() => {\n    fetchRoles();\n  }, [fetchRoles]);\n\n  const {\n    isLoading: isDisassociateLoading,\n    deleteItems: disassociateRole,\n    deletionError: disassociationError,\n    clearDeletionError: clearDisassociationError,\n  } = useDeleteItems(\n    useCallback(async () => {\n      setRoleToDisassociate(null);\n      await RolesAPI.disassociateUserRole(\n        roleToDisassociate.id,\n        parseInt(user.id, 10)\n      );\n    }, [roleToDisassociate, user.id]),\n    { qsConfig: QS_CONFIG, fetchItems: fetchRoles }\n  );\n\n  const canAdd =\n    actions && Object.prototype.hasOwnProperty.call(actions, 'POST');\n\n  const detailUrl = (role) => {\n    const { resource_id, resource_type } = role.summary_fields;\n\n    if (!role || !resource_type) {\n      return null;\n    }\n\n    if (resource_type?.includes('template')) {\n      return `/templates/${resource_type}/${resource_id}/details`;\n    }\n    if (resource_type?.includes('inventory')) {\n      return `/inventories/${resource_type}/${resource_id}/details`;\n    }\n    return `/${resource_type}s/${resource_id}/details`;\n  };\n  const isSysAdmin = roles.some((role) => role.name === 'System Administrator');\n  if (isSysAdmin) {\n    return (\n      <EmptyState variant=\"full\">\n        <EmptyStateIcon icon={CubesIcon} />\n        <Title headingLevel=\"h5\" size=\"lg\">\n          {t`System Administrator`}\n        </Title>\n        <EmptyStateBody>\n          {t`System administrators have unrestricted access to all resources.`}\n        </EmptyStateBody>\n      </EmptyState>\n    );\n  }\n  return (\n    <>\n      <PaginatedTable\n        contentError={error}\n        hasContentLoading={isLoading || isDisassociateLoading}\n        items={roles}\n        itemCount={roleCount}\n        pluralizedItemName={t`User Roles`}\n        qsConfig={QS_CONFIG}\n        toolbarSearchColumns={[\n          {\n            name: t`Role`,\n            key: 'role_field__icontains',\n            isDefault: true,\n          },\n        ]}\n        toolbarSearchableKeys={searchableKeys}\n        toolbarRelatedSearchableKeys={relatedSearchableKeys}\n        headerRow={\n          <HeaderRow qsConfig={QS_CONFIG} isSelectable={false}>\n            <HeaderCell>{t`Name`}</HeaderCell>\n            <HeaderCell>{t`Type`}</HeaderCell>\n            <HeaderCell>{t`Role`}</HeaderCell>\n          </HeaderRow>\n        }\n        renderRow={(role, index) => (\n          <UserRolesListItem\n            key={role.id}\n            value={role.name}\n            role={role}\n            detailUrl={detailUrl(role)}\n            isSelected={false}\n            onSelect={(item) => {\n              setRoleToDisassociate(item);\n            }}\n            rowIndex={index}\n          />\n        )}\n        renderToolbar={(props) => (\n          <DatalistToolbar\n            {...props}\n            qsConfig={QS_CONFIG}\n            additionalControls={[\n              ...(canAdd\n                ? [\n                    <ToolbarAddButton\n                      ouiaId=\"role-add-button\"\n                      key=\"add\"\n                      onClick={() => setShowAddModal(true)}\n                    />,\n                  ]\n                : []),\n            ]}\n          />\n        )}\n      />\n      {showAddModal && (\n        <UserAndTeamAccessAdd\n          apiModel={UsersAPI}\n          onFetchData={() => {\n            setShowAddModal(false);\n            fetchRoles();\n          }}\n          title={t`Add user permissions`}\n          onClose={() => setShowAddModal(false)}\n          onError={(err) => setAssociateError(err)}\n        />\n      )}\n      {roleToDisassociate && (\n        <AlertModal\n          aria-label={t`Disassociate role`}\n          isOpen={roleToDisassociate}\n          variant=\"error\"\n          title={t`Disassociate role!`}\n          onClose={() => setRoleToDisassociate(null)}\n          actions={[\n            <Button\n              ouiaId=\"disassociate-confirm-button\"\n              key=\"disassociate\"\n              variant=\"danger\"\n              aria-label={t`Confirm disassociate`}\n              onClick={() => disassociateRole()}\n            >\n              {t`Disassociate`}\n            </Button>,\n            <Button\n              ouiaId=\"disassociate-cancel-button\"\n              key=\"cancel\"\n              variant=\"link\"\n              aria-label={t`Cancel`}\n              onClick={() => setRoleToDisassociate(null)}\n            >\n              {t`Cancel`}\n            </Button>,\n          ]}\n        >\n          <div>\n            {t`This action will disassociate the following role from ${roleToDisassociate.summary_fields.resource_name}:`}\n            <br />\n            <strong>{roleToDisassociate.name}</strong>\n          </div>\n        </AlertModal>\n      )}\n      {associateError && (\n        <AlertModal\n          aria-label={t`Associate role error`}\n          isOpen={associateError}\n          variant=\"error\"\n          title={t`Error!`}\n          onClose={() => setAssociateError(null)}\n        >\n          {t`Failed to associate role`}\n          <ErrorDetail error={associateError} />\n        </AlertModal>\n      )}\n      {disassociationError && (\n        <AlertModal\n          isOpen={disassociationError}\n          variant=\"error\"\n          title={t`Error!`}\n          onClose={clearDisassociationError}\n        >\n          {t`Failed to delete role.`}\n          <ErrorDetail error={disassociationError} />\n        </AlertModal>\n      )}\n    </>\n  );\n}\nexport default UserRolesList;\n"]},"metadata":{},"sourceType":"module"}