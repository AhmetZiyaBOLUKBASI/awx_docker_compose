{"ast":null,"code":"import _objectSpread from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _toConsumableArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import{i18n}from\"@lingui/core\";import React,{useState,useCallback,useEffect}from'react';import{useLocation,useParams}from'react-router-dom';import PaginatedTable,{HeaderRow,HeaderCell,ToolbarAddButton,getSearchableKeys}from'components/PaginatedTable';import DataListToolbar from'components/DataListToolbar';import DisassociateButton from'components/DisassociateButton';import AssociateModal from'components/AssociateModal';import AlertModal from'components/AlertModal';import ErrorDetail from'components/ErrorDetail';import useRequest,{useDeleteItems,useDismissableError}from'hooks/useRequest';import useSelected from'hooks/useSelected';import{TeamsAPI,UsersAPI}from'api';import{getQSConfig,mergeParams,parseQueryString}from'util/qs';import UserTeamListItem from'./UserTeamListItem';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";var QS_CONFIG=getQSConfig('teams',{page:1,page_size:20,order_by:'name'});function UserTeamList(){var _useState=useState(false),_useState2=_slicedToArray(_useState,2),isModalOpen=_useState2[0],setIsModalOpen=_useState2[1];var location=useLocation();var _useParams=useParams(),userId=_useParams.id;var _useRequest=useRequest(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _actionsResponse$data,_actionsResponse$data2;var params,_yield$Promise$all,_yield$Promise$all2,_yield$Promise$all2$,results,teamCount,actionsResponse,usersResponse;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:params=parseQueryString(QS_CONFIG,location.search);_context.next=3;return Promise.all([UsersAPI.readTeams(userId,params),UsersAPI.readTeamsOptions(userId),UsersAPI.readOptions()]);case 3:_yield$Promise$all=_context.sent;_yield$Promise$all2=_slicedToArray(_yield$Promise$all,3);_yield$Promise$all2$=_yield$Promise$all2[0].data;results=_yield$Promise$all2$.results;teamCount=_yield$Promise$all2$.count;actionsResponse=_yield$Promise$all2[1];usersResponse=_yield$Promise$all2[2];return _context.abrupt(\"return\",{teams:results,count:teamCount,userOptions:usersResponse.data.actions,actions:actionsResponse.data.actions,relatedSearchableKeys:((actionsResponse===null||actionsResponse===void 0?void 0:(_actionsResponse$data=actionsResponse.data)===null||_actionsResponse$data===void 0?void 0:_actionsResponse$data.related_search_fields)||[]).map(function(val){return val.slice(0,-8);}),searchableKeys:getSearchableKeys((_actionsResponse$data2=actionsResponse.data.actions)===null||_actionsResponse$data2===void 0?void 0:_actionsResponse$data2.GET)});case 11:case\"end\":return _context.stop();}}},_callee);})),[userId,location.search]),{teams:[],count:0,roles:{},userOptions:{},relatedSearchableKeys:[],searchableKeys:[]}),_useRequest$result=_useRequest.result,teams=_useRequest$result.teams,count=_useRequest$result.count,userOptions=_useRequest$result.userOptions,relatedSearchableKeys=_useRequest$result.relatedSearchableKeys,searchableKeys=_useRequest$result.searchableKeys,contentError=_useRequest.error,isLoading=_useRequest.isLoading,fetchTeams=_useRequest.request;useEffect(function(){fetchTeams();},[fetchTeams]);var _useSelected=useSelected(teams),selected=_useSelected.selected,isAllSelected=_useSelected.isAllSelected,handleSelect=_useSelected.handleSelect,clearSelected=_useSelected.clearSelected,selectAll=_useSelected.selectAll;var disassociateUserRoles=function disassociateUserRoles(team){return[UsersAPI.disassociateRole(userId,team.summary_fields.object_roles.admin_role.id),UsersAPI.disassociateRole(userId,team.summary_fields.object_roles.member_role.id),UsersAPI.disassociateRole(userId,team.summary_fields.object_roles.read_role.id)];};var _useDeleteItems=useDeleteItems(useCallback(function(){return Promise.all(selected.flatMap(function(team){return disassociateUserRoles(team);}));},/* eslint-disable-next-line react-hooks/exhaustive-deps */[selected]),{qsConfig:QS_CONFIG,allItemsSelected:isAllSelected,fetchItems:fetchTeams}),isDisassociateLoading=_useDeleteItems.isLoading,disassociateTeams=_useDeleteItems.deleteItems,disassociateError=_useDeleteItems.deletionError;var _useRequest2=useRequest(useCallback(/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(teamsToAssociate){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return Promise.all(teamsToAssociate.map(function(team){return UsersAPI.associateRole(userId,team.summary_fields.object_roles.member_role.id);}));case 2:fetchTeams();case 3:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x){return _ref2.apply(this,arguments);};}(),[userId,fetchTeams])),handleAssociate=_useRequest2.request,associateError=_useRequest2.error;var handleDisassociate=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return disassociateTeams();case 2:clearSelected();case 3:case\"end\":return _context3.stop();}}},_callee3);}));return function handleDisassociate(){return _ref3.apply(this,arguments);};}();var _useDismissableError=useDismissableError(associateError||disassociateError),error=_useDismissableError.error,dismissError=_useDismissableError.dismissError;var canAdd=userOptions&&Object.prototype.hasOwnProperty.call(userOptions,'POST');var fetchTeamsToAssociate=useCallback(function(params){return TeamsAPI.read(mergeParams(params,{not__member_role__members__id:userId,not__admin_role__members__id:userId}));},[userId]);var readTeamOptions=useCallback(function(){return UsersAPI.readTeamsOptions(userId);},[userId]);return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(PaginatedTable,{items:teams,contentError:contentError,hasContentLoading:isLoading||isDisassociateLoading,itemCount:count,pluralizedItemName:/*i18n*/i18n._(\"Teams\"),qsConfig:QS_CONFIG,clearSelected:clearSelected,headerRow:/*#__PURE__*/_jsxs(HeaderRow,{qsConfig:QS_CONFIG,children:[/*#__PURE__*/_jsx(HeaderCell,{sortKey:\"name\",children:/*i18n*/i18n._(\"Name\")}),/*#__PURE__*/_jsx(HeaderCell,{children:/*i18n*/i18n._(\"Organization\")}),/*#__PURE__*/_jsx(HeaderCell,{children:/*i18n*/i18n._(\"Description\")})]}),renderRow:function renderRow(team,index){return/*#__PURE__*/_jsx(UserTeamListItem,{value:team.name,team:team,detailUrl:\"/teams/\".concat(team.id,\"/details\"),onSelect:function onSelect(){return handleSelect(team);},isSelected:selected.some(function(row){return row.id===team.id;}),rowIndex:index},team.id);},renderToolbar:function renderToolbar(props){return/*#__PURE__*/_jsx(DataListToolbar,_objectSpread(_objectSpread({},props),{},{isAllSelected:isAllSelected,onSelectAll:selectAll,qsConfig:QS_CONFIG,additionalControls:[].concat(_toConsumableArray(canAdd?[/*#__PURE__*/_jsx(ToolbarAddButton,{onClick:function onClick(){return setIsModalOpen(true);},defaultLabel:/*i18n*/i18n._(\"Associate\")},\"associate\")]:[]),[/*#__PURE__*/_jsx(DisassociateButton,{onDisassociate:handleDisassociate,itemsToDisassociate:selected,modalTitle:/*i18n*/i18n._(\"Disassociate related team(s)?\"),modalNote:/*i18n*/i18n._(\"This action will disassociate all roles for this user from the selected teams.\")},\"disassociate\")]),emptyStateControls:canAdd?/*#__PURE__*/_jsx(ToolbarAddButton,{onClick:function onClick(){return setIsModalOpen(true);}},\"add\"):null}));},toolbarSearchColumns:[{name:/*i18n*/i18n._(\"Name\"),key:'name__icontains',isDefault:true},{name:/*i18n*/i18n._(\"Organization\"),key:'organization__name__icontains'}],toolbarSearchableKeys:searchableKeys,toolbarRelatedSearchableKeys:relatedSearchableKeys}),isModalOpen&&/*#__PURE__*/_jsx(AssociateModal,{header:/*i18n*/i18n._(\"Teams\"),fetchRequest:fetchTeamsToAssociate,isModalOpen:isModalOpen,onAssociate:handleAssociate,onClose:function onClose(){return setIsModalOpen(false);},title:/*i18n*/i18n._(\"Select Teams\"),optionsRequest:readTeamOptions}),error&&/*#__PURE__*/_jsxs(AlertModal,{isOpen:error,onClose:dismissError,title:/*i18n*/i18n._(\"Error!\"),variant:\"error\",children:[associateError?/*i18n*/i18n._(\"Failed to associate.\"):/*i18n*/i18n._(\"Failed to disassociate one or more teams.\"),/*#__PURE__*/_jsx(ErrorDetail,{error:error})]})]});}export default UserTeamList;","map":{"version":3,"sources":["/awx_devel/awx/ui/src/screens/User/UserTeams/UserTeamList.js"],"names":["React","useState","useCallback","useEffect","useLocation","useParams","PaginatedTable","HeaderRow","HeaderCell","ToolbarAddButton","getSearchableKeys","DataListToolbar","DisassociateButton","AssociateModal","AlertModal","ErrorDetail","useRequest","useDeleteItems","useDismissableError","useSelected","TeamsAPI","UsersAPI","getQSConfig","mergeParams","parseQueryString","UserTeamListItem","QS_CONFIG","page","page_size","order_by","UserTeamList","isModalOpen","setIsModalOpen","location","userId","id","params","search","Promise","all","readTeams","readTeamsOptions","readOptions","data","results","teamCount","count","actionsResponse","usersResponse","teams","userOptions","actions","relatedSearchableKeys","related_search_fields","map","val","slice","searchableKeys","GET","roles","result","contentError","error","isLoading","fetchTeams","request","selected","isAllSelected","handleSelect","clearSelected","selectAll","disassociateUserRoles","team","disassociateRole","summary_fields","object_roles","admin_role","member_role","read_role","flatMap","qsConfig","allItemsSelected","fetchItems","isDisassociateLoading","disassociateTeams","deleteItems","disassociateError","deletionError","teamsToAssociate","associateRole","handleAssociate","associateError","handleDisassociate","dismissError","canAdd","Object","prototype","hasOwnProperty","call","fetchTeamsToAssociate","read","not__member_role__members__id","not__admin_role__members__id","readTeamOptions","index","name","some","row","props","key","isDefault"],"mappings":"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","sourcesContent":["import React, { useState, useCallback, useEffect } from 'react';\nimport { useLocation, useParams } from 'react-router-dom';\nimport { t } from '@lingui/macro';\n\nimport PaginatedTable, {\n  HeaderRow,\n  HeaderCell,\n  ToolbarAddButton,\n  getSearchableKeys,\n} from 'components/PaginatedTable';\nimport DataListToolbar from 'components/DataListToolbar';\nimport DisassociateButton from 'components/DisassociateButton';\nimport AssociateModal from 'components/AssociateModal';\nimport AlertModal from 'components/AlertModal';\nimport ErrorDetail from 'components/ErrorDetail';\nimport useRequest, {\n  useDeleteItems,\n  useDismissableError,\n} from 'hooks/useRequest';\nimport useSelected from 'hooks/useSelected';\nimport { TeamsAPI, UsersAPI } from 'api';\nimport { getQSConfig, mergeParams, parseQueryString } from 'util/qs';\n\nimport UserTeamListItem from './UserTeamListItem';\n\nconst QS_CONFIG = getQSConfig('teams', {\n  page: 1,\n  page_size: 20,\n  order_by: 'name',\n});\n\nfunction UserTeamList() {\n  const [isModalOpen, setIsModalOpen] = useState(false);\n  const location = useLocation();\n  const { id: userId } = useParams();\n\n  const {\n    result: {\n      teams,\n      count,\n      userOptions,\n      relatedSearchableKeys,\n      searchableKeys,\n    },\n    error: contentError,\n    isLoading,\n    request: fetchTeams,\n  } = useRequest(\n    useCallback(async () => {\n      const params = parseQueryString(QS_CONFIG, location.search);\n      const [\n        {\n          data: { results, count: teamCount },\n        },\n        actionsResponse,\n        usersResponse,\n      ] = await Promise.all([\n        UsersAPI.readTeams(userId, params),\n        UsersAPI.readTeamsOptions(userId),\n        UsersAPI.readOptions(),\n      ]);\n      return {\n        teams: results,\n        count: teamCount,\n        userOptions: usersResponse.data.actions,\n        actions: actionsResponse.data.actions,\n        relatedSearchableKeys: (\n          actionsResponse?.data?.related_search_fields || []\n        ).map((val) => val.slice(0, -8)),\n        searchableKeys: getSearchableKeys(actionsResponse.data.actions?.GET),\n      };\n    }, [userId, location.search]),\n    {\n      teams: [],\n      count: 0,\n      roles: {},\n      userOptions: {},\n      relatedSearchableKeys: [],\n      searchableKeys: [],\n    }\n  );\n\n  useEffect(() => {\n    fetchTeams();\n  }, [fetchTeams]);\n\n  const { selected, isAllSelected, handleSelect, clearSelected, selectAll } =\n    useSelected(teams);\n\n  const disassociateUserRoles = (team) => [\n    UsersAPI.disassociateRole(\n      userId,\n      team.summary_fields.object_roles.admin_role.id\n    ),\n    UsersAPI.disassociateRole(\n      userId,\n      team.summary_fields.object_roles.member_role.id\n    ),\n    UsersAPI.disassociateRole(\n      userId,\n      team.summary_fields.object_roles.read_role.id\n    ),\n  ];\n\n  const {\n    isLoading: isDisassociateLoading,\n    deleteItems: disassociateTeams,\n    deletionError: disassociateError,\n  } = useDeleteItems(\n    useCallback(\n      () =>\n        Promise.all(selected.flatMap((team) => disassociateUserRoles(team))),\n      /* eslint-disable-next-line react-hooks/exhaustive-deps */\n      [selected]\n    ),\n    {\n      qsConfig: QS_CONFIG,\n      allItemsSelected: isAllSelected,\n      fetchItems: fetchTeams,\n    }\n  );\n\n  const { request: handleAssociate, error: associateError } = useRequest(\n    useCallback(\n      async (teamsToAssociate) => {\n        await Promise.all(\n          teamsToAssociate.map((team) =>\n            UsersAPI.associateRole(\n              userId,\n              team.summary_fields.object_roles.member_role.id\n            )\n          )\n        );\n        fetchTeams();\n      },\n      [userId, fetchTeams]\n    )\n  );\n\n  const handleDisassociate = async () => {\n    await disassociateTeams();\n    clearSelected();\n  };\n\n  const { error, dismissError } = useDismissableError(\n    associateError || disassociateError\n  );\n\n  const canAdd =\n    userOptions && Object.prototype.hasOwnProperty.call(userOptions, 'POST');\n\n  const fetchTeamsToAssociate = useCallback(\n    (params) =>\n      TeamsAPI.read(\n        mergeParams(params, {\n          not__member_role__members__id: userId,\n          not__admin_role__members__id: userId,\n        })\n      ),\n    [userId]\n  );\n\n  const readTeamOptions = useCallback(\n    () => UsersAPI.readTeamsOptions(userId),\n    [userId]\n  );\n\n  return (\n    <>\n      <PaginatedTable\n        items={teams}\n        contentError={contentError}\n        hasContentLoading={isLoading || isDisassociateLoading}\n        itemCount={count}\n        pluralizedItemName={t`Teams`}\n        qsConfig={QS_CONFIG}\n        clearSelected={clearSelected}\n        headerRow={\n          <HeaderRow qsConfig={QS_CONFIG}>\n            <HeaderCell sortKey=\"name\">{t`Name`}</HeaderCell>\n            <HeaderCell>{t`Organization`}</HeaderCell>\n            <HeaderCell>{t`Description`}</HeaderCell>\n          </HeaderRow>\n        }\n        renderRow={(team, index) => (\n          <UserTeamListItem\n            key={team.id}\n            value={team.name}\n            team={team}\n            detailUrl={`/teams/${team.id}/details`}\n            onSelect={() => handleSelect(team)}\n            isSelected={selected.some((row) => row.id === team.id)}\n            rowIndex={index}\n          />\n        )}\n        renderToolbar={(props) => (\n          <DataListToolbar\n            {...props}\n            isAllSelected={isAllSelected}\n            onSelectAll={selectAll}\n            qsConfig={QS_CONFIG}\n            additionalControls={[\n              ...(canAdd\n                ? [\n                    <ToolbarAddButton\n                      key=\"associate\"\n                      onClick={() => setIsModalOpen(true)}\n                      defaultLabel={t`Associate`}\n                    />,\n                  ]\n                : []),\n              <DisassociateButton\n                key=\"disassociate\"\n                onDisassociate={handleDisassociate}\n                itemsToDisassociate={selected}\n                modalTitle={t`Disassociate related team(s)?`}\n                modalNote={t`This action will disassociate all roles for this user from the selected teams.`}\n              />,\n            ]}\n            emptyStateControls={\n              canAdd ? (\n                <ToolbarAddButton\n                  key=\"add\"\n                  onClick={() => setIsModalOpen(true)}\n                />\n              ) : null\n            }\n          />\n        )}\n        toolbarSearchColumns={[\n          {\n            name: t`Name`,\n            key: 'name__icontains',\n            isDefault: true,\n          },\n          {\n            name: t`Organization`,\n            key: 'organization__name__icontains',\n          },\n        ]}\n        toolbarSearchableKeys={searchableKeys}\n        toolbarRelatedSearchableKeys={relatedSearchableKeys}\n      />\n      {isModalOpen && (\n        <AssociateModal\n          header={t`Teams`}\n          fetchRequest={fetchTeamsToAssociate}\n          isModalOpen={isModalOpen}\n          onAssociate={handleAssociate}\n          onClose={() => setIsModalOpen(false)}\n          title={t`Select Teams`}\n          optionsRequest={readTeamOptions}\n        />\n      )}\n      {error && (\n        <AlertModal\n          isOpen={error}\n          onClose={dismissError}\n          title={t`Error!`}\n          variant=\"error\"\n        >\n          {associateError\n            ? t`Failed to associate.`\n            : t`Failed to disassociate one or more teams.`}\n          <ErrorDetail error={error} />\n        </AlertModal>\n      )}\n    </>\n  );\n}\n\nexport default UserTeamList;\n"]},"metadata":{},"sourceType":"module"}