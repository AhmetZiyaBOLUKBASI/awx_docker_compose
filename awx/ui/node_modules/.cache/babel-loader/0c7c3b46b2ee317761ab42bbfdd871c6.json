{"ast":null,"code":"import _toConsumableArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _objectWithoutProperties from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js\";import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";var _excluded=[\"labels\",\"instanceGroups\",\"initialInstanceGroups\",\"credentials\",\"inventory\",\"project\",\"webhook_credential\",\"webhook_key\",\"webhook_url\",\"execution_environment\"];import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";/* eslint react/no-unused-state: 0 */import React,{useState,useCallback,useEffect}from'react';import{Redirect,useHistory}from'react-router-dom';import{JobTemplate}from'types';import{JobTemplatesAPI,ProjectsAPI}from'api';import{getAddedAndRemoved}from'util/lists';import useRequest from'hooks/useRequest';import ContentLoading from'components/ContentLoading';import{CardBody}from'components/Card';import JobTemplateForm from'../shared/JobTemplateForm';import{jsx as _jsx}from\"react/jsx-runtime\";function JobTemplateEdit(_ref){var _template$summary_fie,_template$summary_fie2;var template=_ref.template,reloadTemplate=_ref.reloadTemplate;var history=useHistory();var _useState=useState(null),_useState2=_slicedToArray(_useState,2),formSubmitError=_useState2[0],setFormSubmitError=_useState2[1];var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),isLoading=_useState4[0],setIsLoading=_useState4[1];var _useState5=useState(false),_useState6=_slicedToArray(_useState5,2),isDisabled=_useState6[0],setIsDisabled=_useState6[1];var detailsUrl=\"/templates/\".concat(template.type,\"/\").concat(template.id,\"/details\");var _useRequest=useRequest(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return ProjectsAPI.readDetail(template.project);case 2:case\"end\":return _context.stop();}}},_callee);})),[template.project])),fetchProject=_useRequest.request,fetchProjectError=_useRequest.error;useEffect(function(){fetchProject();},[fetchProject]);useEffect(function(){if(fetchProjectError){if(fetchProjectError.response.status===403){setIsDisabled(true);}}},[fetchProjectError]);var handleSubmit=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(values){var labels,instanceGroups,initialInstanceGroups,credentials,inventory,project,webhook_credential,webhook_key,webhook_url,execution_environment,remainingValues;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:labels=values.labels,instanceGroups=values.instanceGroups,initialInstanceGroups=values.initialInstanceGroups,credentials=values.credentials,inventory=values.inventory,project=values.project,webhook_credential=values.webhook_credential,webhook_key=values.webhook_key,webhook_url=values.webhook_url,execution_environment=values.execution_environment,remainingValues=_objectWithoutProperties(values,_excluded);setFormSubmitError(null);setIsLoading(true);remainingValues.project=project.id;remainingValues.webhook_credential=(webhook_credential===null||webhook_credential===void 0?void 0:webhook_credential.id)||null;remainingValues.inventory=(inventory===null||inventory===void 0?void 0:inventory.id)||null;remainingValues.execution_environment=(execution_environment===null||execution_environment===void 0?void 0:execution_environment.id)||null;_context2.prev=7;_context2.next=10;return JobTemplatesAPI.update(template.id,remainingValues);case 10:_context2.next=12;return Promise.all([submitLabels(template===null||template===void 0?void 0:template.organization,labels),submitCredentials(credentials),JobTemplatesAPI.orderInstanceGroups(template.id,instanceGroups,initialInstanceGroups)]);case 12:reloadTemplate();history.push(detailsUrl);_context2.next=19;break;case 16:_context2.prev=16;_context2.t0=_context2[\"catch\"](7);setFormSubmitError(_context2.t0);case 19:_context2.prev=19;setIsLoading(false);return _context2.finish(19);case 22:case\"end\":return _context2.stop();}}},_callee2,null,[[7,16,19,22]]);}));return function handleSubmit(_x){return _ref3.apply(this,arguments);};}();var submitLabels=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(orgId){var labels,_getAddedAndRemoved,added,removed,disassociationPromises,associationPromises,results,_args3=arguments;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:labels=_args3.length>1&&_args3[1]!==undefined?_args3[1]:[];_getAddedAndRemoved=getAddedAndRemoved(template.summary_fields.labels.results,labels),added=_getAddedAndRemoved.added,removed=_getAddedAndRemoved.removed;disassociationPromises=removed.map(function(label){return JobTemplatesAPI.disassociateLabel(template.id,label);});associationPromises=added.map(function(label){return JobTemplatesAPI.associateLabel(template.id,label,orgId);});_context3.next=6;return Promise.all([].concat(_toConsumableArray(disassociationPromises),_toConsumableArray(associationPromises)));case 6:results=_context3.sent;return _context3.abrupt(\"return\",results);case 8:case\"end\":return _context3.stop();}}},_callee3);}));return function submitLabels(_x2){return _ref4.apply(this,arguments);};}();var submitCredentials=/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(newCredentials){var _getAddedAndRemoved2,added,removed,disassociateCredentials,disassociatePromise,associateCredentials,associatePromise;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_getAddedAndRemoved2=getAddedAndRemoved(template.summary_fields.credentials,newCredentials),added=_getAddedAndRemoved2.added,removed=_getAddedAndRemoved2.removed;disassociateCredentials=removed.map(function(cred){return JobTemplatesAPI.disassociateCredentials(template.id,cred.id);});_context4.next=4;return Promise.all(disassociateCredentials);case 4:disassociatePromise=_context4.sent;associateCredentials=added.map(function(cred){return JobTemplatesAPI.associateCredentials(template.id,cred.id);});_context4.next=8;return Promise.all(associateCredentials);case 8:associatePromise=_context4.sent;return _context4.abrupt(\"return\",Promise.all([disassociatePromise,associatePromise]));case 10:case\"end\":return _context4.stop();}}},_callee4);}));return function submitCredentials(_x3){return _ref5.apply(this,arguments);};}();var handleCancel=function handleCancel(){return history.push(detailsUrl);};var canEdit=template===null||template===void 0?void 0:(_template$summary_fie=template.summary_fields)===null||_template$summary_fie===void 0?void 0:(_template$summary_fie2=_template$summary_fie.user_capabilities)===null||_template$summary_fie2===void 0?void 0:_template$summary_fie2.edit;if(!canEdit){return/*#__PURE__*/_jsx(Redirect,{to:detailsUrl});}if(isLoading){return/*#__PURE__*/_jsx(ContentLoading,{});}return/*#__PURE__*/_jsx(CardBody,{children:/*#__PURE__*/_jsx(JobTemplateForm,{template:template,handleCancel:handleCancel,handleSubmit:handleSubmit,submitError:formSubmitError,isOverrideDisabledLookup:!isDisabled})});}export default JobTemplateEdit;","map":{"version":3,"sources":["/awx_devel/awx/ui/src/screens/Template/JobTemplateEdit/JobTemplateEdit.js"],"names":["React","useState","useCallback","useEffect","Redirect","useHistory","JobTemplate","JobTemplatesAPI","ProjectsAPI","getAddedAndRemoved","useRequest","ContentLoading","CardBody","JobTemplateForm","JobTemplateEdit","template","reloadTemplate","history","formSubmitError","setFormSubmitError","isLoading","setIsLoading","isDisabled","setIsDisabled","detailsUrl","type","id","readDetail","project","fetchProject","request","fetchProjectError","error","response","status","handleSubmit","values","labels","instanceGroups","initialInstanceGroups","credentials","inventory","webhook_credential","webhook_key","webhook_url","execution_environment","remainingValues","update","Promise","all","submitLabels","organization","submitCredentials","orderInstanceGroups","push","orgId","summary_fields","results","added","removed","disassociationPromises","map","label","disassociateLabel","associationPromises","associateLabel","newCredentials","disassociateCredentials","cred","disassociatePromise","associateCredentials","associatePromise","handleCancel","canEdit","user_capabilities","edit"],"mappings":"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","sourcesContent":["/* eslint react/no-unused-state: 0 */\nimport React, { useState, useCallback, useEffect } from 'react';\nimport { Redirect, useHistory } from 'react-router-dom';\n\nimport { JobTemplate } from 'types';\nimport { JobTemplatesAPI, ProjectsAPI } from 'api';\nimport { getAddedAndRemoved } from 'util/lists';\nimport useRequest from 'hooks/useRequest';\nimport ContentLoading from 'components/ContentLoading';\nimport { CardBody } from 'components/Card';\nimport JobTemplateForm from '../shared/JobTemplateForm';\n\nfunction JobTemplateEdit({ template, reloadTemplate }) {\n  const history = useHistory();\n  const [formSubmitError, setFormSubmitError] = useState(null);\n  const [isLoading, setIsLoading] = useState(false);\n  const [isDisabled, setIsDisabled] = useState(false);\n\n  const detailsUrl = `/templates/${template.type}/${template.id}/details`;\n\n  const { request: fetchProject, error: fetchProjectError } = useRequest(\n    useCallback(async () => {\n      await ProjectsAPI.readDetail(template.project);\n    }, [template.project])\n  );\n\n  useEffect(() => {\n    fetchProject();\n  }, [fetchProject]);\n\n  useEffect(() => {\n    if (fetchProjectError) {\n      if (fetchProjectError.response.status === 403) {\n        setIsDisabled(true);\n      }\n    }\n  }, [fetchProjectError]);\n\n  const handleSubmit = async (values) => {\n    const {\n      labels,\n      instanceGroups,\n      initialInstanceGroups,\n      credentials,\n      inventory,\n      project,\n      webhook_credential,\n      webhook_key,\n      webhook_url,\n      execution_environment,\n      ...remainingValues\n    } = values;\n\n    setFormSubmitError(null);\n    setIsLoading(true);\n    remainingValues.project = project.id;\n    remainingValues.webhook_credential = webhook_credential?.id || null;\n    remainingValues.inventory = inventory?.id || null;\n    remainingValues.execution_environment = execution_environment?.id || null;\n    try {\n      await JobTemplatesAPI.update(template.id, remainingValues);\n      await Promise.all([\n        submitLabels(template?.organization, labels),\n        submitCredentials(credentials),\n        JobTemplatesAPI.orderInstanceGroups(\n          template.id,\n          instanceGroups,\n          initialInstanceGroups\n        ),\n      ]);\n      reloadTemplate();\n      history.push(detailsUrl);\n    } catch (error) {\n      setFormSubmitError(error);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const submitLabels = async (orgId, labels = []) => {\n    const { added, removed } = getAddedAndRemoved(\n      template.summary_fields.labels.results,\n      labels\n    );\n\n    const disassociationPromises = removed.map((label) =>\n      JobTemplatesAPI.disassociateLabel(template.id, label)\n    );\n    const associationPromises = added.map((label) =>\n      JobTemplatesAPI.associateLabel(template.id, label, orgId)\n    );\n\n    const results = await Promise.all([\n      ...disassociationPromises,\n      ...associationPromises,\n    ]);\n    return results;\n  };\n\n  const submitCredentials = async (newCredentials) => {\n    const { added, removed } = getAddedAndRemoved(\n      template.summary_fields.credentials,\n      newCredentials\n    );\n    const disassociateCredentials = removed.map((cred) =>\n      JobTemplatesAPI.disassociateCredentials(template.id, cred.id)\n    );\n    const disassociatePromise = await Promise.all(disassociateCredentials);\n    const associateCredentials = added.map((cred) =>\n      JobTemplatesAPI.associateCredentials(template.id, cred.id)\n    );\n    const associatePromise = await Promise.all(associateCredentials);\n    return Promise.all([disassociatePromise, associatePromise]);\n  };\n\n  const handleCancel = () => history.push(detailsUrl);\n\n  const canEdit = template?.summary_fields?.user_capabilities?.edit;\n\n  if (!canEdit) {\n    return <Redirect to={detailsUrl} />;\n  }\n  if (isLoading) {\n    return <ContentLoading />;\n  }\n\n  return (\n    <CardBody>\n      <JobTemplateForm\n        template={template}\n        handleCancel={handleCancel}\n        handleSubmit={handleSubmit}\n        submitError={formSubmitError}\n        isOverrideDisabledLookup={!isDisabled}\n      />\n    </CardBody>\n  );\n}\n\nJobTemplateEdit.propTypes = {\n  template: JobTemplate.isRequired,\n};\nexport default JobTemplateEdit;\n"]},"metadata":{},"sourceType":"module"}