{"ast":null,"code":"import _toConsumableArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _objectWithoutProperties from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js\";import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";var _excluded=[\"labels\",\"inventory\",\"organization\",\"webhook_credential\",\"webhook_key\",\"limit\"];import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import React,{useState,useCallback,useEffect}from'react';import{useHistory}from'react-router-dom';import{Card,PageSection}from'@patternfly/react-core';import{CardBody}from'components/Card';import{WorkflowJobTemplatesAPI,OrganizationsAPI,UsersAPI}from'api';import{useConfig}from'contexts/Config';import useRequest from'hooks/useRequest';import ContentError from'components/ContentError';import ContentLoading from'components/ContentLoading';import WorkflowJobTemplateForm from'../shared/WorkflowJobTemplateForm';import{jsx as _jsx}from\"react/jsx-runtime\";function WorkflowJobTemplateAdd(){var _useConfig=useConfig(),_useConfig$me=_useConfig.me,me=_useConfig$me===void 0?{}:_useConfig$me;var history=useHistory();var _useState=useState(null),_useState2=_slicedToArray(_useState,2),formSubmitError=_useState2[0],setFormSubmitError=_useState2[1];var handleSubmit=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(values){var _inventory$summary_fi;var labels,inventory,organization,webhook_credential,webhook_key,limit,templatePayload,organizationId,_yield$WorkflowJobTem,id;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:labels=values.labels,inventory=values.inventory,organization=values.organization,webhook_credential=values.webhook_credential,webhook_key=values.webhook_key,limit=values.limit,templatePayload=_objectWithoutProperties(values,_excluded);templatePayload.inventory=inventory===null||inventory===void 0?void 0:inventory.id;templatePayload.organization=organization===null||organization===void 0?void 0:organization.id;templatePayload.webhook_credential=webhook_credential===null||webhook_credential===void 0?void 0:webhook_credential.id;templatePayload.limit=limit===''?null:limit;organizationId=(organization===null||organization===void 0?void 0:organization.id)||(inventory===null||inventory===void 0?void 0:(_inventory$summary_fi=inventory.summary_fields)===null||_inventory$summary_fi===void 0?void 0:_inventory$summary_fi.organization.id);_context.prev=6;_context.next=9;return WorkflowJobTemplatesAPI.create(templatePayload);case 9:_yield$WorkflowJobTem=_context.sent;id=_yield$WorkflowJobTem.data.id;_context.t0=Promise;_context.next=14;return submitLabels(id,organizationId,labels);case 14:_context.t1=_context.sent;_context.next=17;return _context.t0.all.call(_context.t0,_context.t1);case 17:history.push(\"/templates/workflow_job_template/\".concat(id,\"/visualizer\"));_context.next=23;break;case 20:_context.prev=20;_context.t2=_context[\"catch\"](6);setFormSubmitError(_context.t2);case 23:case\"end\":return _context.stop();}}},_callee,null,[[6,20]]);}));return function handleSubmit(_x){return _ref.apply(this,arguments);};}();var submitLabels=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(templateId,organizationId){var labels,_yield$OrganizationsA,results,associatePromises,_args2=arguments;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:labels=_args2.length>2&&_args2[2]!==undefined?_args2[2]:[];if(organizationId){_context2.next=13;break;}_context2.prev=2;_context2.next=5;return OrganizationsAPI.read();case 5:_yield$OrganizationsA=_context2.sent;results=_yield$OrganizationsA.data.results;organizationId=results[0].id;_context2.next=13;break;case 10:_context2.prev=10;_context2.t0=_context2[\"catch\"](2);throw _context2.t0;case 13:associatePromises=labels.map(function(label){return WorkflowJobTemplatesAPI.associateLabel(templateId,label,organizationId);});return _context2.abrupt(\"return\",_toConsumableArray(associatePromises));case 15:case\"end\":return _context2.stop();}}},_callee2,null,[[2,10]]);}));return function submitLabels(_x2,_x3){return _ref2.apply(this,arguments);};}();var handleCancel=function handleCancel(){history.push(\"/templates\");};var _useRequest=useRequest(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var _yield$UsersAPI$readA,_yield$UsersAPI$readA2,results,count;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return UsersAPI.readAdminOfOrganizations(me===null||me===void 0?void 0:me.id);case 2:_yield$UsersAPI$readA=_context3.sent;_yield$UsersAPI$readA2=_yield$UsersAPI$readA.data;results=_yield$UsersAPI$readA2.results;count=_yield$UsersAPI$readA2.count;return _context3.abrupt(\"return\",{isOrgAdmin:count>0,orgAdminResults:results});case 7:case\"end\":return _context3.stop();}}},_callee3);})),[me.id]),{isOrgAdmin:false,orgAdminResults:null}),isLoading=_useRequest.isLoading,fetchUserRole=_useRequest.request,_useRequest$result=_useRequest.result,orgAdminResults=_useRequest$result.orgAdminResults,isOrgAdmin=_useRequest$result.isOrgAdmin,contentError=_useRequest.error;useEffect(function(){fetchUserRole();},[fetchUserRole]);if(contentError){return/*#__PURE__*/_jsx(ContentError,{error:contentError});}if(isLoading||!orgAdminResults){return/*#__PURE__*/_jsx(ContentLoading,{});}return/*#__PURE__*/_jsx(PageSection,{children:/*#__PURE__*/_jsx(Card,{children:/*#__PURE__*/_jsx(CardBody,{children:/*#__PURE__*/_jsx(WorkflowJobTemplateForm,{handleCancel:handleCancel,handleSubmit:handleSubmit,submitError:formSubmitError,isOrgAdmin:isOrgAdmin})})})});}export default WorkflowJobTemplateAdd;","map":{"version":3,"sources":["/awx_devel/awx/ui/src/screens/Template/WorkflowJobTemplateAdd/WorkflowJobTemplateAdd.js"],"names":["React","useState","useCallback","useEffect","useHistory","Card","PageSection","CardBody","WorkflowJobTemplatesAPI","OrganizationsAPI","UsersAPI","useConfig","useRequest","ContentError","ContentLoading","WorkflowJobTemplateForm","WorkflowJobTemplateAdd","me","history","formSubmitError","setFormSubmitError","handleSubmit","values","labels","inventory","organization","webhook_credential","webhook_key","limit","templatePayload","id","organizationId","summary_fields","create","data","Promise","submitLabels","all","push","templateId","read","results","associatePromises","map","label","associateLabel","handleCancel","readAdminOfOrganizations","count","isOrgAdmin","orgAdminResults","isLoading","fetchUserRole","request","result","contentError","error"],"mappings":"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","sourcesContent":["import React, { useState, useCallback, useEffect } from 'react';\nimport { useHistory } from 'react-router-dom';\n\nimport { Card, PageSection } from '@patternfly/react-core';\nimport { CardBody } from 'components/Card';\n\nimport { WorkflowJobTemplatesAPI, OrganizationsAPI, UsersAPI } from 'api';\nimport { useConfig } from 'contexts/Config';\nimport useRequest from 'hooks/useRequest';\nimport ContentError from 'components/ContentError';\nimport ContentLoading from 'components/ContentLoading';\nimport WorkflowJobTemplateForm from '../shared/WorkflowJobTemplateForm';\n\nfunction WorkflowJobTemplateAdd() {\n  const { me = {} } = useConfig();\n  const history = useHistory();\n  const [formSubmitError, setFormSubmitError] = useState(null);\n\n  const handleSubmit = async (values) => {\n    const {\n      labels,\n      inventory,\n      organization,\n      webhook_credential,\n      webhook_key,\n      limit,\n      ...templatePayload\n    } = values;\n    templatePayload.inventory = inventory?.id;\n    templatePayload.organization = organization?.id;\n    templatePayload.webhook_credential = webhook_credential?.id;\n    templatePayload.limit = limit === '' ? null : limit;\n    const organizationId =\n      organization?.id || inventory?.summary_fields?.organization.id;\n    try {\n      const {\n        data: { id },\n      } = await WorkflowJobTemplatesAPI.create(templatePayload);\n      await Promise.all(await submitLabels(id, organizationId, labels));\n      history.push(`/templates/workflow_job_template/${id}/visualizer`);\n    } catch (err) {\n      setFormSubmitError(err);\n    }\n  };\n\n  const submitLabels = async (templateId, organizationId, labels = []) => {\n    if (!organizationId) {\n      // eslint-disable-next-line no-useless-catch\n      try {\n        const {\n          data: { results },\n        } = await OrganizationsAPI.read();\n        organizationId = results[0].id;\n      } catch (err) {\n        throw err;\n      }\n    }\n    const associatePromises = labels.map((label) =>\n      WorkflowJobTemplatesAPI.associateLabel(templateId, label, organizationId)\n    );\n    return [...associatePromises];\n  };\n\n  const handleCancel = () => {\n    history.push(`/templates`);\n  };\n\n  const {\n    isLoading,\n    request: fetchUserRole,\n    result: { orgAdminResults, isOrgAdmin },\n    error: contentError,\n  } = useRequest(\n    useCallback(async () => {\n      const {\n        data: { results, count },\n      } = await UsersAPI.readAdminOfOrganizations(me?.id);\n      return { isOrgAdmin: count > 0, orgAdminResults: results };\n    }, [me.id]),\n    { isOrgAdmin: false, orgAdminResults: null }\n  );\n\n  useEffect(() => {\n    fetchUserRole();\n  }, [fetchUserRole]);\n\n  if (contentError) {\n    return <ContentError error={contentError} />;\n  }\n\n  if (isLoading || !orgAdminResults) {\n    return <ContentLoading />;\n  }\n\n  return (\n    <PageSection>\n      <Card>\n        <CardBody>\n          <WorkflowJobTemplateForm\n            handleCancel={handleCancel}\n            handleSubmit={handleSubmit}\n            submitError={formSubmitError}\n            isOrgAdmin={isOrgAdmin}\n          />\n        </CardBody>\n      </Card>\n    </PageSection>\n  );\n}\n\nexport default WorkflowJobTemplateAdd;\n"]},"metadata":{},"sourceType":"module"}