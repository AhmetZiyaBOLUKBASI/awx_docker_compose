{"ast":null,"code":"import _objectSpread from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import{i18n}from\"@lingui/core\";import React,{useCallback,useEffect}from'react';import{useParams,useLocation}from'react-router-dom';import PaginatedTable,{HeaderCell,HeaderRow,ToolbarDeleteButton,getSearchableKeys}from'components/PaginatedTable';import{getQSConfig,parseQueryString}from'util/qs';import{TokensAPI,ApplicationsAPI}from'api';import ErrorDetail from'components/ErrorDetail';import AlertModal from'components/AlertModal';import useRequest,{useDeleteItems}from'hooks/useRequest';import useSelected from'hooks/useSelected';import DatalistToolbar from'components/DataListToolbar';import ApplicationTokenListItem from'./ApplicationTokenListItem';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";var QS_CONFIG=getQSConfig('applications',{page:1,page_size:20,order_by:'user__username'});function ApplicationTokenList(){var _useParams=useParams(),id=_useParams.id;var location=useLocation();var _useRequest=useRequest(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _actionsResponse$data,_actionsResponse$data2;var params,_yield$Promise$all,_yield$Promise$all2,_yield$Promise$all2$,results,count,actionsResponse,modifiedResults;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:params=parseQueryString(QS_CONFIG,location.search);_context.next=3;return Promise.all([ApplicationsAPI.readTokens(id,params),ApplicationsAPI.readTokenOptions(id)]);case 3:_yield$Promise$all=_context.sent;_yield$Promise$all2=_slicedToArray(_yield$Promise$all,2);_yield$Promise$all2$=_yield$Promise$all2[0].data;results=_yield$Promise$all2$.results;count=_yield$Promise$all2$.count;actionsResponse=_yield$Promise$all2[1];modifiedResults=results.map(function(result){var _result$summary_field;result.summary_fields={user:result.summary_fields.user,application:result.summary_fields.application,user_capabilities:{delete:true}};result.name=(_result$summary_field=result.summary_fields.user)===null||_result$summary_field===void 0?void 0:_result$summary_field.username;return result;});return _context.abrupt(\"return\",{tokens:modifiedResults,itemCount:count,relatedSearchableKeys:((actionsResponse===null||actionsResponse===void 0?void 0:(_actionsResponse$data=actionsResponse.data)===null||_actionsResponse$data===void 0?void 0:_actionsResponse$data.related_search_fields)||[]).map(function(val){return val.slice(0,-8);}),searchableKeys:getSearchableKeys((_actionsResponse$data2=actionsResponse.data.actions)===null||_actionsResponse$data2===void 0?void 0:_actionsResponse$data2.GET)});case 11:case\"end\":return _context.stop();}}},_callee);})),[id,location.search]),{tokens:[],itemCount:0,relatedSearchableKeys:[],searchableKeys:[]}),error=_useRequest.error,isLoading=_useRequest.isLoading,_useRequest$result=_useRequest.result,tokens=_useRequest$result.tokens,itemCount=_useRequest$result.itemCount,relatedSearchableKeys=_useRequest$result.relatedSearchableKeys,searchableKeys=_useRequest$result.searchableKeys,fetchTokens=_useRequest.request;useEffect(function(){fetchTokens();},[fetchTokens]);var _useSelected=useSelected(tokens),selected=_useSelected.selected,isAllSelected=_useSelected.isAllSelected,handleSelect=_useSelected.handleSelect,selectAll=_useSelected.selectAll,clearSelected=_useSelected.clearSelected;var _useDeleteItems=useDeleteItems(useCallback(function(){return Promise.all(selected.map(function(_ref2){var tokenId=_ref2.id;return TokensAPI.destroy(tokenId);}));},[selected]),{qsConfig:QS_CONFIG,allItemsSelected:isAllSelected,fetchItems:fetchTokens}),deleteLoading=_useDeleteItems.isLoading,deletionError=_useDeleteItems.deletionError,handleDeleteApplications=_useDeleteItems.deleteItems,clearDeletionError=_useDeleteItems.clearDeletionError;var handleDelete=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return handleDeleteApplications();case 2:clearSelected();case 3:case\"end\":return _context2.stop();}}},_callee2);}));return function handleDelete(){return _ref3.apply(this,arguments);};}();return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(PaginatedTable,{contentError:error,hasContentLoading:isLoading||deleteLoading,items:tokens,itemCount:itemCount,pluralizedItemName:/*i18n*/i18n._(\"Tokens\"),qsConfig:QS_CONFIG,toolbarSearchColumns:[{name:/*i18n*/i18n._(\"Name\"),key:'user__username__icontains',isDefault:true}],clearSelected:clearSelected,toolbarSearchableKeys:searchableKeys,toolbarRelatedSearchableKeys:relatedSearchableKeys,renderToolbar:function renderToolbar(props){return/*#__PURE__*/_jsx(DatalistToolbar,_objectSpread(_objectSpread({},props),{},{isAllSelected:isAllSelected,onSelectAll:selectAll,qsConfig:QS_CONFIG,additionalControls:[/*#__PURE__*/_jsx(ToolbarDeleteButton,{onDelete:handleDelete,itemsToDelete:selected,pluralizedItemName:/*i18n*/i18n._(\"Tokens\")},\"delete\")]}));},headerRow:/*#__PURE__*/_jsxs(HeaderRow,{qsConfig:QS_CONFIG,children:[/*#__PURE__*/_jsx(HeaderCell,{sortKey:\"user__username\",children:/*i18n*/i18n._(\"Name\")}),/*#__PURE__*/_jsx(HeaderCell,{sortKey:\"scope\",children:/*i18n*/i18n._(\"Scope\")}),/*#__PURE__*/_jsx(HeaderCell,{sortKey:\"expires\",children:/*i18n*/i18n._(\"Expires\")})]}),renderRow:function renderRow(token,index){return/*#__PURE__*/_jsx(ApplicationTokenListItem,{value:token.name,token:token,detailUrl:\"/users/\".concat(token.summary_fields.user.id,\"/details\"),onSelect:function onSelect(){return handleSelect(token);},isSelected:selected.some(function(row){return row.id===token.id;}),rowIndex:index},token.id);}}),/*#__PURE__*/_jsxs(AlertModal,{isOpen:deletionError,variant:\"error\",title:/*i18n*/i18n._(\"Error!\"),onClose:clearDeletionError,children:[/*i18n*/i18n._(\"Failed to delete one or more tokens.\"),/*#__PURE__*/_jsx(ErrorDetail,{error:deletionError})]})]});}export default ApplicationTokenList;","map":{"version":3,"sources":["/awx_devel/awx/ui/src/screens/Application/ApplicationTokens/ApplicationTokenList.js"],"names":["React","useCallback","useEffect","useParams","useLocation","PaginatedTable","HeaderCell","HeaderRow","ToolbarDeleteButton","getSearchableKeys","getQSConfig","parseQueryString","TokensAPI","ApplicationsAPI","ErrorDetail","AlertModal","useRequest","useDeleteItems","useSelected","DatalistToolbar","ApplicationTokenListItem","QS_CONFIG","page","page_size","order_by","ApplicationTokenList","id","location","params","search","Promise","all","readTokens","readTokenOptions","data","results","count","actionsResponse","modifiedResults","map","result","summary_fields","user","application","user_capabilities","delete","name","username","tokens","itemCount","relatedSearchableKeys","related_search_fields","val","slice","searchableKeys","actions","GET","error","isLoading","fetchTokens","request","selected","isAllSelected","handleSelect","selectAll","clearSelected","tokenId","destroy","qsConfig","allItemsSelected","fetchItems","deleteLoading","deletionError","handleDeleteApplications","deleteItems","clearDeletionError","handleDelete","key","isDefault","props","token","index","some","row"],"mappings":"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","sourcesContent":["import React, { useCallback, useEffect } from 'react';\nimport { useParams, useLocation } from 'react-router-dom';\nimport { t } from '@lingui/macro';\n\nimport PaginatedTable, {\n  HeaderCell,\n  HeaderRow,\n  ToolbarDeleteButton,\n  getSearchableKeys,\n} from 'components/PaginatedTable';\nimport { getQSConfig, parseQueryString } from 'util/qs';\nimport { TokensAPI, ApplicationsAPI } from 'api';\nimport ErrorDetail from 'components/ErrorDetail';\nimport AlertModal from 'components/AlertModal';\nimport useRequest, { useDeleteItems } from 'hooks/useRequest';\nimport useSelected from 'hooks/useSelected';\nimport DatalistToolbar from 'components/DataListToolbar';\nimport ApplicationTokenListItem from './ApplicationTokenListItem';\n\nconst QS_CONFIG = getQSConfig('applications', {\n  page: 1,\n  page_size: 20,\n  order_by: 'user__username',\n});\n\nfunction ApplicationTokenList() {\n  const { id } = useParams();\n  const location = useLocation();\n  const {\n    error,\n    isLoading,\n    result: { tokens, itemCount, relatedSearchableKeys, searchableKeys },\n    request: fetchTokens,\n  } = useRequest(\n    useCallback(async () => {\n      const params = parseQueryString(QS_CONFIG, location.search);\n      const [\n        {\n          data: { results, count },\n        },\n        actionsResponse,\n      ] = await Promise.all([\n        ApplicationsAPI.readTokens(id, params),\n        ApplicationsAPI.readTokenOptions(id),\n      ]);\n      const modifiedResults = results.map((result) => {\n        result.summary_fields = {\n          user: result.summary_fields.user,\n          application: result.summary_fields.application,\n          user_capabilities: { delete: true },\n        };\n        result.name = result.summary_fields.user?.username;\n        return result;\n      });\n      return {\n        tokens: modifiedResults,\n        itemCount: count,\n        relatedSearchableKeys: (\n          actionsResponse?.data?.related_search_fields || []\n        ).map((val) => val.slice(0, -8)),\n        searchableKeys: getSearchableKeys(actionsResponse.data.actions?.GET),\n      };\n    }, [id, location.search]),\n    { tokens: [], itemCount: 0, relatedSearchableKeys: [], searchableKeys: [] }\n  );\n\n  useEffect(() => {\n    fetchTokens();\n  }, [fetchTokens]);\n\n  const { selected, isAllSelected, handleSelect, selectAll, clearSelected } =\n    useSelected(tokens);\n  const {\n    isLoading: deleteLoading,\n    deletionError,\n    deleteItems: handleDeleteApplications,\n    clearDeletionError,\n  } = useDeleteItems(\n    useCallback(\n      () =>\n        Promise.all(\n          selected.map(({ id: tokenId }) => TokensAPI.destroy(tokenId))\n        ),\n      [selected]\n    ),\n    {\n      qsConfig: QS_CONFIG,\n      allItemsSelected: isAllSelected,\n      fetchItems: fetchTokens,\n    }\n  );\n\n  const handleDelete = async () => {\n    await handleDeleteApplications();\n    clearSelected();\n  };\n\n  return (\n    <>\n      <PaginatedTable\n        contentError={error}\n        hasContentLoading={isLoading || deleteLoading}\n        items={tokens}\n        itemCount={itemCount}\n        pluralizedItemName={t`Tokens`}\n        qsConfig={QS_CONFIG}\n        toolbarSearchColumns={[\n          {\n            name: t`Name`,\n            key: 'user__username__icontains',\n            isDefault: true,\n          },\n        ]}\n        clearSelected={clearSelected}\n        toolbarSearchableKeys={searchableKeys}\n        toolbarRelatedSearchableKeys={relatedSearchableKeys}\n        renderToolbar={(props) => (\n          <DatalistToolbar\n            {...props}\n            isAllSelected={isAllSelected}\n            onSelectAll={selectAll}\n            qsConfig={QS_CONFIG}\n            additionalControls={[\n              <ToolbarDeleteButton\n                key=\"delete\"\n                onDelete={handleDelete}\n                itemsToDelete={selected}\n                pluralizedItemName={t`Tokens`}\n              />,\n            ]}\n          />\n        )}\n        headerRow={\n          <HeaderRow qsConfig={QS_CONFIG}>\n            <HeaderCell sortKey=\"user__username\">{t`Name`}</HeaderCell>\n            <HeaderCell sortKey=\"scope\">{t`Scope`}</HeaderCell>\n            <HeaderCell sortKey=\"expires\">{t`Expires`}</HeaderCell>\n          </HeaderRow>\n        }\n        renderRow={(token, index) => (\n          <ApplicationTokenListItem\n            key={token.id}\n            value={token.name}\n            token={token}\n            detailUrl={`/users/${token.summary_fields.user.id}/details`}\n            onSelect={() => handleSelect(token)}\n            isSelected={selected.some((row) => row.id === token.id)}\n            rowIndex={index}\n          />\n        )}\n      />\n      <AlertModal\n        isOpen={deletionError}\n        variant=\"error\"\n        title={t`Error!`}\n        onClose={clearDeletionError}\n      >\n        {t`Failed to delete one or more tokens.`}\n        <ErrorDetail error={deletionError} />\n      </AlertModal>\n    </>\n  );\n}\n\nexport default ApplicationTokenList;\n"]},"metadata":{},"sourceType":"module"}