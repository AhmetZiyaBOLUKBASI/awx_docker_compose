{"ast":null,"code":"import _toConsumableArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _objectSpread from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import{i18n}from\"@lingui/core\";import React,{useCallback,useEffect,useState}from'react';import{useLocation,useParams}from'react-router-dom';import useExpanded from'hooks/useExpanded';import DataListToolbar from'components/DataListToolbar';import PaginatedTable,{HeaderRow,HeaderCell,ToolbarAddButton,getSearchableKeys}from'components/PaginatedTable';import DisassociateButton from'components/DisassociateButton';import AssociateModal from'components/AssociateModal';import AlertModal from'components/AlertModal';import ErrorDetail from'components/ErrorDetail';import useRequest,{useDeleteItems,useDismissableError}from'hooks/useRequest';import useSelected from'hooks/useSelected';import{InstanceGroupsAPI,InstancesAPI}from'api';import{getQSConfig,parseQueryString,mergeParams}from'util/qs';import HealthCheckButton from'components/HealthCheckButton/HealthCheckButton';import InstanceListItem from'./InstanceListItem';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";var QS_CONFIG=getQSConfig('instance',{page:1,page_size:20,order_by:'hostname'});function InstanceList(_ref){var instanceGroup=_ref.instanceGroup;var _useState=useState(false),_useState2=_slicedToArray(_useState,2),isModalOpen=_useState2[0],setIsModalOpen=_useState2[1];var location=useLocation();var _useParams=useParams(),instanceGroupId=_useParams.id;var _useRequest=useRequest(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _responseActions$data,_responseActions$data2;var params,_yield$Promise$all,_yield$Promise$all2,response,responseActions;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:params=parseQueryString(QS_CONFIG,location.search);_context.next=3;return Promise.all([InstanceGroupsAPI.readInstances(instanceGroupId,params),InstanceGroupsAPI.readInstanceOptions(instanceGroupId)]);case 3:_yield$Promise$all=_context.sent;_yield$Promise$all2=_slicedToArray(_yield$Promise$all,2);response=_yield$Promise$all2[0];responseActions=_yield$Promise$all2[1];return _context.abrupt(\"return\",{instances:response.data.results,count:response.data.count,actions:responseActions.data.actions,relatedSearchableKeys:((responseActions===null||responseActions===void 0?void 0:(_responseActions$data=responseActions.data)===null||_responseActions$data===void 0?void 0:_responseActions$data.related_search_fields)||[]).map(function(val){return val.slice(0,-8);}),searchableKeys:getSearchableKeys((_responseActions$data2=responseActions.data.actions)===null||_responseActions$data2===void 0?void 0:_responseActions$data2.GET)});case 8:case\"end\":return _context.stop();}}},_callee);})),[location.search,instanceGroupId]),{instances:[],count:0,actions:{},relatedSearchableKeys:[],searchableKeys:[]}),_useRequest$result=_useRequest.result,instances=_useRequest$result.instances,count=_useRequest$result.count,actions=_useRequest$result.actions,relatedSearchableKeys=_useRequest$result.relatedSearchableKeys,searchableKeys=_useRequest$result.searchableKeys,contentError=_useRequest.error,isLoading=_useRequest.isLoading,fetchInstances=_useRequest.request;var _useSelected=useSelected(instances),selected=_useSelected.selected,isAllSelected=_useSelected.isAllSelected,handleSelect=_useSelected.handleSelect,clearSelected=_useSelected.clearSelected,selectAll=_useSelected.selectAll;useEffect(function(){fetchInstances();},[fetchInstances]);var _useRequest2=useRequest(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return Promise.all(selected.map(function(_ref4){var id=_ref4.id;return InstancesAPI.healthCheck(id);}));case 2:fetchInstances();case 3:case\"end\":return _context2.stop();}}},_callee2);})),[selected,fetchInstances])),healthCheckError=_useRequest2.error,fetchHealthCheck=_useRequest2.request,isHealthCheckLoading=_useRequest2.isLoading;var handleHealthCheck=/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return fetchHealthCheck();case 2:clearSelected();case 3:case\"end\":return _context3.stop();}}},_callee3);}));return function handleHealthCheck(){return _ref5.apply(this,arguments);};}();var _useDeleteItems=useDeleteItems(useCallback(function(){return Promise.all(selected.filter(function(s){return s.node_type!=='control';}).map(function(instance){return InstanceGroupsAPI.disassociateInstance(instanceGroupId,instance.id);}));},[instanceGroupId,selected]),{qsConfig:QS_CONFIG,allItemsSelected:isAllSelected,fetchItems:fetchInstances}),isDisassociateLoading=_useDeleteItems.isLoading,disassociateInstances=_useDeleteItems.deleteItems,disassociateError=_useDeleteItems.deletionError;var _useRequest3=useRequest(useCallback(/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(instancesToAssociate){return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return Promise.all(instancesToAssociate.filter(function(i){return i.node_type!=='control'||i.node_type!=='hop';}).map(function(instance){return InstanceGroupsAPI.associateInstance(instanceGroupId,instance.id);}));case 2:fetchInstances();case 3:case\"end\":return _context4.stop();}}},_callee4);}));return function(_x){return _ref6.apply(this,arguments);};}(),[instanceGroupId,fetchInstances])),handleAssociate=_useRequest3.request,associateError=_useRequest3.error;var handleDisassociate=/*#__PURE__*/function(){var _ref7=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(){return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.next=2;return disassociateInstances();case 2:clearSelected();case 3:case\"end\":return _context5.stop();}}},_callee5);}));return function handleDisassociate(){return _ref7.apply(this,arguments);};}();var _useDismissableError=useDismissableError(associateError||disassociateError||healthCheckError),error=_useDismissableError.error,dismissError=_useDismissableError.dismissError;var canAdd=actions&&Object.prototype.hasOwnProperty.call(actions,'POST');var fetchInstancesToAssociate=useCallback(function(params){return InstancesAPI.read(mergeParams(params,_objectSpread(_objectSpread({},{not__rampart_groups__id:instanceGroupId}),{not__node_type:['hop','control']})));},[instanceGroupId]);var readInstancesOptions=useCallback(function(){return InstanceGroupsAPI.readInstanceOptions(instanceGroupId);},[instanceGroupId]);var _useExpanded=useExpanded(instances),expanded=_useExpanded.expanded,isAllExpanded=_useExpanded.isAllExpanded,handleExpand=_useExpanded.handleExpand,expandAll=_useExpanded.expandAll;return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(PaginatedTable,{contentError:contentError,hasContentLoading:isLoading||isDisassociateLoading||isHealthCheckLoading,items:instances,itemCount:count,pluralizedItemName:/*i18n*/i18n._(\"Instances\"),qsConfig:QS_CONFIG,clearSelected:clearSelected,toolbarSearchableKeys:searchableKeys,toolbarRelatedSearchableKeys:relatedSearchableKeys,toolbarSearchColumns:[{name:/*i18n*/i18n._(\"Name\"),key:'hostname__icontains',isDefault:true},{name:/*i18n*/i18n._(\"Node Type\"),key:\"or__node_type\",options:[[\"control\",/*i18n*/i18n._(\"Control\")],[\"execution\",/*i18n*/i18n._(\"Execution\")],[\"hybrid\",/*i18n*/i18n._(\"Hybrid\")]]}],toolbarSortColumns:[{name:/*i18n*/i18n._(\"Name\"),key:'hostname'}],renderToolbar:function renderToolbar(props){return/*#__PURE__*/_jsx(DataListToolbar,_objectSpread(_objectSpread({},props),{},{isAllSelected:isAllSelected,onSelectAll:selectAll,isAllExpanded:isAllExpanded,onExpandAll:expandAll,qsConfig:QS_CONFIG,additionalControls:[].concat(_toConsumableArray(canAdd?[/*#__PURE__*/_jsx(ToolbarAddButton,{onClick:function onClick(){return setIsModalOpen(true);},defaultLabel:/*i18n*/i18n._(\"Associate\")},\"associate\")]:[]),[/*#__PURE__*/_jsx(DisassociateButton,{verifyCannotDisassociate:selected.some(function(s){return s.node_type==='control';})||instanceGroup.name==='controlplane',onDisassociate:handleDisassociate,itemsToDisassociate:selected,modalTitle:/*i18n*/i18n._(\"Disassociate instance from instance group?\"),isProtectedInstanceGroup:instanceGroup.name==='controlplane'},\"disassociate\"),/*#__PURE__*/_jsx(HealthCheckButton,{isDisabled:!canAdd,onClick:handleHealthCheck,selectedItems:selected})]),emptyStateControls:canAdd?/*#__PURE__*/_jsx(ToolbarAddButton,{onClick:function onClick(){return setIsModalOpen(true);}},\"add\"):null}));},headerRow:/*#__PURE__*/_jsxs(HeaderRow,{qsConfig:QS_CONFIG,isExpandable:true,children:[/*#__PURE__*/_jsx(HeaderCell,{sortKey:\"hostname\",children:/*i18n*/i18n._(\"Name\")}),/*#__PURE__*/_jsx(HeaderCell,{sortKey:\"errors\",children:/*i18n*/i18n._(\"Status\")}),/*#__PURE__*/_jsx(HeaderCell,{sortKey:\"node_type\",children:/*i18n*/i18n._(\"Node Type\")}),/*#__PURE__*/_jsx(HeaderCell,{children:/*i18n*/i18n._(\"Capacity Adjustment\")}),/*#__PURE__*/_jsx(HeaderCell,{children:/*i18n*/i18n._(\"Used Capacity\")}),/*#__PURE__*/_jsx(HeaderCell,{children:/*i18n*/i18n._(\"Actions\")})]}),renderRow:function renderRow(instance,index){return/*#__PURE__*/_jsx(InstanceListItem,{isExpanded:expanded.some(function(row){return row.id===instance.id;}),onExpand:function onExpand(){return handleExpand(instance);},value:instance.hostname,instance:instance,onSelect:function onSelect(){return handleSelect(instance);},isSelected:selected.some(function(row){return row.id===instance.id;}),fetchInstances:fetchInstances,rowIndex:index},instance.id);}}),isModalOpen&&/*#__PURE__*/_jsx(AssociateModal,{header:/*i18n*/i18n._(\"Instances\"),fetchRequest:fetchInstancesToAssociate,isModalOpen:isModalOpen,onAssociate:handleAssociate,onClose:function onClose(){return setIsModalOpen(false);},title:/*i18n*/i18n._(\"Select Instances\"),optionsRequest:readInstancesOptions,displayKey:\"hostname\",columns:[{key:'hostname',name:/*i18n*/i18n._(\"Name\")},{key:'node_type',name:/*i18n*/i18n._(\"Node Type\")}]}),error&&/*#__PURE__*/_jsxs(AlertModal,{isOpen:error,onClose:dismissError,title:/*i18n*/i18n._(\"Error!\"),variant:\"error\",children:[associateError&&/*i18n*/i18n._(\"Failed to associate.\"),disassociateError&&/*i18n*/i18n._(\"Failed to disassociate one or more instances.\"),healthCheckError&&/*i18n*/i18n._(\"Failed to run a health check on one or more instances.\"),/*#__PURE__*/_jsx(ErrorDetail,{error:error})]})]});}export default InstanceList;","map":{"version":3,"sources":["/awx_devel/awx/ui/src/screens/InstanceGroup/Instances/InstanceList.js"],"names":["React","useCallback","useEffect","useState","useLocation","useParams","useExpanded","DataListToolbar","PaginatedTable","HeaderRow","HeaderCell","ToolbarAddButton","getSearchableKeys","DisassociateButton","AssociateModal","AlertModal","ErrorDetail","useRequest","useDeleteItems","useDismissableError","useSelected","InstanceGroupsAPI","InstancesAPI","getQSConfig","parseQueryString","mergeParams","HealthCheckButton","InstanceListItem","QS_CONFIG","page","page_size","order_by","InstanceList","instanceGroup","isModalOpen","setIsModalOpen","location","instanceGroupId","id","params","search","Promise","all","readInstances","readInstanceOptions","response","responseActions","instances","data","results","count","actions","relatedSearchableKeys","related_search_fields","map","val","slice","searchableKeys","GET","result","contentError","error","isLoading","fetchInstances","request","selected","isAllSelected","handleSelect","clearSelected","selectAll","healthCheck","healthCheckError","fetchHealthCheck","isHealthCheckLoading","handleHealthCheck","filter","s","node_type","instance","disassociateInstance","qsConfig","allItemsSelected","fetchItems","isDisassociateLoading","disassociateInstances","deleteItems","disassociateError","deletionError","instancesToAssociate","i","associateInstance","handleAssociate","associateError","handleDisassociate","dismissError","canAdd","Object","prototype","hasOwnProperty","call","fetchInstancesToAssociate","read","not__rampart_groups__id","not__node_type","readInstancesOptions","expanded","isAllExpanded","handleExpand","expandAll","name","key","isDefault","options","props","some","index","row","hostname"],"mappings":"4iBAAA,MAAOA,CAAAA,KAAP,EAAgBC,WAAhB,CAA6BC,SAA7B,CAAwCC,QAAxC,KAAwD,OAAxD,CAEA,OAASC,WAAT,CAAsBC,SAAtB,KAAuC,kBAAvC,CAGA,MAAOC,CAAAA,WAAP,KAAwB,mBAAxB,CACA,MAAOC,CAAAA,eAAP,KAA4B,4BAA5B,CACA,MAAOC,CAAAA,cAAP,EACEC,SADF,CAEEC,UAFF,CAGEC,gBAHF,CAIEC,iBAJF,KAKO,2BALP,CAMA,MAAOC,CAAAA,kBAAP,KAA+B,+BAA/B,CACA,MAAOC,CAAAA,cAAP,KAA2B,2BAA3B,CACA,MAAOC,CAAAA,UAAP,KAAuB,uBAAvB,CACA,MAAOC,CAAAA,WAAP,KAAwB,wBAAxB,CACA,MAAOC,CAAAA,UAAP,EACEC,cADF,CAEEC,mBAFF,KAGO,kBAHP,CAIA,MAAOC,CAAAA,WAAP,KAAwB,mBAAxB,CACA,OAASC,iBAAT,CAA4BC,YAA5B,KAAgD,KAAhD,CACA,OAASC,WAAT,CAAsBC,gBAAtB,CAAwCC,WAAxC,KAA2D,SAA3D,CACA,MAAOC,CAAAA,iBAAP,KAA8B,gDAA9B,CACA,MAAOC,CAAAA,gBAAP,KAA6B,oBAA7B,C,6IAEA,GAAMC,CAAAA,SAAS,CAAGL,WAAW,CAAC,UAAD,CAAa,CACxCM,IAAI,CAAE,CADkC,CAExCC,SAAS,CAAE,EAF6B,CAGxCC,QAAQ,CAAE,UAH8B,CAAb,CAA7B,CAMA,QAASC,CAAAA,YAAT,MAAyC,IAAjBC,CAAAA,aAAiB,MAAjBA,aAAiB,CACvC,cAAsC9B,QAAQ,CAAC,KAAD,CAA9C,wCAAO+B,WAAP,eAAoBC,cAApB,eACA,GAAMC,CAAAA,QAAQ,CAAGhC,WAAW,EAA5B,CACA,eAAgCC,SAAS,EAAzC,CAAYgC,eAAZ,YAAQC,EAAR,CAEA,gBAWIrB,UAAU,CACZhB,WAAW,sEAAC,+PACJsC,MADI,CACKf,gBAAgB,CAACI,SAAD,CAAYQ,QAAQ,CAACI,MAArB,CADrB,uBAEgCC,CAAAA,OAAO,CAACC,GAAR,CAAY,CACpDrB,iBAAiB,CAACsB,aAAlB,CAAgCN,eAAhC,CAAiDE,MAAjD,CADoD,CAEpDlB,iBAAiB,CAACuB,mBAAlB,CAAsCP,eAAtC,CAFoD,CAAZ,CAFhC,kGAEHQ,QAFG,wBAEOC,eAFP,wDAMH,CACLC,SAAS,CAAEF,QAAQ,CAACG,IAAT,CAAcC,OADpB,CAELC,KAAK,CAAEL,QAAQ,CAACG,IAAT,CAAcE,KAFhB,CAGLC,OAAO,CAAEL,eAAe,CAACE,IAAhB,CAAqBG,OAHzB,CAILC,qBAAqB,CAAE,CACrB,CAAAN,eAAe,OAAf,EAAAA,eAAe,SAAf,+BAAAA,eAAe,CAAEE,IAAjB,sEAAuBK,qBAAvB,GAAgD,EAD3B,EAErBC,GAFqB,CAEjB,SAACC,GAAD,QAASA,CAAAA,GAAG,CAACC,KAAJ,CAAU,CAAV,CAAa,CAAC,CAAd,CAAT,EAFiB,CAJlB,CAOLC,cAAc,CAAE7C,iBAAiB,yBAACkC,eAAe,CAACE,IAAhB,CAAqBG,OAAtB,iDAAC,uBAA8BO,GAA/B,CAP5B,CANG,wDAAD,GAeR,CAACtB,QAAQ,CAACI,MAAV,CAAkBH,eAAlB,CAfQ,CADC,CAiBZ,CACEU,SAAS,CAAE,EADb,CAEEG,KAAK,CAAE,CAFT,CAGEC,OAAO,CAAE,EAHX,CAIEC,qBAAqB,CAAE,EAJzB,CAKEK,cAAc,CAAE,EALlB,CAjBY,CAXd,gCACEE,MADF,CAEIZ,SAFJ,oBAEIA,SAFJ,CAGIG,KAHJ,oBAGIA,KAHJ,CAIIC,OAJJ,oBAIIA,OAJJ,CAKIC,qBALJ,oBAKIA,qBALJ,CAMIK,cANJ,oBAMIA,cANJ,CAQSG,YART,aAQEC,KARF,CASEC,SATF,aASEA,SATF,CAUWC,cAVX,aAUEC,OAVF,CAqCA,iBACE5C,WAAW,CAAC2B,SAAD,CADb,CAAQkB,QAAR,cAAQA,QAAR,CAAkBC,aAAlB,cAAkBA,aAAlB,CAAiCC,YAAjC,cAAiCA,YAAjC,CAA+CC,aAA/C,cAA+CA,aAA/C,CAA8DC,SAA9D,cAA8DA,SAA9D,CAGAnE,SAAS,CAAC,UAAM,CACd6D,cAAc,GACf,CAFQ,CAEN,CAACA,cAAD,CAFM,CAAT,CAIA,iBAII9C,UAAU,CACZhB,WAAW,sEAAC,+JACJwC,CAAAA,OAAO,CAACC,GAAR,CAAYuB,QAAQ,CAACX,GAAT,CAAa,mBAAGhB,CAAAA,EAAH,OAAGA,EAAH,OAAYhB,CAAAA,YAAY,CAACgD,WAAb,CAAyBhC,EAAzB,CAAZ,EAAb,CAAZ,CADI,QAEVyB,cAAc,GAFJ,wDAAD,GAGR,CAACE,QAAD,CAAWF,cAAX,CAHQ,CADC,CAJd,CACSQ,gBADT,cACEV,KADF,CAEWW,gBAFX,cAEER,OAFF,CAGaS,oBAHb,cAGEX,SAHF,CAWA,GAAMY,CAAAA,iBAAiB,2FAAG,+JAClBF,CAAAA,gBAAgB,EADE,QAExBJ,aAAa,GAFW,wDAAH,kBAAjBM,CAAAA,iBAAiB,2CAAvB,CAKA,oBAIIxD,cAAc,CAChBjB,WAAW,CACT,iBACEwC,CAAAA,OAAO,CAACC,GAAR,CACEuB,QAAQ,CACLU,MADH,CACU,SAACC,CAAD,QAAOA,CAAAA,CAAC,CAACC,SAAF,GAAgB,SAAvB,EADV,EAEGvB,GAFH,CAEO,SAACwB,QAAD,QACHzD,CAAAA,iBAAiB,CAAC0D,oBAAlB,CACE1C,eADF,CAEEyC,QAAQ,CAACxC,EAFX,CADG,EAFP,CADF,CADF,EADS,CAYT,CAACD,eAAD,CAAkB4B,QAAlB,CAZS,CADK,CAehB,CACEe,QAAQ,CAAEpD,SADZ,CAEEqD,gBAAgB,CAAEf,aAFpB,CAGEgB,UAAU,CAAEnB,cAHd,CAfgB,CAJlB,CACaoB,qBADb,iBACErB,SADF,CAEesB,qBAFf,iBAEEC,WAFF,CAGiBC,iBAHjB,iBAGEC,aAHF,CA0BA,iBAA4DtE,UAAU,CACpEhB,WAAW,2FACT,kBAAOuF,oBAAP,6IACQ/C,CAAAA,OAAO,CAACC,GAAR,CACJ8C,oBAAoB,CACjBb,MADH,CACU,SAACc,CAAD,QAAOA,CAAAA,CAAC,CAACZ,SAAF,GAAgB,SAAhB,EAA6BY,CAAC,CAACZ,SAAF,GAAgB,KAApD,EADV,EAEGvB,GAFH,CAEO,SAACwB,QAAD,QACHzD,CAAAA,iBAAiB,CAACqE,iBAAlB,CAAoCrD,eAApC,CAAqDyC,QAAQ,CAACxC,EAA9D,CADG,EAFP,CADI,CADR,QAQEyB,cAAc,GARhB,wDADS,gEAWT,CAAC1B,eAAD,CAAkB0B,cAAlB,CAXS,CADyD,CAAtE,CAAiB4B,eAAjB,cAAQ3B,OAAR,CAAyC4B,cAAzC,cAAkC/B,KAAlC,CAgBA,GAAMgC,CAAAA,kBAAkB,2FAAG,+JACnBT,CAAAA,qBAAqB,EADF,QAEzBhB,aAAa,GAFY,wDAAH,kBAAlByB,CAAAA,kBAAkB,2CAAxB,CAKA,yBAAgC1E,mBAAmB,CACjDyE,cAAc,EAAIN,iBAAlB,EAAuCf,gBADU,CAAnD,CAAQV,KAAR,sBAAQA,KAAR,CAAeiC,YAAf,sBAAeA,YAAf,CAIA,GAAMC,CAAAA,MAAM,CACV5C,OAAO,EAAI6C,MAAM,CAACC,SAAP,CAAiBC,cAAjB,CAAgCC,IAAhC,CAAqChD,OAArC,CAA8C,MAA9C,CADb,CAGA,GAAMiD,CAAAA,yBAAyB,CAAGnG,WAAW,CAC3C,SAACsC,MAAD,QACEjB,CAAAA,YAAY,CAAC+E,IAAb,CACE5E,WAAW,CAACc,MAAD,gCACN,CAAE+D,uBAAuB,CAAEjE,eAA3B,CADM,EAEN,CAAEkE,cAAc,CAAE,CAAC,KAAD,CAAQ,SAAR,CAAlB,CAFM,EADb,CADF,EAD2C,CAQ3C,CAAClE,eAAD,CAR2C,CAA7C,CAWA,GAAMmE,CAAAA,oBAAoB,CAAGvG,WAAW,CACtC,iBAAMoB,CAAAA,iBAAiB,CAACuB,mBAAlB,CAAsCP,eAAtC,CAAN,EADsC,CAEtC,CAACA,eAAD,CAFsC,CAAxC,CAKA,iBACE/B,WAAW,CAACyC,SAAD,CADb,CAAQ0D,QAAR,cAAQA,QAAR,CAAkBC,aAAlB,cAAkBA,aAAlB,CAAiCC,YAAjC,cAAiCA,YAAjC,CAA+CC,SAA/C,cAA+CA,SAA/C,CAGA,mBACE,wCACE,KAAC,cAAD,EACE,YAAY,CAAEhD,YADhB,CAEE,iBAAiB,CACfE,SAAS,EAAIqB,qBAAb,EAAsCV,oBAH1C,CAKE,KAAK,CAAE1B,SALT,CAME,SAAS,CAAEG,KANb,CAOE,kBAAkB,SAAE,mBAPtB,CAQE,QAAQ,CAAEtB,SARZ,CASE,aAAa,CAAEwC,aATjB,CAUE,qBAAqB,CAAEX,cAVzB,CAWE,4BAA4B,CAAEL,qBAXhC,CAYE,oBAAoB,CAAE,CACpB,CACEyD,IAAI,SAAE,cADR,CAEEC,GAAG,CAAE,qBAFP,CAGEC,SAAS,CAAE,IAHb,CADoB,CAMpB,CACEF,IAAI,SAAE,mBADR,CAEEC,GAAG,gBAFL,CAGEE,OAAO,CAAE,CACP,mBAAY,iBAAZ,CADO,CAEP,qBAAc,mBAAd,CAFO,CAGP,kBAAW,gBAAX,CAHO,CAHX,CANoB,CAZxB,CA4BE,kBAAkB,CAAE,CAClB,CACEH,IAAI,SAAE,cADR,CAEEC,GAAG,CAAE,UAFP,CADkB,CA5BtB,CAkCE,aAAa,CAAE,uBAACG,KAAD,qBACb,KAAC,eAAD,gCACMA,KADN,MAEE,aAAa,CAAE/C,aAFjB,CAGE,WAAW,CAAEG,SAHf,CAIE,aAAa,CAAEqC,aAJjB,CAKE,WAAW,CAAEE,SALf,CAME,QAAQ,CAAEhF,SANZ,CAOE,kBAAkB,8BACZmE,MAAM,CACN,cACE,KAAC,gBAAD,EAEE,OAAO,CAAE,yBAAM5D,CAAAA,cAAc,CAAC,IAAD,CAApB,EAFX,CAGE,YAAY,SAAE,mBAHhB,EACM,WADN,CADF,CADM,CAQN,EATY,gBAUhB,KAAC,kBAAD,EACE,wBAAwB,CACtB8B,QAAQ,CAACiD,IAAT,CAAc,SAACtC,CAAD,QAAOA,CAAAA,CAAC,CAACC,SAAF,GAAgB,SAAvB,EAAd,GACA5C,aAAa,CAAC4E,IAAd,GAAuB,cAH3B,CAME,cAAc,CAAEhB,kBANlB,CAOE,mBAAmB,CAAE5B,QAPvB,CAQE,UAAU,SAAE,oDARd,CASE,wBAAwB,CAAEhC,aAAa,CAAC4E,IAAd,GAAuB,cATnD,EAKM,cALN,CAVgB,cAqBhB,KAAC,iBAAD,EACE,UAAU,CAAE,CAACd,MADf,CAEE,OAAO,CAAErB,iBAFX,CAGE,aAAa,CAAET,QAHjB,EArBgB,EAPpB,CAkCE,kBAAkB,CAChB8B,MAAM,cACJ,KAAC,gBAAD,EAEE,OAAO,CAAE,yBAAM5D,CAAAA,cAAc,CAAC,IAAD,CAApB,EAFX,EACM,KADN,CADI,CAKF,IAxCR,GADa,EAlCjB,CA+EE,SAAS,cACP,MAAC,SAAD,EAAW,QAAQ,CAAEP,SAArB,CAAgC,YAAY,KAA5C,wBACE,KAAC,UAAD,EAAY,OAAO,CAAC,UAApB,kBAAgC,cAAhC,EADF,cAEE,KAAC,UAAD,EAAY,OAAO,CAAC,QAApB,kBAA8B,gBAA9B,EAFF,cAGE,KAAC,UAAD,EAAY,OAAO,CAAC,WAApB,kBAAiC,mBAAjC,EAHF,cAIE,KAAC,UAAD,mBAAa,6BAAb,EAJF,cAKE,KAAC,UAAD,mBAAa,uBAAb,EALF,cAME,KAAC,UAAD,mBAAa,iBAAb,EANF,GAhFJ,CAyFE,SAAS,CAAE,mBAACkD,QAAD,CAAWqC,KAAX,qBACT,KAAC,gBAAD,EACE,UAAU,CAAEV,QAAQ,CAACS,IAAT,CAAc,SAACE,GAAD,QAASA,CAAAA,GAAG,CAAC9E,EAAJ,GAAWwC,QAAQ,CAACxC,EAA7B,EAAd,CADd,CAEE,QAAQ,CAAE,0BAAMqE,CAAAA,YAAY,CAAC7B,QAAD,CAAlB,EAFZ,CAIE,KAAK,CAAEA,QAAQ,CAACuC,QAJlB,CAKE,QAAQ,CAAEvC,QALZ,CAME,QAAQ,CAAE,0BAAMX,CAAAA,YAAY,CAACW,QAAD,CAAlB,EANZ,CAOE,UAAU,CAAEb,QAAQ,CAACiD,IAAT,CAAc,SAACE,GAAD,QAASA,CAAAA,GAAG,CAAC9E,EAAJ,GAAWwC,QAAQ,CAACxC,EAA7B,EAAd,CAPd,CAQE,cAAc,CAAEyB,cARlB,CASE,QAAQ,CAAEoD,KATZ,EAGOrC,QAAQ,CAACxC,EAHhB,CADS,EAzFb,EADF,CAwGGJ,WAAW,eACV,KAAC,cAAD,EACE,MAAM,SAAE,mBADV,CAEE,YAAY,CAAEkE,yBAFhB,CAGE,WAAW,CAAElE,WAHf,CAIE,WAAW,CAAEyD,eAJf,CAKE,OAAO,CAAE,yBAAMxD,CAAAA,cAAc,CAAC,KAAD,CAApB,EALX,CAME,KAAK,SAAE,0BANT,CAOE,cAAc,CAAEqE,oBAPlB,CAQE,UAAU,CAAC,UARb,CASE,OAAO,CAAE,CACP,CAAEM,GAAG,CAAE,UAAP,CAAmBD,IAAI,SAAE,cAAzB,CADO,CAEP,CAAEC,GAAG,CAAE,WAAP,CAAoBD,IAAI,SAAE,mBAA1B,CAFO,CATX,EAzGJ,CAwHGhD,KAAK,eACJ,MAAC,UAAD,EACE,MAAM,CAAEA,KADV,CAEE,OAAO,CAAEiC,YAFX,CAGE,KAAK,SAAE,gBAHT,CAIE,OAAO,CAAC,OAJV,WAMGF,cAAc,UAAI,8BANrB,CAOGN,iBAAiB,UAChB,uDARJ,CASGf,gBAAgB,UACf,gEAVJ,cAWE,KAAC,WAAD,EAAa,KAAK,CAAEV,KAApB,EAXF,GAzHJ,GADF,CA0ID,CAED,cAAe7B,CAAAA,YAAf","sourcesContent":["import React, { useCallback, useEffect, useState } from 'react';\nimport { t } from '@lingui/macro';\nimport { useLocation, useParams } from 'react-router-dom';\nimport 'styled-components/macro';\n\nimport useExpanded from 'hooks/useExpanded';\nimport DataListToolbar from 'components/DataListToolbar';\nimport PaginatedTable, {\n  HeaderRow,\n  HeaderCell,\n  ToolbarAddButton,\n  getSearchableKeys,\n} from 'components/PaginatedTable';\nimport DisassociateButton from 'components/DisassociateButton';\nimport AssociateModal from 'components/AssociateModal';\nimport AlertModal from 'components/AlertModal';\nimport ErrorDetail from 'components/ErrorDetail';\nimport useRequest, {\n  useDeleteItems,\n  useDismissableError,\n} from 'hooks/useRequest';\nimport useSelected from 'hooks/useSelected';\nimport { InstanceGroupsAPI, InstancesAPI } from 'api';\nimport { getQSConfig, parseQueryString, mergeParams } from 'util/qs';\nimport HealthCheckButton from 'components/HealthCheckButton/HealthCheckButton';\nimport InstanceListItem from './InstanceListItem';\n\nconst QS_CONFIG = getQSConfig('instance', {\n  page: 1,\n  page_size: 20,\n  order_by: 'hostname',\n});\n\nfunction InstanceList({ instanceGroup }) {\n  const [isModalOpen, setIsModalOpen] = useState(false);\n  const location = useLocation();\n  const { id: instanceGroupId } = useParams();\n\n  const {\n    result: {\n      instances,\n      count,\n      actions,\n      relatedSearchableKeys,\n      searchableKeys,\n    },\n    error: contentError,\n    isLoading,\n    request: fetchInstances,\n  } = useRequest(\n    useCallback(async () => {\n      const params = parseQueryString(QS_CONFIG, location.search);\n      const [response, responseActions] = await Promise.all([\n        InstanceGroupsAPI.readInstances(instanceGroupId, params),\n        InstanceGroupsAPI.readInstanceOptions(instanceGroupId),\n      ]);\n      return {\n        instances: response.data.results,\n        count: response.data.count,\n        actions: responseActions.data.actions,\n        relatedSearchableKeys: (\n          responseActions?.data?.related_search_fields || []\n        ).map((val) => val.slice(0, -8)),\n        searchableKeys: getSearchableKeys(responseActions.data.actions?.GET),\n      };\n    }, [location.search, instanceGroupId]),\n    {\n      instances: [],\n      count: 0,\n      actions: {},\n      relatedSearchableKeys: [],\n      searchableKeys: [],\n    }\n  );\n\n  const { selected, isAllSelected, handleSelect, clearSelected, selectAll } =\n    useSelected(instances);\n\n  useEffect(() => {\n    fetchInstances();\n  }, [fetchInstances]);\n\n  const {\n    error: healthCheckError,\n    request: fetchHealthCheck,\n    isLoading: isHealthCheckLoading,\n  } = useRequest(\n    useCallback(async () => {\n      await Promise.all(selected.map(({ id }) => InstancesAPI.healthCheck(id)));\n      fetchInstances();\n    }, [selected, fetchInstances])\n  );\n\n  const handleHealthCheck = async () => {\n    await fetchHealthCheck();\n    clearSelected();\n  };\n\n  const {\n    isLoading: isDisassociateLoading,\n    deleteItems: disassociateInstances,\n    deletionError: disassociateError,\n  } = useDeleteItems(\n    useCallback(\n      () =>\n        Promise.all(\n          selected\n            .filter((s) => s.node_type !== 'control')\n            .map((instance) =>\n              InstanceGroupsAPI.disassociateInstance(\n                instanceGroupId,\n                instance.id\n              )\n            )\n        ),\n      [instanceGroupId, selected]\n    ),\n    {\n      qsConfig: QS_CONFIG,\n      allItemsSelected: isAllSelected,\n      fetchItems: fetchInstances,\n    }\n  );\n\n  const { request: handleAssociate, error: associateError } = useRequest(\n    useCallback(\n      async (instancesToAssociate) => {\n        await Promise.all(\n          instancesToAssociate\n            .filter((i) => i.node_type !== 'control' || i.node_type !== 'hop')\n            .map((instance) =>\n              InstanceGroupsAPI.associateInstance(instanceGroupId, instance.id)\n            )\n        );\n        fetchInstances();\n      },\n      [instanceGroupId, fetchInstances]\n    )\n  );\n\n  const handleDisassociate = async () => {\n    await disassociateInstances();\n    clearSelected();\n  };\n\n  const { error, dismissError } = useDismissableError(\n    associateError || disassociateError || healthCheckError\n  );\n\n  const canAdd =\n    actions && Object.prototype.hasOwnProperty.call(actions, 'POST');\n\n  const fetchInstancesToAssociate = useCallback(\n    (params) =>\n      InstancesAPI.read(\n        mergeParams(params, {\n          ...{ not__rampart_groups__id: instanceGroupId },\n          ...{ not__node_type: ['hop', 'control'] },\n        })\n      ),\n    [instanceGroupId]\n  );\n\n  const readInstancesOptions = useCallback(\n    () => InstanceGroupsAPI.readInstanceOptions(instanceGroupId),\n    [instanceGroupId]\n  );\n\n  const { expanded, isAllExpanded, handleExpand, expandAll } =\n    useExpanded(instances);\n\n  return (\n    <>\n      <PaginatedTable\n        contentError={contentError}\n        hasContentLoading={\n          isLoading || isDisassociateLoading || isHealthCheckLoading\n        }\n        items={instances}\n        itemCount={count}\n        pluralizedItemName={t`Instances`}\n        qsConfig={QS_CONFIG}\n        clearSelected={clearSelected}\n        toolbarSearchableKeys={searchableKeys}\n        toolbarRelatedSearchableKeys={relatedSearchableKeys}\n        toolbarSearchColumns={[\n          {\n            name: t`Name`,\n            key: 'hostname__icontains',\n            isDefault: true,\n          },\n          {\n            name: t`Node Type`,\n            key: `or__node_type`,\n            options: [\n              [`control`, t`Control`],\n              [`execution`, t`Execution`],\n              [`hybrid`, t`Hybrid`],\n            ],\n          },\n        ]}\n        toolbarSortColumns={[\n          {\n            name: t`Name`,\n            key: 'hostname',\n          },\n        ]}\n        renderToolbar={(props) => (\n          <DataListToolbar\n            {...props}\n            isAllSelected={isAllSelected}\n            onSelectAll={selectAll}\n            isAllExpanded={isAllExpanded}\n            onExpandAll={expandAll}\n            qsConfig={QS_CONFIG}\n            additionalControls={[\n              ...(canAdd\n                ? [\n                    <ToolbarAddButton\n                      key=\"associate\"\n                      onClick={() => setIsModalOpen(true)}\n                      defaultLabel={t`Associate`}\n                    />,\n                  ]\n                : []),\n              <DisassociateButton\n                verifyCannotDisassociate={\n                  selected.some((s) => s.node_type === 'control') ||\n                  instanceGroup.name === 'controlplane'\n                }\n                key=\"disassociate\"\n                onDisassociate={handleDisassociate}\n                itemsToDisassociate={selected}\n                modalTitle={t`Disassociate instance from instance group?`}\n                isProtectedInstanceGroup={instanceGroup.name === 'controlplane'}\n              />,\n              <HealthCheckButton\n                isDisabled={!canAdd}\n                onClick={handleHealthCheck}\n                selectedItems={selected}\n              />,\n            ]}\n            emptyStateControls={\n              canAdd ? (\n                <ToolbarAddButton\n                  key=\"add\"\n                  onClick={() => setIsModalOpen(true)}\n                />\n              ) : null\n            }\n          />\n        )}\n        headerRow={\n          <HeaderRow qsConfig={QS_CONFIG} isExpandable>\n            <HeaderCell sortKey=\"hostname\">{t`Name`}</HeaderCell>\n            <HeaderCell sortKey=\"errors\">{t`Status`}</HeaderCell>\n            <HeaderCell sortKey=\"node_type\">{t`Node Type`}</HeaderCell>\n            <HeaderCell>{t`Capacity Adjustment`}</HeaderCell>\n            <HeaderCell>{t`Used Capacity`}</HeaderCell>\n            <HeaderCell>{t`Actions`}</HeaderCell>\n          </HeaderRow>\n        }\n        renderRow={(instance, index) => (\n          <InstanceListItem\n            isExpanded={expanded.some((row) => row.id === instance.id)}\n            onExpand={() => handleExpand(instance)}\n            key={instance.id}\n            value={instance.hostname}\n            instance={instance}\n            onSelect={() => handleSelect(instance)}\n            isSelected={selected.some((row) => row.id === instance.id)}\n            fetchInstances={fetchInstances}\n            rowIndex={index}\n          />\n        )}\n      />\n      {isModalOpen && (\n        <AssociateModal\n          header={t`Instances`}\n          fetchRequest={fetchInstancesToAssociate}\n          isModalOpen={isModalOpen}\n          onAssociate={handleAssociate}\n          onClose={() => setIsModalOpen(false)}\n          title={t`Select Instances`}\n          optionsRequest={readInstancesOptions}\n          displayKey=\"hostname\"\n          columns={[\n            { key: 'hostname', name: t`Name` },\n            { key: 'node_type', name: t`Node Type` },\n          ]}\n        />\n      )}\n      {error && (\n        <AlertModal\n          isOpen={error}\n          onClose={dismissError}\n          title={t`Error!`}\n          variant=\"error\"\n        >\n          {associateError && t`Failed to associate.`}\n          {disassociateError &&\n            t`Failed to disassociate one or more instances.`}\n          {healthCheckError &&\n            t`Failed to run a health check on one or more instances.`}\n          <ErrorDetail error={error} />\n        </AlertModal>\n      )}\n    </>\n  );\n}\n\nexport default InstanceList;\n"]},"metadata":{},"sourceType":"module"}