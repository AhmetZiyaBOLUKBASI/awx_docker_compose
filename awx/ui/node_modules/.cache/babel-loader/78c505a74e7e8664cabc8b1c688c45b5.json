{"ast":null,"code":"import _toConsumableArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _objectWithoutProperties from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js\";import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";var _excluded=[\"labels\",\"inventory\",\"organization\",\"webhook_credential\",\"webhook_key\",\"limit\"];import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import React,{useState,useEffect,useCallback}from'react';import{useHistory}from'react-router-dom';import{CardBody}from'components/Card';import{getAddedAndRemoved}from'util/lists';import{WorkflowJobTemplatesAPI,OrganizationsAPI,UsersAPI}from'api';import{useConfig}from'contexts/Config';import useRequest from'hooks/useRequest';import ContentError from'components/ContentError';import ContentLoading from'components/ContentLoading';import{WorkflowJobTemplateForm}from'../shared';import{jsx as _jsx}from\"react/jsx-runtime\";function WorkflowJobTemplateEdit(_ref){var template=_ref.template;var _useConfig=useConfig(),_useConfig$me=_useConfig.me,me=_useConfig$me===void 0?{}:_useConfig$me;var history=useHistory();var _useState=useState(null),_useState2=_slicedToArray(_useState,2),formSubmitError=_useState2[0],setFormSubmitError=_useState2[1];var handleSubmit=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(values){var _inventory$summary_fi;var labels,inventory,organization,webhook_credential,webhook_key,limit,templatePayload,formOrgId;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:labels=values.labels,inventory=values.inventory,organization=values.organization,webhook_credential=values.webhook_credential,webhook_key=values.webhook_key,limit=values.limit,templatePayload=_objectWithoutProperties(values,_excluded);templatePayload.inventory=(inventory===null||inventory===void 0?void 0:inventory.id)||null;templatePayload.organization=(organization===null||organization===void 0?void 0:organization.id)||null;templatePayload.webhook_credential=(webhook_credential===null||webhook_credential===void 0?void 0:webhook_credential.id)||null;templatePayload.limit=limit===''?null:limit;formOrgId=(organization===null||organization===void 0?void 0:organization.id)||(inventory===null||inventory===void 0?void 0:(_inventory$summary_fi=inventory.summary_fields)===null||_inventory$summary_fi===void 0?void 0:_inventory$summary_fi.organization.id)||null;_context.prev=6;_context.t0=Promise;_context.next=10;return submitLabels(formOrgId,template.organization,labels);case 10:_context.t1=_context.sent;_context.next=13;return _context.t0.all.call(_context.t0,_context.t1);case 13:_context.next=15;return WorkflowJobTemplatesAPI.update(template.id,templatePayload);case 15:history.push(\"/templates/workflow_job_template/\".concat(template.id,\"/details\"));_context.next=21;break;case 18:_context.prev=18;_context.t2=_context[\"catch\"](6);setFormSubmitError(_context.t2);case 21:case\"end\":return _context.stop();}}},_callee,null,[[6,18]]);}));return function handleSubmit(_x){return _ref2.apply(this,arguments);};}();var submitLabels=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(formOrgId,templateOrgId){var labels,_getAddedAndRemoved,added,removed,orgId,_yield$OrganizationsA,_results,disassociationPromises,associationPromises,results,_args2=arguments;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:labels=_args2.length>2&&_args2[2]!==undefined?_args2[2]:[];_getAddedAndRemoved=getAddedAndRemoved(template.summary_fields.labels.results,labels),added=_getAddedAndRemoved.added,removed=_getAddedAndRemoved.removed;orgId=formOrgId||templateOrgId;if(orgId){_context2.next=15;break;}_context2.prev=4;_context2.next=7;return OrganizationsAPI.read();case 7:_yield$OrganizationsA=_context2.sent;_results=_yield$OrganizationsA.data.results;orgId=_results[0].id;_context2.next=15;break;case 12:_context2.prev=12;_context2.t0=_context2[\"catch\"](4);throw _context2.t0;case 15:_context2.next=17;return removed.map(function(label){return WorkflowJobTemplatesAPI.disassociateLabel(template.id,label);});case 17:disassociationPromises=_context2.sent;_context2.next=20;return added.map(function(label){return WorkflowJobTemplatesAPI.associateLabel(template.id,label,orgId);});case 20:associationPromises=_context2.sent;results=[].concat(_toConsumableArray(disassociationPromises),_toConsumableArray(associationPromises));return _context2.abrupt(\"return\",results);case 23:case\"end\":return _context2.stop();}}},_callee2,null,[[4,12]]);}));return function submitLabels(_x2,_x3){return _ref3.apply(this,arguments);};}();var handleCancel=function handleCancel(){history.push(\"/templates/workflow_job_template/\".concat(template.id,\"/details\"));};var _useRequest=useRequest(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var _yield$UsersAPI$readA,_yield$UsersAPI$readA2,results,count;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return UsersAPI.readAdminOfOrganizations(me===null||me===void 0?void 0:me.id);case 2:_yield$UsersAPI$readA=_context3.sent;_yield$UsersAPI$readA2=_yield$UsersAPI$readA.data;results=_yield$UsersAPI$readA2.results;count=_yield$UsersAPI$readA2.count;return _context3.abrupt(\"return\",{isOrgAdmin:count>0,orgAdminResults:results});case 7:case\"end\":return _context3.stop();}}},_callee3);})),[me.id]),{isOrgAdmin:false,orgAdminResults:null}),isLoading=_useRequest.isLoading,fetchUserRole=_useRequest.request,_useRequest$result=_useRequest.result,orgAdminResults=_useRequest$result.orgAdminResults,isOrgAdmin=_useRequest$result.isOrgAdmin,contentError=_useRequest.error;useEffect(function(){fetchUserRole();},[fetchUserRole]);if(contentError){return/*#__PURE__*/_jsx(ContentError,{error:contentError});}if(isLoading||!orgAdminResults){return/*#__PURE__*/_jsx(ContentLoading,{});}return/*#__PURE__*/_jsx(CardBody,{children:/*#__PURE__*/_jsx(WorkflowJobTemplateForm,{handleSubmit:handleSubmit,handleCancel:handleCancel,template:template,submitError:formSubmitError,isOrgAdmin:isOrgAdmin})});}export default WorkflowJobTemplateEdit;","map":{"version":3,"sources":["/awx_devel/awx/ui/src/screens/Template/WorkflowJobTemplateEdit/WorkflowJobTemplateEdit.js"],"names":["React","useState","useEffect","useCallback","useHistory","CardBody","getAddedAndRemoved","WorkflowJobTemplatesAPI","OrganizationsAPI","UsersAPI","useConfig","useRequest","ContentError","ContentLoading","WorkflowJobTemplateForm","WorkflowJobTemplateEdit","template","me","history","formSubmitError","setFormSubmitError","handleSubmit","values","labels","inventory","organization","webhook_credential","webhook_key","limit","templatePayload","id","formOrgId","summary_fields","Promise","submitLabels","all","update","push","templateOrgId","results","added","removed","orgId","read","data","map","label","disassociateLabel","disassociationPromises","associateLabel","associationPromises","handleCancel","readAdminOfOrganizations","count","isOrgAdmin","orgAdminResults","isLoading","fetchUserRole","request","result","contentError","error"],"mappings":"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","sourcesContent":["import React, { useState, useEffect, useCallback } from 'react';\nimport { useHistory } from 'react-router-dom';\n\nimport { CardBody } from 'components/Card';\nimport { getAddedAndRemoved } from 'util/lists';\nimport { WorkflowJobTemplatesAPI, OrganizationsAPI, UsersAPI } from 'api';\nimport { useConfig } from 'contexts/Config';\nimport useRequest from 'hooks/useRequest';\nimport ContentError from 'components/ContentError';\nimport ContentLoading from 'components/ContentLoading';\nimport { WorkflowJobTemplateForm } from '../shared';\n\nfunction WorkflowJobTemplateEdit({ template }) {\n  const { me = {} } = useConfig();\n  const history = useHistory();\n  const [formSubmitError, setFormSubmitError] = useState(null);\n\n  const handleSubmit = async (values) => {\n    const {\n      labels,\n      inventory,\n      organization,\n      webhook_credential,\n      webhook_key,\n      limit,\n      ...templatePayload\n    } = values;\n    templatePayload.inventory = inventory?.id || null;\n    templatePayload.organization = organization?.id || null;\n    templatePayload.webhook_credential = webhook_credential?.id || null;\n    templatePayload.limit = limit === '' ? null : limit;\n\n    const formOrgId =\n      organization?.id || inventory?.summary_fields?.organization.id || null;\n    try {\n      await Promise.all(\n        await submitLabels(formOrgId, template.organization, labels)\n      );\n      await WorkflowJobTemplatesAPI.update(template.id, templatePayload);\n      history.push(`/templates/workflow_job_template/${template.id}/details`);\n    } catch (err) {\n      setFormSubmitError(err);\n    }\n  };\n\n  const submitLabels = async (formOrgId, templateOrgId, labels = []) => {\n    const { added, removed } = getAddedAndRemoved(\n      template.summary_fields.labels.results,\n      labels\n    );\n    let orgId = formOrgId || templateOrgId;\n    if (!orgId) {\n      // eslint-disable-next-line no-useless-catch\n      try {\n        const {\n          data: { results },\n        } = await OrganizationsAPI.read();\n        orgId = results[0].id;\n      } catch (err) {\n        throw err;\n      }\n    }\n\n    const disassociationPromises = await removed.map((label) =>\n      WorkflowJobTemplatesAPI.disassociateLabel(template.id, label)\n    );\n    const associationPromises = await added.map((label) =>\n      WorkflowJobTemplatesAPI.associateLabel(template.id, label, orgId)\n    );\n    const results = [...disassociationPromises, ...associationPromises];\n    return results;\n  };\n\n  const handleCancel = () => {\n    history.push(`/templates/workflow_job_template/${template.id}/details`);\n  };\n\n  const {\n    isLoading,\n    request: fetchUserRole,\n    result: { orgAdminResults, isOrgAdmin },\n    error: contentError,\n  } = useRequest(\n    useCallback(async () => {\n      const {\n        data: { results, count },\n      } = await UsersAPI.readAdminOfOrganizations(me?.id);\n      return { isOrgAdmin: count > 0, orgAdminResults: results };\n    }, [me.id]),\n    { isOrgAdmin: false, orgAdminResults: null }\n  );\n\n  useEffect(() => {\n    fetchUserRole();\n  }, [fetchUserRole]);\n\n  if (contentError) {\n    return <ContentError error={contentError} />;\n  }\n\n  if (isLoading || !orgAdminResults) {\n    return <ContentLoading />;\n  }\n\n  return (\n    <CardBody>\n      <WorkflowJobTemplateForm\n        handleSubmit={handleSubmit}\n        handleCancel={handleCancel}\n        template={template}\n        submitError={formSubmitError}\n        isOrgAdmin={isOrgAdmin}\n      />\n    </CardBody>\n  );\n}\nexport default WorkflowJobTemplateEdit;\n"]},"metadata":{},"sourceType":"module"}