{"ast":null,"code":"import _objectSpread from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _styled from\"styled-components\";import{i18n}from\"@lingui/core\";import React,{useContext,useEffect,useRef,useState}from'react';import styled from'styled-components';import*as d3 from'd3';import{WorkflowDispatchContext,WorkflowStateContext}from'contexts/Workflow';import{getScaleAndOffsetToFit,constants as wfConstants,getTranslatePointsForZoom}from'components/Workflow/WorkflowUtils';import{WorkflowHelp,WorkflowLegend,WorkflowLinkHelp,WorkflowNodeHelp,WorkflowStartNode,WorkflowTools}from'components/Workflow';import VisualizerLink from'./VisualizerLink';import VisualizerNode from'./VisualizerNode';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";var PotentialLink=styled.polyline.withConfig({displayName:\"VisualizerGraph__PotentialLink\",componentId:\"qgkcht-0\"})([\"pointer-events:none;\"]);var WorkflowSVG=styled.svg.withConfig({displayName:\"VisualizerGraph__WorkflowSVG\",componentId:\"qgkcht-1\"})([\"background-color:#f6f6f6;display:flex;height:100%;\"]);var _StyledDiv=styled(\"div\").withConfig({displayName:\"VisualizerGraph___StyledDiv\",componentId:\"qgkcht-2\"})([\"position:absolute;top:75px;right:20px;display:flex;\"]);function VisualizerGraph(_ref){var readOnly=_ref.readOnly;var _useState=useState(null),_useState2=_slicedToArray(_useState,2),helpText=_useState2[0],setHelpText=_useState2[1];var _useState3=useState(),_useState4=_slicedToArray(_useState3,2),linkHelp=_useState4[0],setLinkHelp=_useState4[1];var _useState5=useState(),_useState6=_slicedToArray(_useState5,2),nodeHelp=_useState6[0],setNodeHelp=_useState6[1];var _useState7=useState(100),_useState8=_slicedToArray(_useState7,2),zoomPercentage=_useState8[0],setZoomPercentage=_useState8[1];var svgRef=useRef(null);var gRef=useRef(null);var _useContext=useContext(WorkflowStateContext),addLinkSourceNode=_useContext.addLinkSourceNode,addingLink=_useContext.addingLink,links=_useContext.links,nodePositions=_useContext.nodePositions,nodes=_useContext.nodes,showLegend=_useContext.showLegend,showTools=_useContext.showTools;var dispatch=useContext(WorkflowDispatchContext);var drawPotentialLinkToNode=function drawPotentialLinkToNode(node){if(node.id!==addLinkSourceNode.id){var sourceNodeX=nodePositions[addLinkSourceNode.id].x;var sourceNodeY=nodePositions[addLinkSourceNode.id].y-nodePositions[1].y;var targetNodeX=nodePositions[node.id].x;var targetNodeY=nodePositions[node.id].y-nodePositions[1].y;var startX=sourceNodeX+wfConstants.nodeW;var startY=sourceNodeY+wfConstants.nodeH/2;var finishX=targetNodeX;var finishY=targetNodeY+wfConstants.nodeH/2;d3.select('#workflow-potentialLink').attr('points',\"\".concat(startX,\",\").concat(startY,\" \").concat(finishX,\",\").concat(finishY)).raise();}};var handleBackgroundClick=function handleBackgroundClick(){setHelpText(null);dispatch({type:'CANCEL_LINK'});};var drawPotentialLinkToCursor=function drawPotentialLinkToCursor(e){var currentTransform=d3.zoomTransform(d3.select(gRef.current).node());var rect=e.target.getBoundingClientRect();var mouseX=e.clientX-rect.left;var mouseY=e.clientY-rect.top;var sourceNodeX=nodePositions[addLinkSourceNode.id].x;var sourceNodeY=nodePositions[addLinkSourceNode.id].y-nodePositions[1].y;var startX=sourceNodeX+wfConstants.nodeW;var startY=sourceNodeY+wfConstants.nodeH/2;d3.select('#workflow-potentialLink').attr('points',\"\".concat(startX,\",\").concat(startY,\" \").concat(mouseX/currentTransform.k-currentTransform.x/currentTransform.k,\",\").concat(mouseY/currentTransform.k-currentTransform.y/currentTransform.k)).raise();};// This is the zoom function called by using the mousewheel/click and drag\nvar zoom=function zoom(event){var translation=[event.transform.x,event.transform.y];d3.select(gRef.current).attr('transform',\"translate(\".concat(translation,\") scale(\").concat(event.transform.k,\")\"));setZoomPercentage(event.transform.k*100);};var handlePan=function handlePan(direction){var transform=d3.zoomTransform(d3.select(svgRef.current).node());var xPos=transform.x,yPos=transform.y;var currentScale=transform.k;switch(direction){case'up':yPos-=50;break;case'down':yPos+=50;break;case'left':xPos-=50;break;case'right':xPos+=50;break;default:// Throw an error?\nbreak;}d3.select(svgRef.current).call(zoomRef.transform,d3.zoomIdentity.translate(xPos,yPos).scale(currentScale));};var handlePanToMiddle=function handlePanToMiddle(){var svgBoundingClientRect=svgRef.current.getBoundingClientRect();d3.select(svgRef.current).call(zoomRef.transform,d3.zoomIdentity.translate(0,svgBoundingClientRect.height/2-30).scale(1));setZoomPercentage(100);};var handleZoomChange=function handleZoomChange(newScale){var svgBoundingClientRect=svgRef.current.getBoundingClientRect();var currentScaleAndOffset=d3.zoomTransform(d3.select(svgRef.current).node());var _getTranslatePointsFo=getTranslatePointsForZoom(svgBoundingClientRect,currentScaleAndOffset,newScale),_getTranslatePointsFo2=_slicedToArray(_getTranslatePointsFo,2),translateX=_getTranslatePointsFo2[0],translateY=_getTranslatePointsFo2[1];d3.select(svgRef.current).call(zoomRef.transform,d3.zoomIdentity.translate(translateX,translateY).scale(newScale));setZoomPercentage(newScale*100);};var handleFitGraph=function handleFitGraph(){var _d3$zoomTransform=d3.zoomTransform(d3.select(svgRef.current).node()),currentScale=_d3$zoomTransform.k;var gBoundingClientRect=d3.select(gRef.current).node().getBoundingClientRect();var gBBoxDimensions=d3.select(gRef.current).node().getBBox();var svgBoundingClientRect=svgRef.current.getBoundingClientRect();var _getScaleAndOffsetToF=getScaleAndOffsetToFit(gBoundingClientRect,svgBoundingClientRect,gBBoxDimensions,currentScale),_getScaleAndOffsetToF2=_slicedToArray(_getScaleAndOffsetToF,2),scaleToFit=_getScaleAndOffsetToF2[0],yTranslate=_getScaleAndOffsetToF2[1];d3.select(svgRef.current).call(zoomRef.transform,d3.zoomIdentity.translate(0,yTranslate).scale(scaleToFit));setZoomPercentage(scaleToFit*100);};var zoomRef=d3.zoom().scaleExtent([0.1,2]).on('zoom',zoom);// This useEffect prevents the Visualizer toolbar from going off the screen\n// as the user zooms in too much.  It effectively makes the toolbarr a sticky header\n// The user can still zoom in/out but there are limited to the degree they can do so\n// by the zoomExtent above.\nuseEffect(function(){var cancelWheel=function cancelWheel(event){return event.preventDefault();};document.body.addEventListener('wheel',cancelWheel,{passive:false});return function(){document.body.removeEventListener('wheel',cancelWheel);};},[]);// Initialize the zoom\nuseEffect(function(){d3.select(svgRef.current).call(zoomRef);},[zoomRef]);// Attempt to zoom the graph to fit the available screen space\nuseEffect(function(){handleFitGraph();// We only want this to run once (when the component mounts)\n// Including handleFitGraph in the deps array will cause this to\n// run very frequently.\n// Discussion: https://github.com/facebook/create-react-app/issues/6880\n// and https://github.com/facebook/react/issues/15865 amongst others\n// eslint-disable-next-line react-hooks/exhaustive-deps\n},[]);return/*#__PURE__*/_jsxs(_Fragment,{children:[(helpText||nodeHelp||linkHelp)&&/*#__PURE__*/_jsxs(WorkflowHelp,{children:[helpText&&/*#__PURE__*/_jsx(\"p\",{children:helpText}),nodeHelp&&/*#__PURE__*/_jsx(WorkflowNodeHelp,{node:nodeHelp}),linkHelp&&/*#__PURE__*/_jsx(WorkflowLinkHelp,{link:linkHelp})]}),/*#__PURE__*/_jsxs(WorkflowSVG,{id:\"workflow-svg\",ref:svgRef,children:[/*#__PURE__*/_jsx(\"defs\",{children:/*#__PURE__*/_jsx(\"marker\",{className:\"WorkflowChart-noPointerEvents\",id:\"workflow-triangle\",markerHeight:\"6\",markerUnits:\"strokeWidth\",markerWidth:\"6\",orient:\"auto\",refX:\"10\",viewBox:\"0 -5 10 10\",children:/*#__PURE__*/_jsx(\"path\",{d:\"M0,-5L10,0L0,5\",fill:\"#93969A\"})})}),/*#__PURE__*/_jsx(\"rect\",_objectSpread({height:\"100%\",id:\"workflow-background\",opacity:\"0\",width:\"100%\"},addingLink&&{onMouseMove:function onMouseMove(e){return drawPotentialLinkToCursor(e);},onMouseOver:function onMouseOver(){return setHelpText(/*i18n*/i18n._(\"Click an available node to create a new link.  Click outside the graph to cancel.\"));},onMouseOut:function onMouseOut(){return setHelpText(null);},onClick:function onClick(){return handleBackgroundClick();}})),/*#__PURE__*/_jsxs(\"g\",{id:\"workflow-g\",ref:gRef,children:[nodePositions&&[links.map(function(link){if(nodePositions[link.source.id]&&nodePositions[link.target.id]){return/*#__PURE__*/_jsx(VisualizerLink,{link:link,readOnly:readOnly,updateLinkHelp:function updateLinkHelp(newLinkHelp){return setLinkHelp(newLinkHelp);},updateHelpText:function updateHelpText(newHelpText){return setHelpText(newHelpText);}},\"link-\".concat(link.source.id,\"-\").concat(link.target.id));}return null;}),nodes.map(function(node){if(node.id>1&&nodePositions[node.id]&&!node.isDeleted){return/*#__PURE__*/_jsx(VisualizerNode,_objectSpread({node:node,readOnly:readOnly,updateHelpText:function updateHelpText(newHelpText){return setHelpText(newHelpText);},updateNodeHelp:function updateNodeHelp(newNodeHelp){return setNodeHelp(newNodeHelp);}},addingLink&&{onMouseOver:function onMouseOver(){return drawPotentialLinkToNode(node);}}),\"node-\".concat(node.id));}return null;}),/*#__PURE__*/_jsx(WorkflowStartNode,{showActionTooltip:!readOnly,onUpdateHelpText:setHelpText,readOnly:readOnly},\"start\")],addingLink&&/*#__PURE__*/_jsx(PotentialLink,{id:\"workflow-potentialLink\",markerEnd:\"url(#workflow-triangle)\",stroke:\"#93969A\",strokeDasharray:\"5,5\",strokeWidth:\"2\"})]})]}),/*#__PURE__*/_jsxs(_StyledDiv,{children:[showTools&&/*#__PURE__*/_jsx(WorkflowTools,{onFitGraph:handleFitGraph,onPan:handlePan,onPanToMiddle:handlePanToMiddle,onZoomChange:handleZoomChange,zoomPercentage:zoomPercentage}),showLegend&&/*#__PURE__*/_jsx(WorkflowLegend,{})]})]});}export default VisualizerGraph;","map":{"version":3,"sources":["/awx_devel/awx/ui/src/screens/Template/WorkflowJobTemplateVisualizer/VisualizerGraph.js"],"names":["React","useContext","useEffect","useRef","useState","styled","d3","WorkflowDispatchContext","WorkflowStateContext","getScaleAndOffsetToFit","constants","wfConstants","getTranslatePointsForZoom","WorkflowHelp","WorkflowLegend","WorkflowLinkHelp","WorkflowNodeHelp","WorkflowStartNode","WorkflowTools","VisualizerLink","VisualizerNode","PotentialLink","polyline","WorkflowSVG","svg","VisualizerGraph","readOnly","helpText","setHelpText","linkHelp","setLinkHelp","nodeHelp","setNodeHelp","zoomPercentage","setZoomPercentage","svgRef","gRef","addLinkSourceNode","addingLink","links","nodePositions","nodes","showLegend","showTools","dispatch","drawPotentialLinkToNode","node","id","sourceNodeX","x","sourceNodeY","y","targetNodeX","targetNodeY","startX","nodeW","startY","nodeH","finishX","finishY","select","attr","raise","handleBackgroundClick","type","drawPotentialLinkToCursor","e","currentTransform","zoomTransform","current","rect","target","getBoundingClientRect","mouseX","clientX","left","mouseY","clientY","top","k","zoom","event","translation","transform","handlePan","direction","xPos","yPos","currentScale","call","zoomRef","zoomIdentity","translate","scale","handlePanToMiddle","svgBoundingClientRect","height","handleZoomChange","newScale","currentScaleAndOffset","translateX","translateY","handleFitGraph","gBoundingClientRect","gBBoxDimensions","getBBox","scaleToFit","yTranslate","scaleExtent","on","cancelWheel","preventDefault","document","body","addEventListener","passive","removeEventListener","onMouseMove","onMouseOver","onMouseOut","onClick","map","link","source","newLinkHelp","newHelpText","isDeleted","newNodeHelp"],"mappings":"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","sourcesContent":["import 'styled-components/macro';\nimport React, { useContext, useEffect, useRef, useState } from 'react';\nimport { t } from '@lingui/macro';\nimport styled from 'styled-components';\nimport { bool } from 'prop-types';\nimport * as d3 from 'd3';\nimport {\n  WorkflowDispatchContext,\n  WorkflowStateContext,\n} from 'contexts/Workflow';\nimport {\n  getScaleAndOffsetToFit,\n  constants as wfConstants,\n  getTranslatePointsForZoom,\n} from 'components/Workflow/WorkflowUtils';\nimport {\n  WorkflowHelp,\n  WorkflowLegend,\n  WorkflowLinkHelp,\n  WorkflowNodeHelp,\n  WorkflowStartNode,\n  WorkflowTools,\n} from 'components/Workflow';\nimport VisualizerLink from './VisualizerLink';\nimport VisualizerNode from './VisualizerNode';\n\nconst PotentialLink = styled.polyline`\n  pointer-events: none;\n`;\nconst WorkflowSVG = styled.svg`\n  background-color: #f6f6f6;\n  display: flex;\n  height: 100%;\n`;\nfunction VisualizerGraph({ readOnly }) {\n  const [helpText, setHelpText] = useState(null);\n  const [linkHelp, setLinkHelp] = useState();\n  const [nodeHelp, setNodeHelp] = useState();\n  const [zoomPercentage, setZoomPercentage] = useState(100);\n  const svgRef = useRef(null);\n  const gRef = useRef(null);\n  const {\n    addLinkSourceNode,\n    addingLink,\n    links,\n    nodePositions,\n    nodes,\n    showLegend,\n    showTools,\n  } = useContext(WorkflowStateContext);\n  const dispatch = useContext(WorkflowDispatchContext);\n\n  const drawPotentialLinkToNode = (node) => {\n    if (node.id !== addLinkSourceNode.id) {\n      const sourceNodeX = nodePositions[addLinkSourceNode.id].x;\n      const sourceNodeY =\n        nodePositions[addLinkSourceNode.id].y - nodePositions[1].y;\n      const targetNodeX = nodePositions[node.id].x;\n      const targetNodeY = nodePositions[node.id].y - nodePositions[1].y;\n      const startX = sourceNodeX + wfConstants.nodeW;\n      const startY = sourceNodeY + wfConstants.nodeH / 2;\n      const finishX = targetNodeX;\n      const finishY = targetNodeY + wfConstants.nodeH / 2;\n      d3.select('#workflow-potentialLink')\n        .attr('points', `${startX},${startY} ${finishX},${finishY}`)\n        .raise();\n    }\n  };\n  const handleBackgroundClick = () => {\n    setHelpText(null);\n    dispatch({ type: 'CANCEL_LINK' });\n  };\n\n  const drawPotentialLinkToCursor = (e) => {\n    const currentTransform = d3.zoomTransform(d3.select(gRef.current).node());\n    const rect = e.target.getBoundingClientRect();\n    const mouseX = e.clientX - rect.left;\n    const mouseY = e.clientY - rect.top;\n    const sourceNodeX = nodePositions[addLinkSourceNode.id].x;\n    const sourceNodeY =\n      nodePositions[addLinkSourceNode.id].y - nodePositions[1].y;\n    const startX = sourceNodeX + wfConstants.nodeW;\n    const startY = sourceNodeY + wfConstants.nodeH / 2;\n    d3.select('#workflow-potentialLink')\n      .attr(\n        'points',\n        `${startX},${startY} ${\n          mouseX / currentTransform.k - currentTransform.x / currentTransform.k\n        },${\n          mouseY / currentTransform.k - currentTransform.y / currentTransform.k\n        }`\n      )\n      .raise();\n  };\n  // This is the zoom function called by using the mousewheel/click and drag\n  const zoom = (event) => {\n    const translation = [event.transform.x, event.transform.y];\n    d3.select(gRef.current).attr(\n      'transform',\n      `translate(${translation}) scale(${event.transform.k})`\n    );\n    setZoomPercentage(event.transform.k * 100);\n  };\n\n  const handlePan = (direction) => {\n    const transform = d3.zoomTransform(d3.select(svgRef.current).node());\n    let { x: xPos, y: yPos } = transform;\n    const { k: currentScale } = transform;\n    switch (direction) {\n      case 'up':\n        yPos -= 50;\n        break;\n      case 'down':\n        yPos += 50;\n        break;\n      case 'left':\n        xPos -= 50;\n        break;\n      case 'right':\n        xPos += 50;\n        break;\n      default:\n        // Throw an error?\n        break;\n    }\n    d3.select(svgRef.current).call(\n      zoomRef.transform,\n      d3.zoomIdentity.translate(xPos, yPos).scale(currentScale)\n    );\n  };\n  const handlePanToMiddle = () => {\n    const svgBoundingClientRect = svgRef.current.getBoundingClientRect();\n    d3.select(svgRef.current).call(\n      zoomRef.transform,\n      d3.zoomIdentity\n        .translate(0, svgBoundingClientRect.height / 2 - 30)\n        .scale(1)\n    );\n    setZoomPercentage(100);\n  };\n\n  const handleZoomChange = (newScale) => {\n    const svgBoundingClientRect = svgRef.current.getBoundingClientRect();\n    const currentScaleAndOffset = d3.zoomTransform(\n      d3.select(svgRef.current).node()\n    );\n    const [translateX, translateY] = getTranslatePointsForZoom(\n      svgBoundingClientRect,\n      currentScaleAndOffset,\n      newScale\n    );\n    d3.select(svgRef.current).call(\n      zoomRef.transform,\n      d3.zoomIdentity.translate(translateX, translateY).scale(newScale)\n    );\n    setZoomPercentage(newScale * 100);\n  };\n  const handleFitGraph = () => {\n    const { k: currentScale } = d3.zoomTransform(\n      d3.select(svgRef.current).node()\n    );\n    const gBoundingClientRect = d3\n      .select(gRef.current)\n      .node()\n      .getBoundingClientRect();\n\n    const gBBoxDimensions = d3.select(gRef.current).node().getBBox();\n\n    const svgBoundingClientRect = svgRef.current.getBoundingClientRect();\n    const [scaleToFit, yTranslate] = getScaleAndOffsetToFit(\n      gBoundingClientRect,\n      svgBoundingClientRect,\n      gBBoxDimensions,\n      currentScale\n    );\n    d3.select(svgRef.current).call(\n      zoomRef.transform,\n      d3.zoomIdentity.translate(0, yTranslate).scale(scaleToFit)\n    );\n    setZoomPercentage(scaleToFit * 100);\n  };\n\n  const zoomRef = d3.zoom().scaleExtent([0.1, 2]).on('zoom', zoom);\n  // This useEffect prevents the Visualizer toolbar from going off the screen\n  // as the user zooms in too much.  It effectively makes the toolbarr a sticky header\n  // The user can still zoom in/out but there are limited to the degree they can do so\n  // by the zoomExtent above.\n\n  useEffect(() => {\n    const cancelWheel = (event) => event.preventDefault();\n    document.body.addEventListener('wheel', cancelWheel, { passive: false });\n\n    return () => {\n      document.body.removeEventListener('wheel', cancelWheel);\n    };\n  }, []);\n\n  // Initialize the zoom\n  useEffect(() => {\n    d3.select(svgRef.current).call(zoomRef);\n  }, [zoomRef]);\n  // Attempt to zoom the graph to fit the available screen space\n  useEffect(() => {\n    handleFitGraph();\n    // We only want this to run once (when the component mounts)\n    // Including handleFitGraph in the deps array will cause this to\n    // run very frequently.\n    // Discussion: https://github.com/facebook/create-react-app/issues/6880\n    // and https://github.com/facebook/react/issues/15865 amongst others\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n  return (\n    <>\n      {(helpText || nodeHelp || linkHelp) && (\n        <WorkflowHelp>\n          {helpText && <p>{helpText}</p>}\n          {nodeHelp && <WorkflowNodeHelp node={nodeHelp} />}\n          {linkHelp && <WorkflowLinkHelp link={linkHelp} />}\n        </WorkflowHelp>\n      )}\n      <WorkflowSVG id=\"workflow-svg\" ref={svgRef}>\n        <defs>\n          <marker\n            className=\"WorkflowChart-noPointerEvents\"\n            id=\"workflow-triangle\"\n            markerHeight=\"6\"\n            markerUnits=\"strokeWidth\"\n            markerWidth=\"6\"\n            orient=\"auto\"\n            refX=\"10\"\n            viewBox=\"0 -5 10 10\"\n          >\n            <path d=\"M0,-5L10,0L0,5\" fill=\"#93969A\" />\n          </marker>\n        </defs>\n        <rect\n          height=\"100%\"\n          id=\"workflow-background\"\n          opacity=\"0\"\n          width=\"100%\"\n          {...(addingLink && {\n            onMouseMove: (e) => drawPotentialLinkToCursor(e),\n            onMouseOver: () =>\n              setHelpText(\n                t`Click an available node to create a new link.  Click outside the graph to cancel.`\n              ),\n            onMouseOut: () => setHelpText(null),\n            onClick: () => handleBackgroundClick(),\n          })}\n        />\n        <g id=\"workflow-g\" ref={gRef}>\n          {nodePositions && [\n            links.map((link) => {\n              if (\n                nodePositions[link.source.id] &&\n                nodePositions[link.target.id]\n              ) {\n                return (\n                  <VisualizerLink\n                    key={`link-${link.source.id}-${link.target.id}`}\n                    link={link}\n                    readOnly={readOnly}\n                    updateLinkHelp={(newLinkHelp) => setLinkHelp(newLinkHelp)}\n                    updateHelpText={(newHelpText) => setHelpText(newHelpText)}\n                  />\n                );\n              }\n              return null;\n            }),\n            nodes.map((node) => {\n              if (node.id > 1 && nodePositions[node.id] && !node.isDeleted) {\n                return (\n                  <VisualizerNode\n                    key={`node-${node.id}`}\n                    node={node}\n                    readOnly={readOnly}\n                    updateHelpText={(newHelpText) => setHelpText(newHelpText)}\n                    updateNodeHelp={(newNodeHelp) => setNodeHelp(newNodeHelp)}\n                    {...(addingLink && {\n                      onMouseOver: () => drawPotentialLinkToNode(node),\n                    })}\n                  />\n                );\n              }\n              return null;\n            }),\n            <WorkflowStartNode\n              key=\"start\"\n              showActionTooltip={!readOnly}\n              onUpdateHelpText={setHelpText}\n              readOnly={readOnly}\n            />,\n          ]}\n          {addingLink && (\n            <PotentialLink\n              id=\"workflow-potentialLink\"\n              markerEnd=\"url(#workflow-triangle)\"\n              stroke=\"#93969A\"\n              strokeDasharray=\"5,5\"\n              strokeWidth=\"2\"\n            />\n          )}\n        </g>\n      </WorkflowSVG>\n      <div css=\"position: absolute; top: 75px;right: 20px;display: flex;\">\n        {showTools && (\n          <WorkflowTools\n            onFitGraph={handleFitGraph}\n            onPan={handlePan}\n            onPanToMiddle={handlePanToMiddle}\n            onZoomChange={handleZoomChange}\n            zoomPercentage={zoomPercentage}\n          />\n        )}\n        {showLegend && <WorkflowLegend />}\n      </div>\n    </>\n  );\n}\nVisualizerGraph.propTypes = {\n  readOnly: bool.isRequired,\n};\nexport default VisualizerGraph;\n"]},"metadata":{},"sourceType":"module"}